<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cockpit</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
<script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-webgl@0.18.0/lib/addon-webgl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-search@0.15.0/lib/addon-search.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg-0:#08090d;--bg-1:#0f1117;--bg-2:#161820;--bg-3:#1e2029;--bg-4:#262833;
  --bg-surface:rgba(255,255,255,0.03);--bg-surface-hover:rgba(255,255,255,0.06);
  --text-0:#ffffff;--text-1:#e8e9f0;--text-2:#9395a5;--text-3:#565868;
  --border:rgba(255,255,255,0.06);--border-hover:rgba(255,255,255,0.12);--border-active:rgba(129,140,248,0.4);
  --accent:#818cf8;--accent-bright:#a5b4fc;--accent-dim:#6366f1;
  --accent-glow:rgba(99,102,241,0.15);--accent-glow-strong:rgba(99,102,241,0.25);
  --green:#34d399;--green-dim:rgba(52,211,153,0.12);
  --yellow:#fbbf24;--yellow-dim:rgba(251,191,36,0.12);
  --red:#f87171;--red-dim:rgba(248,113,113,0.12);
  --blue:#60a5fa;--blue-dim:rgba(96,165,250,0.12);
  --shadow-sm:0 1px 2px rgba(0,0,0,.3),0 1px 3px rgba(0,0,0,.15);
  --shadow-md:0 4px 6px rgba(0,0,0,.3),0 2px 4px rgba(0,0,0,.2);
  --shadow-lg:0 10px 25px rgba(0,0,0,.4),0 6px 10px rgba(0,0,0,.25);
  --shadow-glow:0 0 20px rgba(99,102,241,.15);
  --radius:12px;--radius-sm:8px;--radius-xs:4px;--radius-full:9999px;
  --font:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
  --mono:'Cascadia Code','JetBrains Mono','Fira Code',monospace;
  --ease:cubic-bezier(0.16,1,0.3,1);--dur:150ms;--dur-md:250ms;
}
html{font-size:15px}
body{background:var(--bg-0);color:var(--text-1);font-family:var(--font);height:100vh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
*{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent}
::-webkit-scrollbar{width:7px;height:7px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.18)}

/* ─── Header ─── */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;height:48px;background:var(--bg-1);
  border-bottom:1px solid var(--border);flex-shrink:0;z-index:100;
}
.logo{display:flex;align-items:center;gap:10px;font-size:.95rem;font-weight:700;letter-spacing:-.02em;color:var(--text-0)}
.logo svg{width:22px;height:22px;color:var(--accent);filter:drop-shadow(0 0 6px rgba(99,102,241,.4))}
.nav-tabs{display:flex;gap:2px;background:var(--bg-0);padding:3px;border-radius:var(--radius-sm)}
.nav-tab{
  padding:6px 16px;border-radius:6px;font-size:.82rem;cursor:pointer;
  color:var(--text-3);border:none;background:transparent;
  transition:all var(--dur) var(--ease);font-weight:500;font-family:var(--font);
  display:flex;align-items:center;gap:6px;
}
.nav-tab:hover{color:var(--text-2)}
.nav-tab.active{color:var(--text-0);background:var(--bg-3);box-shadow:var(--shadow-sm)}
.nav-tab svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}
.header-right{display:flex;gap:10px;align-items:center}
.header-clock{font-family:var(--mono);font-size:.78rem;color:var(--text-3);min-width:56px}
.stat-badge{
  display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:var(--radius-sm);
  background:var(--bg-surface);font-size:.78rem;color:var(--text-3);border:1px solid var(--border);
}
.stat-badge .value{color:var(--text-1);font-weight:600;font-family:var(--mono)}
.header-btn{
  width:32px;height:32px;display:flex;align-items:center;justify-content:center;
  border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;
  color:var(--text-3);cursor:pointer;transition:all var(--dur);
}
.header-btn:hover{color:var(--text-1);background:var(--bg-surface-hover);border-color:var(--border-hover)}
.header-btn svg{width:16px;height:16px}
.conn-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 6px rgba(52,211,153,.5);transition:all .3s}
.conn-dot.off{background:var(--red);box-shadow:0 0 6px rgba(248,113,113,.5);animation:pulse 2s infinite}

/* ─── Main Layout ─── */
.app{flex:1;display:flex;flex-direction:column;overflow:hidden}
.view{display:none;flex:1;overflow:hidden}
.view.active{display:flex;flex-direction:column}

/* ─── Dashboard View ─── */
#dashboard-view{overflow-y:auto;padding:20px;gap:16px}
.section-title{font-size:.76rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text-3);font-weight:600;margin-bottom:12px}

/* Stats Row */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:18px}
.stat-card{
  background:linear-gradient(180deg,var(--bg-2),var(--bg-1));border:1px solid var(--border);
  border-radius:var(--radius);padding:16px 18px;position:relative;overflow:hidden;
}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent)}
.stat-card .stat-label{font-size:.73rem;color:var(--text-3);text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.stat-card .stat-value{font-size:1.35rem;font-weight:700;font-family:var(--mono);color:var(--text-0);line-height:1;margin-top:8px}

/* Project Grid */
.project-grid{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
.project-grid>.card{min-width:270px;max-width:330px;flex-shrink:0;scroll-snap-align:start;display:flex;flex-direction:column}

.card{
  background:linear-gradient(180deg,var(--bg-2),var(--bg-1));border:1px solid var(--border);
  border-radius:var(--radius);overflow:hidden;transition:all var(--dur-md) var(--ease);position:relative;
}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent)}
.card:hover{border-color:var(--border-hover);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.card-accent{position:absolute;top:12px;bottom:12px;left:0;width:3px;border-radius:0 3px 3px 0;transition:all var(--dur-md)}
.card:hover .card-accent{width:4px}
.card-body{padding:16px 16px 16px 18px;display:flex;flex-direction:column;flex:1}
.card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;gap:8px}
.card-name{font-size:.92rem;font-weight:600;color:var(--text-0);line-height:1.3}
.card-stack{font-size:.73rem;color:var(--text-2);background:var(--bg-surface);padding:3px 9px;border-radius:var(--radius-full);border:1px solid var(--border);white-space:nowrap;flex-shrink:0}

.status{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:var(--radius-full);font-size:.74rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em}
.status .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status.busy{background:var(--green-dim);color:var(--green)}
.status.busy .dot{background:var(--green);box-shadow:0 0 8px rgba(52,211,153,.6);animation:statusPulse 1.5s ease-in-out infinite}
.status.waiting{background:var(--yellow-dim);color:var(--yellow)}
.status.waiting .dot{background:var(--yellow);box-shadow:0 0 6px rgba(251,191,36,.4);animation:statusPulse 2.5s ease-in-out infinite}
.status.idle{background:var(--bg-surface);color:var(--text-3)}
.status.idle .dot{background:var(--text-3)}
.status.no_data,.status.no_sessions{background:rgba(86,88,104,.08);color:var(--text-3)}
.status.no_data .dot,.status.no_sessions .dot{background:var(--text-3)}
@keyframes statusPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.4);opacity:.4}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.card-info{display:flex;flex-direction:column;margin:10px 0;background:var(--bg-surface);border-radius:var(--radius-sm);overflow:hidden}
.info-row{display:flex;align-items:center;justify-content:space-between;padding:7px 12px;font-size:.82rem;border-bottom:1px solid var(--border)}
.info-row:last-child{border-bottom:none}
.info-label{color:var(--text-3);font-weight:500}
.info-value{color:var(--text-2);font-family:var(--mono);font-size:.78rem}
.info-value.branch{color:var(--accent-bright)}

.commits{list-style:none;display:flex;flex-direction:column;gap:3px;margin:8px 0}
.commits li{font-size:.76rem;color:var(--text-3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-left:14px;position:relative;line-height:1.6}
.commits li::before{content:'';position:absolute;left:4px;top:6px;width:4px;height:4px;border-radius:50%;background:var(--border-hover)}

.pr-list{display:flex;flex-direction:column;gap:3px;margin-bottom:8px}
.pr-item{display:flex;align-items:center;gap:6px;font-size:.78rem;padding:5px 10px;background:var(--bg-surface);border-radius:var(--radius-sm);border:1px solid var(--border)}
.pr-num{color:var(--accent);font-weight:600;font-family:var(--mono)}
.pr-title{color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.pr-review{font-size:.73rem;padding:2px 6px;border-radius:6px;font-weight:600}
.pr-review.APPROVED{background:var(--green-dim);color:var(--green)}
.pr-review.CHANGES_REQUESTED{background:var(--red-dim);color:var(--red)}
.pr-review.PENDING{background:rgba(86,88,104,.15);color:var(--text-3)}

.card-foot{margin-top:auto;padding-top:10px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
.card-btn-row{display:flex;align-items:center;gap:4px}
.card-btn-row .row-label{font-size:.62rem;text-transform:uppercase;letter-spacing:.06em;color:var(--text-3);font-weight:600;width:36px;flex-shrink:0}
.card-btn-row .btn{padding:4px 10px;font-size:.72rem}
.card-btn-row .btn.primary{padding:4px 12px}
.card-btn-row .btn-icon-sm{width:26px;height:26px;padding:0;display:inline-flex;align-items:center;justify-content:center;font-size:.7rem}
.card-btn-row .btn-icon-sm svg{width:13px;height:13px}
.pm-script-item:hover{background:var(--bg-surface-hover)}
.btn{
  padding:6px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);
  background:var(--bg-surface);color:var(--text-2);font-size:.8rem;font-weight:500;
  cursor:pointer;transition:all var(--dur) var(--ease);white-space:nowrap;font-family:var(--font);
}
.btn:hover{background:var(--bg-surface-hover);color:var(--text-0);border-color:var(--border-hover);transform:translateY(-1px);box-shadow:var(--shadow-sm)}
.btn:active{transform:translateY(0)}
.btn.primary{background:linear-gradient(135deg,var(--accent-dim),var(--accent));color:#fff;border-color:transparent;font-weight:600}
.btn.off-btn{color:var(--text-3);opacity:.6}
.btn.primary:hover{box-shadow:var(--shadow-glow),var(--shadow-sm);filter:brightness(1.1)}
.btn-icon{width:30px;height:28px;display:inline-flex;align-items:center;justify-content:center;padding:0}

/* Charts */
.charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:18px}
@media(max-width:1000px){.charts-grid{grid-template-columns:1fr}}
.chart-card{background:linear-gradient(180deg,var(--bg-2),var(--bg-1));border:1px solid var(--border);border-radius:var(--radius);padding:16px;position:relative}
.chart-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent)}
.chart-card h3{font-size:.86rem;font-weight:600;margin-bottom:14px;color:var(--text-2);display:flex;align-items:center;gap:6px}
.chart-card h3::before{content:'';width:3px;height:14px;background:linear-gradient(135deg,var(--accent-dim),var(--accent));border-radius:2px}
.chart-wrap{position:relative;height:200px}

/* ─── Usage Dashboard ─── */
.usage-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px}
@media(max-width:900px){.usage-grid{grid-template-columns:1fr}}
.usage-card{background:linear-gradient(180deg,var(--bg-2),var(--bg-1));border:1px solid var(--border);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden}
.usage-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent)}
.usage-card .uc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.usage-card .uc-title{font-size:.76rem;color:var(--text-3);text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.usage-card .uc-sub{font-size:.73rem;color:var(--text-3);font-family:var(--mono)}
.usage-card .uc-main{font-size:1.35rem;font-weight:700;font-family:var(--mono);color:var(--text-0);line-height:1;margin-bottom:14px}
.usage-card .uc-stats{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.usage-card .uc-stat-row{display:flex;justify-content:space-between;align-items:center;font-size:.82rem}
.usage-card .uc-stat-row .label{color:var(--text-3)}
.usage-card .uc-stat-row .val{color:var(--text-1);font-family:var(--mono);font-weight:500}
.usage-card .uc-models{margin-top:0;border-top:1px solid var(--border);padding-top:10px}
.usage-card .uc-model-row{display:flex;justify-content:space-between;align-items:center;font-size:.8rem;padding:3px 0}
.usage-card .uc-model-row .name{color:var(--text-2)}
.usage-card .uc-model-row .val{color:var(--text-1);font-family:var(--mono);font-weight:600}
.usage-card .uc-model-row .pct{color:var(--text-3);font-family:var(--mono);font-size:.73rem;margin-left:4px}
.usage-card .uc-footer{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:.8rem;color:var(--text-3);font-family:var(--mono)}

/* ─── Terminal View ─── */
#terminal-view{flex-direction:column;position:relative}
.term-panels{flex:1;overflow:hidden;position:relative}

/* Per-terminal header */
.term-head{height:32px;display:flex;align-items:center;gap:8px;padding:0 12px;background:var(--bg-1);border-bottom:1px solid var(--border);font-size:.82rem;flex-shrink:0;cursor:grab;user-select:none;transition:background var(--dur)}
.term-head:active{cursor:grabbing}
.term-head .th-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;box-shadow:0 0 4px rgba(255,255,255,.1)}
.term-head .th-name{color:var(--text-1);font-weight:600;white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis}
.term-head .th-tag{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:4px;font-family:var(--mono);font-size:.76rem;white-space:nowrap}
.term-head .th-branch{background:rgba(99,102,241,.12);color:var(--accent-bright)}
.term-head .th-worktree{background:rgba(255,255,255,.04);color:var(--text-3)}
.term-head .th-changes{background:rgba(251,191,36,.1);color:var(--yellow);cursor:pointer}
.term-head .th-changes:hover{background:rgba(251,191,36,.2)}
.term-head .th-model{background:rgba(255,255,255,.04);color:var(--text-3)}
.term-head .th-spacer{flex:1}
.term-head .th-close{background:none;border:none;color:var(--text-3);cursor:pointer;padding:2px 6px;font-size:.85rem;border-radius:var(--radius-sm);transition:all var(--dur);line-height:1;opacity:0}
.term-head:hover .th-close{opacity:.5}
.term-head .th-close:hover{opacity:1;color:var(--red);background:rgba(248,113,113,.1)}
.split-leaf.active .term-head{background:var(--bg-2)}

/* Context menu */
.ctx-menu{position:fixed;z-index:999;min-width:200px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.5),0 2px 8px rgba(0,0,0,.3);padding:5px 0;font-size:.84rem;display:none;backdrop-filter:blur(12px)}
.ctx-menu.show{display:block;animation:ctxIn .12s var(--ease)}
@keyframes ctxIn{from{opacity:0;scale:.96}to{opacity:1;scale:1}}
.ctx-menu-item{display:flex;align-items:center;gap:10px;padding:7px 14px;cursor:pointer;color:var(--text-2);transition:all var(--dur);border-radius:0}
.ctx-menu-item:hover{background:var(--bg-surface-hover);color:var(--text-1)}
.ctx-menu-item .ctx-icon{width:16px;text-align:center;color:var(--text-3);font-size:.78rem}
.ctx-menu-sep{height:1px;background:var(--border);margin:4px 0}
.ctx-menu-item.danger{color:var(--red)}
.ctx-menu-item.danger:hover{background:rgba(248,113,113,.08)}

/* Split layout */
.split-container{display:flex;width:100%;height:100%}
.split-container.horizontal{flex-direction:row}
.split-container.vertical{flex-direction:column}
.split-child{overflow:hidden;position:relative}
.split-leaf{position:relative;width:100%;height:100%;overflow:hidden}
.split-leaf .xterm-wrap{width:100%;flex:1;overflow:hidden}
.split-divider{flex-shrink:0;background:var(--border);z-index:5;transition:background var(--dur)}
.split-divider:hover,.split-divider.active{background:var(--accent)}
.split-divider.h{width:4px;cursor:col-resize}
.split-divider.v{height:4px;cursor:row-resize}
.drop-overlay{position:absolute;inset:0;z-index:10;pointer-events:none;display:none}
.split-leaf.drag-over .drop-overlay{display:block;pointer-events:auto}
.drop-zone{position:absolute;opacity:0;transition:opacity .1s;border-radius:4px}
.drop-zone.active{opacity:1}
.drop-zone.top{top:4px;left:4px;right:4px;height:calc(33% - 4px);background:rgba(99,102,241,.12);border:2px dashed var(--accent)}
.drop-zone.bottom{bottom:4px;left:4px;right:4px;height:calc(33% - 4px);background:rgba(99,102,241,.12);border:2px dashed var(--accent)}
.drop-zone.left{left:4px;top:4px;bottom:4px;width:calc(33% - 4px);background:rgba(99,102,241,.12);border:2px dashed var(--accent)}
.drop-zone.right{right:4px;top:4px;bottom:4px;width:calc(33% - 4px);background:rgba(99,102,241,.12);border:2px dashed var(--accent)}
.term-empty{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-3);font-size:.95rem;flex-direction:column;gap:8px}

/* Terminal search bar */
.term-search{position:absolute;top:0;right:0;z-index:20;display:none;align-items:center;gap:6px;padding:6px 10px;background:var(--bg-2);border:1px solid var(--border);border-radius:0 0 0 var(--radius-sm);box-shadow:var(--shadow-md)}
.term-search.open{display:flex}
.term-search input{width:200px;padding:4px 8px;background:var(--bg-0);color:var(--text-1);border:1px solid var(--border);border-radius:var(--radius-xs);font-size:.82rem;font-family:var(--font);outline:none}
.term-search input:focus{border-color:var(--accent)}
.term-search .ts-btn{width:24px;height:24px;display:flex;align-items:center;justify-content:center;border:none;background:var(--bg-surface);color:var(--text-2);border-radius:var(--radius-xs);cursor:pointer;font-size:.75rem;transition:all var(--dur)}
.term-search .ts-btn:hover{background:var(--bg-surface-hover);color:var(--text-0)}
.term-search .ts-count{font-size:.72rem;color:var(--text-3);font-family:var(--mono);min-width:24px;text-align:center}

/* Diff file nav (dialog) */
.diff-file-nav{display:flex;gap:6px;flex-wrap:wrap;padding:10px 14px}
.diff-file-chip{padding:4px 10px;font-size:.74rem;font-family:var(--mono);background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-2);cursor:pointer;transition:all var(--dur);white-space:nowrap;display:inline-flex;align-items:center;gap:5px}
.diff-file-chip:hover{border-color:var(--accent);color:var(--text-1);background:var(--accent-glow)}
.diff-file-chip .fc-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* Branch/worktree picker in New Terminal modal */
.nt-branch-list{max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-0);margin-top:4px}
.nt-branch-group{padding:2px 0}
.nt-branch-group-head{padding:5px 10px;font-size:.72rem;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:.03em;display:flex;align-items:center;gap:6px}
.nt-branch-item{display:flex;align-items:center;gap:8px;padding:5px 10px 5px 16px;cursor:pointer;font-size:.78rem;font-family:var(--mono);transition:background var(--dur)}
.nt-branch-item:hover{background:var(--bg-surface-hover)}
.nt-branch-item.selected{background:var(--accent-glow);color:var(--accent-bright)}
.nt-branch-item .nb-current{font-size:.66rem;color:var(--green);margin-left:auto;font-family:var(--font)}
.nt-branch-item .nb-wt-path{color:var(--text-3);font-size:.68rem;margin-left:auto;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Worktree popover on terminal header */
.th-worktree{position:relative;cursor:default}
.wt-popover{position:absolute;top:100%;left:0;z-index:50;min-width:260px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-md);padding:4px 0;display:none;pointer-events:auto}
.th-worktree:hover .wt-popover{display:block}
.wt-popover-item{padding:5px 12px;font-size:.74rem;font-family:var(--mono);display:flex;flex-direction:column;gap:1px}
.wt-popover-item .wt-branch{color:var(--accent-bright)}
.wt-popover-item .wt-path{color:var(--text-3);font-size:.68rem}
.wt-popover-item.wt-current{background:var(--accent-glow)}

/* Dev server button/dot */
.dev-dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.dev-dot.on{background:var(--green);box-shadow:0 0 6px rgba(52,211,153,.5)}
.dev-dot.off{background:var(--text-3);opacity:.4}
.dev-dot.none{background:var(--text-3);opacity:.2;border:1px dashed var(--text-3)}
.dev-dot.spin{background:var(--yellow);animation:dev-pulse .8s ease infinite}
@keyframes dev-pulse{0%,100%{box-shadow:0 0 0 rgba(251,191,36,.3)}50%{box-shadow:0 0 8px rgba(251,191,36,.7)}}
.dev-btn.running{border-color:var(--green);color:var(--green)}
.dev-btn.running:hover{background:rgba(52,211,153,.1)}
.dev-btn.starting{border-color:var(--yellow);color:var(--yellow)}
.dev-port{display:inline-block;font-family:var(--mono);font-size:.65rem;margin-left:2px}
.dev-port.pop{animation:port-pop .4s var(--ease) both}
@keyframes port-pop{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}

/* Dev server dialog items */
.dev-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:.82rem}
.dev-item:last-child{border-bottom:none}
.dev-item .di-name{font-weight:600;color:var(--text-1)}
.dev-item .di-cmd{font-family:var(--mono);font-size:.74rem;color:var(--text-2)}
.dev-item .di-time{font-size:.72rem;color:var(--text-3);margin-left:auto;font-family:var(--mono)}

/* Kbd hint */
.kbd{display:inline-block;padding:1px 5px;font-size:.68rem;font-family:var(--mono);background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-3);line-height:1.4}

/* Session history */
.session-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);font-size:.82rem;transition:background var(--dur)}
.session-item:last-child{border-bottom:none}
.session-item:hover{background:var(--bg-surface)}
.session-item .si-model{color:var(--accent-bright);font-family:var(--mono);font-size:.76rem;min-width:80px}
.session-item .si-time{color:var(--text-3);font-family:var(--mono);font-size:.74rem;min-width:60px}
.session-item .si-tokens{color:var(--text-2);font-family:var(--mono);font-size:.74rem}
.session-item .si-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.session-item .si-id{color:var(--text-3);font-size:.72rem;font-family:var(--mono);margin-left:auto}

/* ─── Diff View ─── */
#diff-view{overflow:hidden;padding:0;gap:0}
.diff-toolbar{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--bg-1);border-bottom:1px solid var(--border);flex-shrink:0}
.diff-toolbar select{padding:5px 10px;background:var(--bg-2);color:var(--text-1);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.82rem;font-family:var(--font);transition:border-color var(--dur);outline:none}
.diff-toolbar select:focus{border-color:var(--accent)}
.diff-toolbar .dt-icon-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border:1px solid transparent;border-radius:var(--radius-sm);background:transparent;color:var(--text-3);cursor:pointer;transition:all var(--dur);padding:0}
.diff-toolbar .dt-icon-btn:hover{background:var(--bg-surface-hover);color:var(--text-1);border-color:var(--border)}
.diff-toolbar .dt-icon-btn svg{width:14px;height:14px}
.diff-summary{display:flex;align-items:center;gap:8px;margin-left:auto;font-size:.74rem;font-family:var(--mono)}
.diff-summary .ds-files{color:var(--text-2)}
.diff-summary .ds-add{color:var(--green)}
.diff-summary .ds-del{color:var(--red)}

.diff-layout{display:flex;flex:1;overflow:hidden}

/* ─── Sidebar (VS Code style) ─── */
.diff-sidebar{width:260px;background:var(--bg-0);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}

/* Commit box at top of sidebar */
.diff-commit-box{padding:12px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:8px;flex-shrink:0}
.diff-commit-box textarea{width:100%;min-height:56px;max-height:120px;padding:8px 10px;background:var(--bg-1);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-1);font-size:.8rem;font-family:var(--mono);outline:none;transition:border-color var(--dur);resize:vertical;line-height:1.5;box-sizing:border-box}
.diff-commit-box textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.diff-commit-box textarea::placeholder{color:var(--text-3)}
.diff-commit-box .dcb-row{display:flex;gap:6px;align-items:center}
.diff-commit-box .dcb-commit-btn{flex:1;padding:6px 12px;border:none;border-radius:var(--radius-sm);font-size:.78rem;font-weight:600;font-family:var(--font);cursor:pointer;transition:all var(--dur);display:flex;align-items:center;justify-content:center;gap:6px;background:linear-gradient(135deg,#059669,#10b981);color:#fff}
.diff-commit-box .dcb-commit-btn:hover{background:linear-gradient(135deg,#047857,#059669);box-shadow:0 2px 8px rgba(16,185,129,.25)}
.diff-commit-box .dcb-commit-btn:disabled{opacity:.35;pointer-events:none;background:var(--bg-surface);color:var(--text-3);border:1px solid var(--border)}
.diff-commit-box .dcb-commit-btn svg{width:13px;height:13px}
.diff-commit-box .dcb-staged-count{font-size:.7rem;color:var(--text-3);font-family:var(--mono);white-space:nowrap}
.diff-commit-box .dcb-ai-btn{width:30px;height:30px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(139,92,246,.3);border-radius:var(--radius-sm);background:rgba(139,92,246,.1);color:#a78bfa;cursor:pointer;transition:all var(--dur);padding:0;flex-shrink:0}
.diff-commit-box .dcb-ai-btn:hover{background:rgba(139,92,246,.2);border-color:rgba(139,92,246,.5);color:#c4b5fd}
.diff-commit-box .dcb-ai-btn:disabled{opacity:.4;pointer-events:none}
.diff-commit-box .dcb-ai-btn svg{width:14px;height:14px}
.diff-commit-box .dcb-ai-btn.loading{background:rgba(139,92,246,.25);border-color:rgba(139,92,246,.5);animation:aiPulse 1.2s ease-in-out infinite}
.diff-commit-box .dcb-ai-btn.loading svg{animation:acSpin .8s linear infinite}
.diff-commit-box textarea.ai-loading{border-color:rgba(139,92,246,.5);box-shadow:0 0 0 2px rgba(139,92,246,.15);animation:aiPulse 1.2s ease-in-out infinite}
@keyframes aiPulse{0%,100%{border-color:rgba(139,92,246,.3);box-shadow:0 0 0 2px rgba(139,92,246,.08)}50%{border-color:rgba(139,92,246,.6);box-shadow:0 0 0 3px rgba(139,92,246,.2)}}

/* Sidebar search */
.diff-sidebar-search{padding:6px 10px;flex-shrink:0}
.diff-sidebar-search input{width:100%;padding:5px 8px 5px 28px;background:var(--bg-1) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='M21 21l-4.35-4.35'/%3E%3C/svg%3E") 8px center no-repeat;border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-1);font-size:.72rem;font-family:var(--mono);outline:none;transition:border-color var(--dur);box-sizing:border-box}
.diff-sidebar-search input:focus{border-color:var(--accent)}
.diff-sidebar-search input::placeholder{color:var(--text-3)}

/* File list */
.diff-sidebar-list{flex:1;overflow-y:auto}
.diff-sidebar .ds-group{padding:0}
.diff-sidebar .ds-group+.ds-group{border-top:1px solid var(--border)}
.diff-sidebar .ds-group-head{display:flex;align-items:center;gap:6px;padding:7px 12px;font-size:.7rem;font-weight:700;color:var(--text-2);text-transform:uppercase;letter-spacing:.05em;cursor:pointer;user-select:none;transition:all var(--dur);background:var(--bg-2);border-bottom:1px solid var(--border)}
.diff-sidebar .ds-group-head:hover{color:var(--text-1);background:var(--bg-3)}
.diff-sidebar .ds-group-head .ds-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.diff-sidebar .ds-group-head .ds-chevron{font-size:.55rem;transition:transform var(--dur);width:10px}
.diff-sidebar .ds-group-head .ds-count{padding:1px 7px;border-radius:var(--radius-full);font-size:.66rem;font-weight:600}
.diff-sidebar .ds-group[data-section="staged"] .ds-group-head{border-left:3px solid var(--accent)}
.diff-sidebar .ds-group[data-section="staged"] .ds-count{background:var(--accent-glow);color:var(--accent-bright)}
.diff-sidebar .ds-group[data-section="unstaged"] .ds-group-head{border-left:3px solid var(--yellow)}
.diff-sidebar .ds-group[data-section="unstaged"] .ds-count{background:var(--yellow-dim);color:var(--yellow)}
.diff-sidebar .ds-group.collapsed .ds-group-items{display:none}
.diff-sidebar .ds-group.collapsed .ds-chevron{transform:rotate(-90deg)}

/* Group actions (stage all, unstage all, discard all) */
.ds-group-head .ds-actions{display:flex;align-items:center;gap:1px;margin-left:auto}
.ds-group-head .ds-action{width:22px;height:22px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:var(--text-3);cursor:pointer;border-radius:var(--radius-sm);transition:all var(--dur);padding:0;opacity:0}
.ds-group-head:hover .ds-action{opacity:1}
.ds-group-head .ds-action:hover{background:var(--bg-surface);color:var(--text-1)}
.ds-group-head .ds-action svg{width:12px;height:12px}

/* File items */
.diff-file-item{display:flex;align-items:center;gap:6px;padding:3px 12px 3px 20px;cursor:pointer;transition:all var(--dur);font-size:.76rem;border-left:2px solid transparent}
.diff-file-item:hover{background:var(--bg-surface-hover)}
.diff-file-item.active{background:var(--bg-surface);border-left-color:var(--accent)}
.diff-file-item .fi-status{font-size:.66rem;font-weight:700;font-family:var(--mono);width:12px;text-align:center;flex-shrink:0}
.diff-file-item .fi-status.st-A{color:var(--green)}
.diff-file-item .fi-status.st-M{color:var(--yellow)}
.diff-file-item .fi-status.st-D{color:var(--red)}
.diff-file-item .fi-status.st-R{color:var(--blue)}
.diff-file-item .fi-name{color:var(--text-1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:var(--mono);font-size:.73rem;flex:1;min-width:0}
.diff-file-item .fi-stat{display:flex;gap:4px;font-size:.66rem;font-family:var(--mono);flex-shrink:0}
.diff-file-item .fi-stat .fs-add{color:var(--green)}
.diff-file-item .fi-stat .fs-del{color:var(--red)}

/* File hover actions */
.diff-file-item .fi-actions{display:none;align-items:center;gap:1px;flex-shrink:0}
.diff-file-item:hover .fi-actions{display:flex}
.diff-file-item:hover .fi-stat{display:none}
.fi-action{width:20px;height:20px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:var(--text-3);cursor:pointer;border-radius:var(--radius-sm);transition:all var(--dur);padding:0}
.fi-action:hover{color:var(--text-1)}
.fi-action.fa-stage:hover{color:var(--green);background:rgba(52,211,153,.1)}
.fi-action.fa-unstage:hover{color:var(--yellow);background:rgba(250,204,21,.08)}
.fi-action.fa-discard:hover{color:var(--red);background:rgba(248,113,113,.1)}
.fi-action svg{width:12px;height:12px}

/* ─── Main diff area ─── */
.diff-main{flex:1;overflow-y:auto;padding:0;display:flex;flex-direction:column}
.diff-main-inner{display:flex;flex-direction:column;gap:1px;padding:8px 12px 12px}

.diff-panel{border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;background:var(--bg-0);transition:border-color var(--dur)}
.diff-panel:hover{border-color:var(--border-hover)}
.diff-panel-head{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg-1);border-bottom:1px solid var(--border);cursor:pointer;user-select:none;transition:background var(--dur)}
.diff-panel-head:hover{background:var(--bg-2)}
.diff-panel-head .dp-chevron{font-size:.6rem;color:var(--text-3);transition:transform var(--dur);width:10px;text-align:center}
.diff-panel-head .dp-status{font-size:.68rem;font-weight:700;font-family:var(--mono);width:14px;text-align:center}
.diff-panel-head .dp-status.st-A{color:var(--green)}
.diff-panel-head .dp-status.st-M{color:var(--yellow)}
.diff-panel-head .dp-status.st-D{color:var(--red)}
.diff-panel-head .dp-status.st-R{color:var(--blue)}
.diff-panel-head .dp-path{font-family:var(--mono);font-size:.76rem;color:var(--text-1);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;flex:1}
.diff-panel-head .dp-dir{color:var(--text-3);font-weight:400}
.diff-panel-head .dp-stat{display:flex;gap:6px;font-size:.7rem;font-family:var(--mono);flex-shrink:0}
.diff-panel-head .dp-stat .ps-add{color:var(--green)}
.diff-panel-head .dp-stat .ps-del{color:var(--red)}
.diff-panel-head .dp-badge{font-size:.64rem;padding:2px 7px;border-radius:var(--radius-full);font-weight:600;font-family:var(--font);flex-shrink:0}
.diff-panel-head .dp-badge.staged{background:var(--accent-glow);color:var(--accent-bright)}
.diff-panel-head .dp-badge.unstaged{background:var(--yellow-dim);color:var(--yellow)}

/* Panel head actions (show on hover) */
.diff-panel-head .dp-actions{display:flex;align-items:center;gap:2px;flex-shrink:0;opacity:0;transition:opacity var(--dur)}
.diff-panel-head:hover .dp-actions{opacity:1}
.dp-action{width:22px;height:22px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:var(--text-3);cursor:pointer;border-radius:var(--radius-sm);transition:all var(--dur);padding:0}
.dp-action:hover{background:var(--bg-surface-hover);color:var(--text-1)}
.dp-action svg{width:12px;height:12px}

.diff-panel.collapsed .diff-panel-body{display:none}
.diff-panel.collapsed .dp-chevron{transform:rotate(-90deg)}

.diff-panel-body{overflow-x:auto}
.diff-panel-body table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:.76rem;line-height:1.6}
.diff-panel-body td{padding:0;white-space:pre;vertical-align:top}
.diff-panel-body .dl-gutter{width:40px;min-width:40px;text-align:right;padding-right:8px;color:var(--text-3);opacity:.4;user-select:none;font-size:.7rem;border-right:1px solid var(--border)}
.diff-panel-body .dl-gutter-new{border-right:none;padding-right:12px}
.diff-panel-body .dl-code{padding-left:12px;padding-right:12px}
.diff-panel-body tr.dl-add{background:rgba(52,211,153,.06)}
.diff-panel-body tr.dl-add .dl-code{color:#6ee7b7}
.diff-panel-body tr.dl-del{background:rgba(248,113,113,.06)}
.diff-panel-body tr.dl-del .dl-code{color:#fca5a5}
.diff-panel-body tr.dl-hunk{background:rgba(99,102,241,.04)}
.diff-panel-body tr.dl-hunk td{color:var(--accent);padding:3px 0;font-size:.72rem}
.diff-panel-body tr.dl-ctx .dl-code{color:var(--text-3)}

/* Section label */
.diff-section-label{display:flex;align-items:center;gap:10px;padding:6px 0 2px;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-3)}
.diff-section-label::after{content:'';flex:1;height:1px;background:var(--border)}
.diff-section-label .dsl-dot{width:6px;height:6px;border-radius:50%}

/* Empty state */
.diff-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:12px;color:var(--text-3);padding:40px}
.diff-empty svg{width:44px;height:44px;opacity:.25}
.diff-empty .de-title{font-size:.9rem;font-weight:600;color:var(--text-2)}
.diff-empty .de-sub{font-size:.76rem}

/* ─── Auto Commit ─── */
.ac-btn{display:flex;align-items:center;gap:6px;padding:6px 14px;background:linear-gradient(135deg,rgba(139,92,246,.2),rgba(99,102,241,.2));border:1px solid rgba(139,92,246,.3);border-radius:var(--radius-sm);color:#c4b5fd;font-size:.8rem;font-weight:600;font-family:var(--font);cursor:pointer;transition:all var(--dur);white-space:nowrap}
.ac-btn:hover{background:linear-gradient(135deg,rgba(139,92,246,.35),rgba(99,102,241,.35));border-color:rgba(139,92,246,.5);color:#ddd6fe;transform:translateY(-1px);box-shadow:0 4px 12px rgba(139,92,246,.2)}
.ac-btn:active{transform:translateY(0)}
.ac-btn svg{width:14px;height:14px}
.ac-btn.loading{pointer-events:none;opacity:.7}
.ac-btn.loading svg{animation:acSpin 1s linear infinite}
@keyframes acSpin{to{transform:rotate(360deg)}}

.diff-branch-info{display:flex;align-items:center;gap:8px;font-size:.76rem;font-family:var(--mono);color:var(--text-2);position:relative}
.diff-branch-info .dbi-branch{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-full);color:var(--accent-bright);font-weight:600;cursor:pointer;transition:all var(--dur)}
.diff-branch-info .dbi-branch:hover{background:var(--bg-surface-hover);border-color:var(--accent)}
.diff-branch-info .dbi-branch svg{width:12px;height:12px;opacity:.7}
.diff-branch-info .dbi-branch .dbi-chevron{font-size:.5rem;opacity:.5;margin-left:2px}
.diff-branch-info .dbi-wt{color:var(--text-3);font-size:.72rem;cursor:pointer;padding:2px 8px;border-radius:var(--radius-full);transition:all var(--dur)}
.diff-branch-info .dbi-wt:hover{background:var(--bg-surface-hover);color:var(--text-2)}

/* Branch/Worktree dropdown */
.branch-dropdown{position:absolute;top:100%;left:0;margin-top:4px;min-width:240px;max-height:320px;overflow-y:auto;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:100;display:none;flex-direction:column}
.branch-dropdown.open{display:flex}
.branch-dropdown .bd-search{padding:8px;border-bottom:1px solid var(--border);flex-shrink:0}
.branch-dropdown .bd-search input{width:100%;padding:5px 8px;background:var(--bg-1);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-1);font-size:.74rem;font-family:var(--mono);outline:none;box-sizing:border-box}
.branch-dropdown .bd-search input:focus{border-color:var(--accent)}
.branch-dropdown .bd-section{padding:4px 0}
.branch-dropdown .bd-label{padding:4px 12px;font-size:.66rem;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em}
.branch-dropdown .bd-item{display:flex;align-items:center;gap:8px;padding:5px 12px;cursor:pointer;font-size:.76rem;font-family:var(--mono);color:var(--text-1);transition:all var(--dur)}
.branch-dropdown .bd-item:hover{background:var(--bg-surface-hover)}
.branch-dropdown .bd-item.current{color:var(--accent-bright);font-weight:600}
.branch-dropdown .bd-item .bd-check{width:14px;font-size:.7rem;flex-shrink:0;text-align:center}
.branch-dropdown .bd-item .bd-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.branch-dropdown .bd-item .bd-delete{color:var(--text-3);font-size:.9rem;padding:0 4px;border-radius:var(--radius-xs);transition:all var(--dur);opacity:0;flex-shrink:0}
.branch-dropdown .bd-item:hover .bd-delete{opacity:1}
.branch-dropdown .bd-item .bd-delete:hover{color:var(--red);background:var(--red-dim)}

.ac-overlay{position:absolute;inset:0;z-index:10;background:var(--bg-1);display:flex;flex-direction:column;animation:acFadeIn .25s var(--ease)}
@keyframes acFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.ac-header{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.ac-header h3{font-size:.95rem;font-weight:700;color:var(--text-0);margin:0;display:flex;align-items:center;gap:8px}
.ac-header h3 svg{width:18px;height:18px;color:#a78bfa}
.ac-header .ac-branch{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-full);font-size:.74rem;font-family:var(--mono);color:var(--accent-bright);font-weight:600}
.ac-header .ac-branch svg{width:12px;height:12px;opacity:.7}
.ac-header .ac-stats{margin-left:auto;display:flex;gap:10px;font-size:.76rem;font-family:var(--mono)}
.ac-header .ac-stats .acs-commits{color:var(--accent)}
.ac-header .ac-stats .acs-files{color:var(--text-3)}
.ac-cancel{padding:5px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-2);font-size:.78rem;font-family:var(--font);cursor:pointer;transition:all var(--dur)}
.ac-cancel:hover{background:var(--bg-surface-hover);color:var(--text-1);border-color:var(--border-hover)}

.ac-body{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px}

.ac-commit-card{border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-2);overflow:hidden;transition:all .3s var(--ease)}
.ac-commit-card.done{border-color:rgba(52,211,153,.3);background:rgba(52,211,153,.04)}
.ac-commit-card.executing{border-color:rgba(99,102,241,.4);box-shadow:0 0 0 2px var(--accent-glow)}
.ac-commit-card.failed{border-color:rgba(248,113,113,.3);background:rgba(248,113,113,.04)}
.ac-commit-card.drag-over{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow);background:rgba(99,102,241,.04)}
.ac-commit-card .ac-card-delete{width:24px;height:24px;border:none;background:transparent;color:var(--text-3);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);font-size:.9rem;transition:all var(--dur);flex-shrink:0}
.ac-commit-card .ac-card-delete:hover{background:var(--red-dim);color:var(--red)}

.ac-card-head{display:flex;align-items:center;gap:10px;padding:12px 16px}
.ac-card-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.74rem;font-weight:700;font-family:var(--mono);flex-shrink:0;transition:all .3s var(--ease);background:var(--bg-surface);color:var(--text-2);border:1px solid var(--border)}
.ac-commit-card.done .ac-card-num{background:rgba(52,211,153,.15);color:var(--green);border-color:rgba(52,211,153,.3)}
.ac-commit-card.executing .ac-card-num{background:var(--accent-glow);color:var(--accent-bright);border-color:var(--accent);animation:acPulse 1.5s ease-in-out infinite}
.ac-commit-card.failed .ac-card-num{background:rgba(248,113,113,.15);color:var(--red);border-color:rgba(248,113,113,.3)}
@keyframes acPulse{0%,100%{box-shadow:0 0 0 0 var(--accent-glow)}50%{box-shadow:0 0 0 6px transparent}}

.ac-card-msg{flex:1;min-width:0}
.ac-card-msg input{width:100%;background:transparent;border:1px solid transparent;border-radius:var(--radius-sm);padding:4px 8px;font-size:.86rem;font-weight:600;color:var(--text-1);font-family:var(--mono);outline:none;transition:all var(--dur)}
.ac-card-msg input:hover{border-color:var(--border)}
.ac-card-msg input:focus{border-color:var(--accent);background:var(--bg-0);box-shadow:0 0 0 2px var(--accent-glow)}
.ac-commit-card.done .ac-card-msg input{color:var(--green);opacity:.8;pointer-events:none}

.ac-card-reason{font-size:.72rem;color:var(--text-3);padding:0 16px 0 54px;margin-top:-4px;font-style:italic}

.ac-card-files{display:flex;flex-wrap:wrap;gap:5px;padding:10px 16px 14px 54px;min-height:36px}
.ac-card-files.drag-over-files{background:rgba(99,102,241,.04);border-radius:0 0 var(--radius) var(--radius)}
.ac-file-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-full);font-size:.72rem;font-family:var(--mono);color:var(--text-2);transition:all var(--dur);cursor:grab;user-select:none}
.ac-file-tag:hover{border-color:var(--border-hover);color:var(--text-1);background:var(--bg-surface-hover)}
.ac-file-tag:active{cursor:grabbing}
.ac-file-tag.dragging{opacity:.3}
.ac-file-tag .aft-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.ac-file-tag .aft-down{width:14px;height:14px;display:flex;align-items:center;justify-content:center;margin-left:2px;color:var(--text-3);cursor:pointer;border-radius:50%;transition:all var(--dur);font-size:.65rem}
.ac-file-tag .aft-down:hover{color:var(--red);background:var(--red-dim)}
.ac-commit-card.done .ac-file-tag{opacity:.5;pointer-events:none;cursor:default}

.ac-add-commit{display:flex;align-items:center;justify-content:center;gap:6px;padding:10px;border:1px dashed var(--border);border-radius:var(--radius);color:var(--text-3);font-size:.8rem;font-family:var(--font);cursor:pointer;transition:all var(--dur);background:transparent}
.ac-add-commit:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}

.ac-pending{border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-0);overflow:hidden;transition:all .3s var(--ease)}
.ac-pending.drag-over{border-color:var(--yellow);box-shadow:0 0 0 2px var(--yellow-dim)}
.ac-pending-head{display:flex;align-items:center;gap:8px;padding:10px 16px;font-size:.78rem;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid var(--border)}
.ac-pending-head .aph-count{font-size:.72rem;padding:1px 7px;background:var(--bg-surface);border-radius:var(--radius-full);color:var(--text-2);font-weight:500}
.ac-pending-files{display:flex;flex-wrap:wrap;gap:5px;padding:12px 16px;min-height:40px}
.ac-pending-empty{color:var(--text-3);font-size:.76rem;font-style:italic;padding:4px 0}
.ac-pending .ac-file-tag .aft-down{transform:rotate(180deg)}
.ac-pending .ac-file-tag .aft-down:hover{color:var(--green);background:var(--green-dim)}

.ac-footer{display:flex;align-items:center;gap:10px;padding:14px 20px;border-top:1px solid var(--border);flex-shrink:0;background:var(--bg-2)}
.ac-progress{flex:1;display:flex;align-items:center;gap:10px}
.ac-progress-bar{flex:1;height:6px;background:var(--bg-surface);border-radius:var(--radius-full);overflow:hidden}
.ac-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),#a78bfa);border-radius:var(--radius-full);transition:width .4s var(--ease);width:0}
.ac-progress-text{font-size:.76rem;font-family:var(--mono);color:var(--text-2);white-space:nowrap}

.ac-commit-btn{padding:8px 20px;background:linear-gradient(135deg,#7c3aed,#6366f1);border:none;border-radius:var(--radius-sm);color:#fff;font-size:.84rem;font-weight:600;font-family:var(--font);cursor:pointer;transition:all var(--dur);display:flex;align-items:center;gap:6px}
.ac-commit-btn:hover{background:linear-gradient(135deg,#6d28d9,#4f46e5);transform:translateY(-1px);box-shadow:0 4px 14px rgba(99,102,241,.3)}
.ac-commit-btn:active{transform:translateY(0)}
.ac-commit-btn:disabled{opacity:.5;pointer-events:none}
.ac-commit-btn svg{width:14px;height:14px}

.ac-push-btn{padding:8px 20px;background:linear-gradient(135deg,#059669,#10b981);border:none;border-radius:var(--radius-sm);color:#fff;font-size:.84rem;font-weight:600;font-family:var(--font);cursor:pointer;transition:all var(--dur);display:flex;align-items:center;gap:6px}
.ac-push-btn:hover{background:linear-gradient(135deg,#047857,#059669);transform:translateY(-1px);box-shadow:0 4px 14px rgba(16,185,129,.3)}
.ac-push-btn:active{transform:translateY(0)}
.ac-push-btn:disabled{opacity:.5;pointer-events:none}

.ac-done-msg{display:flex;align-items:center;gap:8px;font-size:.84rem;color:var(--green);font-weight:600}
.ac-done-msg svg{width:16px;height:16px}

/* ─── Modal ─── */
dialog{background:var(--bg-2);color:var(--text-1);border:1px solid var(--border);border-radius:var(--radius);padding:0;max-width:460px;width:90%;box-shadow:var(--shadow-lg),0 0 0 1px rgba(255,255,255,.03);overflow:hidden;position:fixed;inset:0;margin:auto;height:fit-content}
dialog[open]{display:flex;flex-direction:column;animation:modalIn .2s var(--ease)}
@keyframes modalIn{from{opacity:0;scale:.96}to{opacity:1;scale:1}}
dialog::backdrop{background:rgba(0,0,0,.7);backdrop-filter:blur(8px)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
.modal-header h2{font-size:1.05rem;font-weight:600;margin:0}
.modal-close{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);border:none;background:transparent;color:var(--text-3);cursor:pointer;font-size:1.1rem;transition:all var(--dur)}
.modal-close:hover{background:var(--bg-surface-hover);color:var(--text-1)}
.modal-body{padding:14px 20px}
.modal-body label{display:block;font-size:.78rem;color:var(--text-3);margin-bottom:5px;margin-top:14px;font-weight:600;text-transform:uppercase;letter-spacing:.04em}
.modal-body label:first-child{margin-top:0}
.modal-body select,.modal-body input[type="text"],.modal-body input[type="color"]{
  width:100%;padding:8px 12px;background:var(--bg-0);color:var(--text-1);
  border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.88rem;font-family:var(--font);outline:none;
  transition:border-color var(--dur);
}
.modal-body input:focus,.modal-body select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.modal-body input[type="color"]{height:36px;padding:4px;cursor:pointer}
/* Path picker */
.path-input-row{display:flex;gap:6px;align-items:center}
.path-input-row input{flex:1;margin:0}
.path-input-row .btn-browse{flex-shrink:0;padding:6px 10px;font-size:.8rem;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-2);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--dur);display:flex;align-items:center;gap:4px}
.path-input-row .btn-browse:hover{background:var(--bg-surface-hover);color:var(--text-1);border-color:var(--accent)}
.folder-picker{margin-top:6px;background:var(--bg-1);border:1px solid var(--border);border-radius:var(--radius-sm);max-height:200px;overflow-y:auto;display:none}
.folder-picker.open{display:block}
.folder-picker .fp-breadcrumb{display:flex;align-items:center;gap:2px;padding:7px 12px;border-bottom:1px solid var(--border);font-size:.78rem;color:var(--text-3);flex-wrap:wrap;background:var(--bg-surface)}
.folder-picker .fp-breadcrumb span{cursor:pointer;color:var(--accent);transition:color var(--dur)}
.folder-picker .fp-breadcrumb span:hover{color:var(--text-1)}
.folder-picker .fp-breadcrumb .fp-sep{color:var(--text-4);cursor:default;margin:0 1px}
.folder-picker .fp-list{list-style:none;margin:0;padding:0}
.folder-picker .fp-item{display:flex;align-items:center;gap:8px;padding:6px 12px;font-size:.82rem;color:var(--text-2);cursor:pointer;transition:background var(--dur);border-bottom:1px solid var(--border-subtle, rgba(255,255,255,.03))}
.folder-picker .fp-item:last-child{border-bottom:none}
.folder-picker .fp-item:hover{background:var(--bg-surface-hover);color:var(--text-1)}
.folder-picker .fp-item svg{width:14px;height:14px;flex-shrink:0;color:var(--accent);opacity:.7}
.folder-picker .fp-select{display:flex;justify-content:flex-end;padding:6px 10px;border-top:1px solid var(--border);background:var(--bg-surface)}
.folder-picker .fp-select .btn{font-size:.78rem;padding:4px 12px}
.folder-picker .fp-empty{padding:16px 12px;text-align:center;font-size:.82rem;color:var(--text-3)}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 20px;border-top:1px solid var(--border);background:var(--bg-surface)}

/* ─── Settings Panel ─── */
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:500;opacity:0;visibility:hidden;transition:all var(--dur-md)}
.settings-overlay.open{opacity:1;visibility:visible}
.settings-panel{
  position:fixed;top:0;right:0;bottom:0;width:420px;max-width:90vw;
  background:var(--bg-1);border-left:1px solid var(--border);box-shadow:var(--shadow-lg);
  z-index:501;display:flex;flex-direction:column;
  transform:translateX(100%);transition:transform var(--dur-md) var(--ease);
}
.settings-panel.open{transform:translateX(0)}
.settings-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
.settings-header h2{font-size:1rem;font-weight:700}
.settings-body{flex:1;overflow-y:auto;padding:16px 20px}
.settings-project-list{display:flex;flex-direction:column;gap:8px}
.spi{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);transition:all var(--dur)}
.spi:hover{border-color:var(--border-hover)}
.spi-color{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.spi-info{flex:1;min-width:0}
.spi-name{font-size:.9rem;font-weight:600}
.spi-path{font-size:.73rem;color:var(--text-3);font-family:var(--mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.spi-actions{display:flex;gap:4px}
.settings-footer{padding:12px 20px;border-top:1px solid var(--border);flex-shrink:0}

/* ─── Toast ─── */
.toast-container{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column-reverse;gap:8px;z-index:10000;pointer-events:none}
.toast{padding:10px 16px;border-radius:var(--radius-sm);font-size:.86rem;font-weight:500;box-shadow:var(--shadow-lg);pointer-events:auto;animation:toastIn .3s var(--ease) forwards;display:flex;align-items:center;gap:8px;max-width:380px}
.toast.info{background:rgba(99,102,241,.92);color:#fff;border:1px solid rgba(129,140,248,.3)}
.toast.success{background:rgba(16,185,129,.92);color:#fff;border:1px solid rgba(52,211,153,.3)}
.toast.error{background:rgba(239,68,68,.92);color:#fff;border:1px solid rgba(248,113,113,.3)}
.toast.exiting{animation:toastOut .3s var(--ease) forwards}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(40px)}}

/* ─── Skeleton ─── */
.skeleton{background:linear-gradient(90deg,var(--bg-2) 25%,var(--bg-3) 50%,var(--bg-2) 75%);background-size:200% 100%;animation:shimmer 1.5s ease-in-out infinite;border-radius:var(--radius)}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-card{height:220px}

/* ─── README View ─── */
#readme-view{overflow-y:auto;padding:24px 32px}
.readme-content{max-width:780px;margin:0 auto;line-height:1.7;color:var(--text-1)}
.readme-content h1{font-size:1.5rem;font-weight:700;color:var(--text-0);margin:0 0 16px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.readme-content h2{font-size:1.15rem;font-weight:600;color:var(--text-0);margin:28px 0 10px}
.readme-content h3{font-size:1rem;font-weight:600;color:var(--text-1);margin:20px 0 8px}
.readme-content p{margin:8px 0;font-size:.88rem;color:var(--text-2)}
.readme-content ul,.readme-content ol{margin:8px 0 8px 20px;font-size:.86rem;color:var(--text-2)}
.readme-content li{margin:4px 0}
.readme-content code{font-family:var(--mono);font-size:.82rem;background:var(--bg-surface);padding:2px 6px;border-radius:var(--radius-xs);color:var(--accent-bright);border:1px solid var(--border)}
.readme-content pre{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;overflow-x:auto;margin:10px 0}
.readme-content pre code{background:none;border:none;padding:0;color:var(--text-1)}
.readme-content table{width:100%;border-collapse:collapse;margin:10px 0;font-size:.84rem}
.readme-content th{text-align:left;padding:8px 12px;background:var(--bg-surface);color:var(--text-0);font-weight:600;border:1px solid var(--border)}
.readme-content td{padding:8px 12px;border:1px solid var(--border);color:var(--text-2)}
.readme-content hr{border:none;border-top:1px solid var(--border);margin:20px 0}
.readme-content blockquote{border-left:3px solid var(--accent);padding:8px 16px;margin:10px 0;background:var(--bg-surface);border-radius:0 var(--radius-sm) var(--radius-sm) 0}
.readme-content a{color:var(--accent-bright);text-decoration:none}
.readme-content a:hover{text-decoration:underline}

/* ─── Project Search ─── */
.project-search-bar{display:flex;gap:8px;margin-bottom:10px;align-items:center}
.project-search-bar input{flex:1;padding:7px 12px 7px 32px;background:var(--bg-2);color:var(--text-1);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.82rem;font-family:var(--font);outline:none;transition:border-color var(--dur);background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23565868' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.3-4.3'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:10px center}
.project-search-bar input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.project-search-bar input::placeholder{color:var(--text-3)}
.project-search-count{font-size:.72rem;color:var(--text-3);font-family:var(--mono);white-space:nowrap}
.project-grid-wrap{position:relative}
.scroll-ind{position:absolute;top:0;bottom:8px;width:40px;z-index:5;pointer-events:none;transition:opacity var(--dur)}
.scroll-ind.left{left:0;background:linear-gradient(to right,var(--bg-0) 0%,transparent 100%)}
.scroll-ind.right{right:0;background:linear-gradient(to left,var(--bg-0) 0%,transparent 100%)}
.scroll-ind.hidden{opacity:0}


/* ─── Feedback ─── */
.term-disconnect{position:absolute;bottom:8px;left:8px;z-index:15;display:flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.3);border-radius:var(--radius-sm);font-size:.72rem;color:var(--red);font-weight:500;pointer-events:none;animation:pulse 2s infinite}
.uncommitted-val.has-changes{color:var(--yellow)!important;cursor:pointer}
.uncommitted-val.has-changes:hover{text-decoration:underline}

/* ─── Light Theme ─── */
.light-theme{
  --bg-0:#f4f5f7;--bg-1:#ffffff;--bg-2:#f0f1f3;--bg-3:#e6e7eb;--bg-4:#d8d9de;
  --bg-surface:rgba(0,0,0,0.03);--bg-surface-hover:rgba(0,0,0,0.06);
  --text-0:#111827;--text-1:#1f2937;--text-2:#6b7280;--text-3:#9ca3af;
  --border:rgba(0,0,0,0.09);--border-hover:rgba(0,0,0,0.16);--border-active:rgba(99,102,241,0.4);
  --accent:#6366f1;--accent-bright:#4f46e5;--accent-dim:#818cf8;
  --accent-glow:rgba(99,102,241,0.08);--accent-glow-strong:rgba(99,102,241,0.16);
  --green:#059669;--green-dim:rgba(5,150,105,0.1);
  --yellow:#d97706;--yellow-dim:rgba(217,119,6,0.1);
  --red:#dc2626;--red-dim:rgba(220,38,38,0.1);
  --blue:#2563eb;--blue-dim:rgba(37,99,235,0.1);
  --shadow-sm:0 1px 2px rgba(0,0,0,.05),0 1px 3px rgba(0,0,0,.03);
  --shadow-md:0 4px 6px rgba(0,0,0,.06),0 2px 4px rgba(0,0,0,.04);
  --shadow-lg:0 10px 25px rgba(0,0,0,.08),0 6px 10px rgba(0,0,0,.05);
  --shadow-glow:0 0 20px rgba(99,102,241,.06);
}
.light-theme *{scrollbar-color:rgba(0,0,0,.12) transparent}
.light-theme ::-webkit-scrollbar-thumb{background:rgba(0,0,0,.12)}
.light-theme ::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.22)}

/* ─── Theme Toggle ─── */
.theme-toggle{width:30px;height:30px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-surface);color:var(--text-2);cursor:pointer;transition:all var(--dur);padding:0}
.theme-toggle:hover{background:var(--bg-surface-hover);color:var(--text-1);border-color:var(--border-hover)}
.theme-toggle svg{width:15px;height:15px}

/* ─── Keyboard Shortcut Overlay ─── */
.shortcut-overlay{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;animation:fadeIn .15s ease}
.shortcut-overlay.hidden{display:none}
.shortcut-card{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--radius);padding:28px 32px;max-width:500px;width:92%;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow-lg);position:relative}
.shortcut-card h2{font-size:1rem;font-weight:700;color:var(--text-0);margin-bottom:18px;display:flex;align-items:center;gap:8px}
.shortcut-card h2 svg{width:18px;height:18px;color:var(--accent)}
.shortcut-card table{width:100%;border-collapse:collapse}
.shortcut-card td{padding:5px 0;font-size:.82rem}
.shortcut-card td:first-child{font-family:var(--mono);color:var(--accent-bright);width:44%;font-size:.78rem}
.shortcut-card td:last-child{color:var(--text-1)}
.shortcut-card .sc-section td{color:var(--text-3);font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.06em;padding:14px 0 4px}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* ─── Diff Toolbar Action Buttons ─── */
.diff-toolbar .dt-act-group{display:flex;gap:4px;margin-left:4px;padding-left:8px;border-left:1px solid var(--border)}
.diff-toolbar .dt-act-btn{padding:4px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-surface);color:var(--text-2);cursor:pointer;font-size:.72rem;font-family:var(--font);font-weight:500;display:flex;align-items:center;gap:4px;transition:all var(--dur);white-space:nowrap}
.diff-toolbar .dt-act-btn:hover{background:var(--bg-surface-hover);color:var(--text-1);border-color:var(--border-hover)}
.diff-toolbar .dt-act-btn svg{width:12px;height:12px}
.diff-toolbar .dt-act-btn.loading{opacity:.6;pointer-events:none}

/* ─── Project Pin ─── */
.card-pin{position:absolute;top:8px;right:8px;width:22px;height:22px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:var(--text-3);cursor:pointer;opacity:0;transition:all var(--dur);border-radius:var(--radius-xs);padding:0;z-index:2}
.card-pin:hover{color:var(--yellow);opacity:1!important}
.card-pin.pinned{color:var(--yellow);opacity:1!important}
.card-pin svg{width:13px;height:13px}
.project-card:hover .card-pin{opacity:.6}

/* ─── Branch Create Dialog ─── */
.branch-create-row{display:flex;gap:6px;padding:6px 0;border-top:1px solid var(--border);margin-top:4px}
.branch-create-row input{flex:1;padding:5px 8px;background:var(--bg-2);color:var(--text-1);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.78rem;font-family:var(--mono);outline:none}
.branch-create-row input:focus{border-color:var(--accent)}
.branch-create-row button{padding:5px 10px;border:1px solid var(--accent-dim);border-radius:var(--radius-sm);background:rgba(99,102,241,.1);color:var(--accent-bright);font-size:.72rem;font-family:var(--font);font-weight:600;cursor:pointer;transition:all var(--dur);white-space:nowrap}
.branch-create-row button:hover{background:rgba(99,102,241,.2)}

/* ─── Chart Period Selector ─── */
.chart-period{display:flex;gap:2px;margin-left:auto;background:var(--bg-0);padding:2px;border-radius:var(--radius-xs)}
.chart-period button{padding:3px 10px;border:none;border-radius:3px;background:transparent;color:var(--text-3);font-size:.7rem;font-family:var(--font);font-weight:600;cursor:pointer;transition:all var(--dur)}
.chart-period button:hover{color:var(--text-2)}
.chart-period button.active{background:var(--bg-3);color:var(--text-0)}

/* ─── Responsive Layout ─── */
@media(max-width:768px){
  header{padding:0 10px;gap:4px}
  .nav-tab{padding:5px 10px;font-size:.76rem}
  .nav-tab span.tab-label{display:none}
  .header-right .stat-badge{display:none}
  .stats-row{grid-template-columns:repeat(2,1fr);gap:8px}
  #dashboard-view{padding:12px}
  .project-grid{gap:8px}
  .project-card{min-width:240px}
  .settings-panel{width:100%;max-width:100%}
}
@media(max-width:480px){
  .stats-row{grid-template-columns:1fr}
  .usage-grid{grid-template-columns:1fr}
  .project-card{min-width:200px}
  header{height:42px}
  .logo{font-size:.85rem}
  .header-clock{display:none}
}

/* ─── Terminal Font Settings ─── */
.term-font-controls{display:flex;align-items:center;gap:4px;margin-left:auto;padding-right:8px}
.term-font-btn{width:22px;height:22px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:var(--radius-xs);background:transparent;color:var(--text-3);cursor:pointer;font-size:.7rem;font-family:var(--mono);font-weight:700;transition:all var(--dur);padding:0}
.term-font-btn:hover{color:var(--text-1);border-color:var(--border-hover);background:var(--bg-surface)}
.term-font-size{font-family:var(--mono);font-size:.72rem;color:var(--text-2);min-width:18px;text-align:center}

/* ─── Git Log Viewer ─── */
.git-log-item{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:.82rem;transition:background var(--dur)}
.git-log-item:last-child{border-bottom:none}
.git-log-item:hover{background:var(--bg-surface)}
.git-log-hash{color:var(--accent-bright);font-family:var(--mono);font-size:.74rem;min-width:65px;flex-shrink:0}
.git-log-msg{color:var(--text-1);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.git-log-author{color:var(--text-3);font-size:.74rem;min-width:80px;text-align:right;flex-shrink:0}
.git-log-time{color:var(--text-3);font-family:var(--mono);font-size:.72rem;min-width:70px;text-align:right;flex-shrink:0}

/* ─── Error Log Viewer ─── */
.error-log-item{padding:8px 12px;border-bottom:1px solid var(--border);font-size:.78rem;font-family:var(--mono)}
.error-log-item:last-child{border-bottom:none}
.error-log-item .el-time{color:var(--text-3);font-size:.7rem;margin-right:8px}
.error-log-item .el-msg{color:var(--red)}
.error-log-item .el-src{color:var(--text-3);font-size:.7rem;margin-top:2px}
.error-log-empty{padding:20px;text-align:center;color:var(--text-3);font-size:.85rem}

/* ─── Settings Export/Import ─── */
.settings-actions{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.settings-actions .btn{flex:1;justify-content:center}

/* ─── Discover Modal ─── */
.discover-list{display:flex;flex-direction:column;gap:6px;max-height:50vh;overflow-y:auto;padding:4px 0}
.discover-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-2);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all var(--dur)}
.discover-item:hover{border-color:var(--accent);background:var(--bg-3)}
.discover-item.selected{border-color:var(--accent);background:color-mix(in srgb,var(--accent) 8%,var(--bg-2))}
.discover-check{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all var(--dur)}
.discover-item.selected .discover-check{border-color:var(--accent);background:var(--accent)}
.discover-item.selected .discover-check::after{content:'';display:block;width:5px;height:9px;border:solid var(--bg-1);border-width:0 2px 2px 0;transform:rotate(45deg);margin-top:-2px}
.discover-info{flex:1;min-width:0}
.discover-name{font-weight:600;font-size:.88rem;color:var(--text-1);display:flex;align-items:center;gap:6px}
.discover-path{font-size:.75rem;color:var(--text-3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.discover-meta{display:flex;gap:8px;font-size:.72rem;color:var(--text-3);margin-top:2px}
.discover-badge{padding:1px 6px;border-radius:4px;font-size:.68rem;font-weight:600}
.discover-badge.git{background:color-mix(in srgb,var(--green) 15%,transparent);color:var(--green)}
.discover-badge.no-git{background:color-mix(in srgb,var(--text-3) 12%,transparent);color:var(--text-3)}
.discover-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.discover-header .discover-count{font-size:.82rem;color:var(--text-3)}
.discover-select-all{font-size:.78rem;color:var(--accent);cursor:pointer;text-decoration:underline;background:none;border:none}
.discover-empty{text-align:center;padding:40px 20px;color:var(--text-3);font-size:.88rem}
.discover-loading{text-align:center;padding:40px 20px;color:var(--text-3)}
.discover-loading::after{content:'';display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-left:8px;vertical-align:middle}

/* ─── Notification Filter ─── */
.notif-filter-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:.82rem}
.notif-filter-row:last-child{border-bottom:none}
.notif-filter-row .nf-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.notif-filter-row .nf-name{flex:1;color:var(--text-1)}
.notif-toggle{width:36px;height:20px;border-radius:10px;border:none;background:var(--bg-3);position:relative;cursor:pointer;transition:background var(--dur);padding:0;flex-shrink:0}
.notif-toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:var(--text-3);transition:all var(--dur)}
.notif-toggle.on{background:var(--accent-dim)}
.notif-toggle.on::after{left:18px;background:var(--accent-bright)}
</style>
</head>
<body>

<header>
  <div class="logo">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="2.5" fill="currentColor" stroke="none" opacity=".3"/><path d="M4.93 4.93l2.12 2.12M19.07 4.93l-2.12 2.12M12 2v2M22 12h-2M2 12h2" stroke-width="1.2" opacity=".4"/></svg>
    Cockpit
  </div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchView('dashboard')">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Overview
    </button>
    <button class="nav-tab" onclick="switchView('terminal')">
      <svg viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
      Terminal
    </button>
    <button class="nav-tab" onclick="switchView('diff')">
      <svg viewBox="0 0 24 24"><path d="M12 3v18"/><path d="M5 12h14"/></svg>
      Changes
    </button>
    <button class="nav-tab" onclick="switchView('readme')">
      <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
      README
    </button>
  </div>
  <div class="header-right">
    <span class="header-clock" id="header-clock"></span>
    <div class="stat-badge"><span>Output</span><span class="value" id="today-output">0</span></div>
    <div class="stat-badge"><span>Msgs</span><span class="value" id="today-msgs">0</span></div>
    <div class="stat-badge" id="dev-server-badge" onclick="showDevServerDialog()" style="cursor:pointer" title="Running dev servers"><span>Dev</span><span class="value" id="dev-count">0</span></div>
    <button class="btn" id="notify-toggle" onclick="toggleNotifications()" style="font-size:.72rem;padding:3px 8px" title="Toggle notifications (right-click for per-project settings)" oncontextmenu="event.preventDefault();openNotifSettings()">On</button>
    <button class="header-btn" onclick="openErrorLog()" title="Error Log" id="error-log-btn" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    </button>
    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
      <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>
      <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    </button>
    <span class="conn-dot" id="conn-dot"></span>
    <button class="header-btn" onclick="openSettingsPanel()" title="Settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    </button>
  </div>
</header>

<div class="app">
  <!-- Dashboard View -->
  <div class="view active" id="dashboard-view">
    <section>
      <div class="stats-row" id="stats-row">
        <div class="stat-card"><span class="stat-label">Active Sessions</span><span class="stat-value" id="stat-active">0</span></div>
        <div class="stat-card"><span class="stat-label">Output Tokens</span><span class="stat-value" id="stat-today">0</span></div>
        <div class="stat-card"><span class="stat-label">Open PRs</span><span class="stat-value" id="stat-prs">0</span></div>
        <div class="stat-card"><span class="stat-label">Uncommitted</span><span class="stat-value" id="stat-uncommitted">0</span></div>
      </div>
    </section>
    <section>
      <div class="section-title">Projects</div>
      <div class="project-search-bar">
        <input type="text" id="project-search" placeholder="Search projects..." oninput="filterProjects()">
        <span class="project-search-count" id="project-search-count"></span>
      </div>
      <div class="project-grid-wrap">
        <div class="scroll-ind left hidden" id="scroll-ind-left"></div>
        <div class="project-grid" id="project-grid"></div>
        <div class="scroll-ind right hidden" id="scroll-ind-right"></div>
      </div>
    </section>
    <section>
      <div class="section-title" style="margin-top:16px">Cost & Usage</div>
      <div class="usage-grid" id="usage-grid">
        <!-- Today -->
        <div class="usage-card" id="uc-today">
          <div class="uc-header"><span class="uc-title">Today</span><span class="uc-sub" id="uc-today-date"></span></div>
          <div class="uc-main" id="uc-today-output">0 tok</div>
          <div class="uc-stats" id="uc-today-stats"></div>
          <div class="uc-models" id="uc-today-models"></div>
          <div class="uc-footer" id="uc-today-cost"></div>
        </div>
        <!-- This Week -->
        <div class="usage-card" id="uc-week">
          <div class="uc-header"><span class="uc-title">This Week</span><span class="uc-sub" id="uc-week-reset"></span></div>
          <div class="uc-main" id="uc-week-output">0 tok</div>
          <div class="uc-stats" id="uc-week-stats"></div>
          <div class="uc-models" id="uc-week-models"></div>
          <div class="uc-footer" id="uc-week-cost"></div>
        </div>
        <!-- Overview -->
        <div class="usage-card" id="uc-overview">
          <div class="uc-header"><span class="uc-title">Overview</span></div>
          <div class="uc-stats" id="uc-overview-stats"></div>
          <div class="uc-footer" id="uc-plan-info"></div>
        </div>
      </div>
      <div class="charts-grid">
        <div class="chart-card"><h3>Daily Output Tokens <span id="chart-period-label">(30d)</span><div class="chart-period"><button class="active" onclick="setChartPeriod(7)">7d</button><button onclick="setChartPeriod(14)">14d</button><button onclick="setChartPeriod(30)">30d</button></div></h3><div class="chart-wrap"><canvas id="daily-chart"></canvas></div></div>
        <div class="chart-card"><h3>By Model</h3><div class="chart-wrap"><canvas id="model-chart"></canvas></div></div>
      </div>
    </section>
  </div>

  <!-- Terminal View -->
  <div class="view" id="terminal-view">
    <div class="term-panels" id="term-panels">
      <div class="term-empty"><button class="btn" onclick="openNewTermModal()">+ New Terminal</button></div>
    </div>
    <div class="term-search" id="term-search-bar">
      <input type="text" placeholder="Search..." onkeydown="if(event.key==='Enter'){doTermSearch(event.shiftKey?'prev':'next');event.preventDefault();}if(event.key==='Escape'){closeTermSearch()}" oninput="doTermSearch('next')">
      <button class="ts-btn" onclick="doTermSearch('prev')" title="Previous">&uarr;</button>
      <button class="ts-btn" onclick="doTermSearch('next')" title="Next">&darr;</button>
      <button class="ts-btn" onclick="closeTermSearch()" title="Close (Esc)">&times;</button>
      <span style="width:1px;height:16px;background:var(--border);margin:0 4px"></span>
      <div class="term-font-controls">
        <button class="term-font-btn" onclick="changeTermFontSize(-1)" title="Decrease font">−</button>
        <span class="term-font-size" id="term-font-size">13</span>
        <button class="term-font-btn" onclick="changeTermFontSize(1)" title="Increase font">+</button>
      </div>
    </div>
  </div>

  <!-- Diff View -->
  <div class="view" id="diff-view">
    <div class="diff-toolbar">
      <select id="diff-project" onchange="loadDiff()"></select>
      <div class="diff-branch-info" id="diff-branch-info"></div>
      <div class="diff-summary" id="diff-summary"></div>
      <button class="dt-icon-btn" onclick="diffExpandAll()" title="Expand All (E)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 10l5 5 5-5"/></svg>
      </button>
      <button class="dt-icon-btn" onclick="diffCollapseAll()" title="Collapse All (C)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 14l5-5 5 5"/></svg>
      </button>
      <button class="dt-icon-btn" onclick="loadDiff()" title="Refresh (R)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 105.64-8.36L1 10"/></svg>
      </button>
      <button class="ac-btn" id="ac-btn" onclick="startAutoCommit()" title="AI Auto-Commit">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M5.5 8.5l13 7M18.5 8.5l-13 7"/></svg>
        AI Commit
      </button>
      <div class="dt-act-group">
        <button class="dt-act-btn" id="dt-pull-btn" onclick="doPull()" title="Git Pull">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
          Pull
        </button>
        <button class="dt-act-btn" id="dt-fetch-btn" onclick="doFetch()" title="Git Fetch --all">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Fetch
        </button>
        <button class="dt-act-btn" id="dt-stash-btn" onclick="doStash()" title="Git Stash">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
          Stash
        </button>
        <button class="dt-act-btn" id="dt-stash-pop-btn" onclick="doStashPop()" title="Git Stash Pop">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 15v4a2 2 0 002 2h14a2 2 0 002-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Pop
        </button>
      </div>
    </div>
    <div class="diff-layout" style="position:relative;flex:1;overflow:hidden">
      <aside class="diff-sidebar" id="diff-sidebar">
        <div class="diff-commit-box">
          <textarea id="diff-commit-msg" placeholder="Commit message (Ctrl+Enter to commit)" rows="2" onkeydown="if(event.ctrlKey&&event.key==='Enter'){event.preventDefault();doManualCommit()}"></textarea>
          <div class="dcb-row">
            <button class="dcb-ai-btn" id="dcb-ai-btn" onclick="generateCommitMsg()" title="AI: Generate commit message">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M5.5 8.5l13 7M18.5 8.5l-13 7"/></svg>
            </button>
            <button class="dcb-commit-btn" id="dcb-commit-btn" onclick="doManualCommit()" disabled>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
              Commit
            </button>
            <span class="dcb-staged-count" id="dcb-staged-info"></span>
          </div>
        </div>
        <div class="diff-sidebar-search">
          <input type="text" id="diff-file-search" placeholder="Filter files..." oninput="filterDiffFiles()">
        </div>
        <div class="diff-sidebar-list" id="diff-sidebar-list"></div>
      </aside>
      <main class="diff-main" id="diff-main">
        <div class="diff-empty" id="diff-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>
          <span class="de-title">No changes</span>
          <span class="de-sub">Working tree is clean</span>
        </div>
      </main>
    </div>
  </div>

  <!-- README View -->
  <div class="view" id="readme-view">
    <div class="readme-content" id="readme-content"></div>
  </div>
</div>

<!-- New Terminal Modal -->
<dialog id="new-term-modal">
  <div class="modal-header"><h2>New Terminal</h2><button class="modal-close" onclick="document.getElementById('new-term-modal').close()">&times;</button></div>
  <div class="modal-body">
    <label>Project</label>
    <select id="nt-project" onchange="loadBranchesForTerm()"></select>
    <label>Command</label>
    <select id="nt-cmd">
      <option value="">Shell only</option>
      <option value="claude">claude</option>
      <option value="claude --continue">claude --continue</option>
      <option value="claude --model opus">claude --model opus</option>
      <option value="claude --model sonnet">claude --model sonnet</option>
    </select>
    <div id="nt-branch-section" style="display:none">
      <label>Branch / Worktree <span style="color:var(--text-3);font-size:.72rem">(optional)</span></label>
      <div class="nt-branch-list" id="nt-branch-list"></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" onclick="document.getElementById('new-term-modal').close()">Cancel</button>
    <button class="btn primary" onclick="createTerminal()">Open</button>
  </div>
</dialog>

<!-- Start Session Modal -->
<dialog id="start-modal">
  <div class="modal-header"><h2>Start Session</h2><button class="modal-close" onclick="document.getElementById('start-modal').close()">&times;</button></div>
  <div class="modal-body">
    <input type="hidden" id="modal-project-id">
    <label>Model</label>
    <select id="modal-model">
      <option value="">Default</option><option value="opus">Opus</option><option value="sonnet">Sonnet</option><option value="haiku">Haiku</option>
    </select>
    <label>Prompt</label>
    <input type="text" id="modal-prompt" placeholder="/orchestrate, /fix, or task">
  </div>
  <div class="modal-footer">
    <button class="btn" onclick="document.getElementById('start-modal').close()">Cancel</button>
    <button class="btn primary" onclick="doStartSession()">Start</button>
  </div>
</dialog>

<!-- Add/Edit Project Modal -->
<dialog id="project-modal">
  <div class="modal-header"><h2 id="pm-title">Add Project</h2><button class="modal-close" onclick="document.getElementById('project-modal').close()">&times;</button></div>
  <div class="modal-body">
    <input type="hidden" id="pm-edit-id">
    <label>Project Name</label>
    <input type="text" id="pm-name" placeholder="My Project">
    <label>Path</label>
    <div class="path-input-row">
      <input type="text" id="pm-path" placeholder="C:/_project/service/my-project">
      <button type="button" class="btn-browse" onclick="toggleFolderPicker()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Browse</button>
    </div>
    <div class="folder-picker" id="folder-picker">
      <div class="fp-breadcrumb" id="fp-breadcrumb"></div>
      <ul class="fp-list" id="fp-list"></ul>
      <div class="fp-select"><button class="btn primary" onclick="selectCurrentFolder()">Select this folder</button></div>
    </div>
    <label>Stack</label>
    <select id="pm-stack">
      <option value="react-next">React / Next.js</option>
      <option value="nestjs">NestJS</option>
      <option value="express">Express</option>
      <option value="python">Python</option>
      <option value="other">Other</option>
    </select>
    <label>Dev Server Command</label>
    <div style="display:flex;gap:6px;align-items:center">
      <input type="text" id="pm-devcmd" placeholder="npm run dev, pnpm dev, etc." style="flex:1">
      <button type="button" class="btn" id="pm-scripts-btn" onclick="loadPkgScripts()" style="font-size:.72rem;white-space:nowrap" title="Load from package.json">Scripts</button>
    </div>
    <div id="pm-scripts-list" style="display:none;max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-0);margin-top:4px"></div>
    <label>GitHub URL <span style="color:var(--text-3);font-size:.72rem">(auto-detected if empty)</span></label>
    <input type="text" id="pm-github" placeholder="https://github.com/org/repo">
    <label>Color</label>
    <input type="color" id="pm-color" value="#6366f1">
  </div>
  <div class="modal-footer">
    <button class="btn" onclick="document.getElementById('project-modal').close()">Cancel</button>
    <button class="btn primary" onclick="saveProject()">Save</button>
  </div>
</dialog>

<!-- Terminal Context Menu -->
<div class="ctx-menu" id="term-ctx-menu"></div>

<!-- Diff Dialog -->
<dialog id="diff-dialog" style="max-width:900px;width:95%">
  <div class="modal-header">
    <h2 id="diff-dialog-title">Changes</h2>
    <div class="diff-summary" id="diff-dialog-summary" style="margin-left:auto;margin-right:12px"></div>
    <button class="modal-close" onclick="document.getElementById('diff-dialog').close()">&times;</button>
  </div>
  <div class="modal-body" style="max-height:70vh;overflow-y:auto;padding:0">
    <div class="diff-file-nav" id="diff-file-nav"></div>
    <div id="diff-dialog-panels" style="padding:10px 14px;display:flex;flex-direction:column;gap:8px"></div>
  </div>
</dialog>

<!-- Session History Dialog -->
<dialog id="session-dialog" style="max-width:600px;width:95%">
  <div class="modal-header">
    <h2 id="session-dialog-title">Session History</h2>
    <button class="modal-close" onclick="document.getElementById('session-dialog').close()">&times;</button>
  </div>
  <div class="modal-body" style="max-height:60vh;overflow-y:auto;padding:0">
    <div id="session-dialog-content" style="padding:14px"></div>
  </div>
</dialog>

<!-- Dev Server Dialog -->
<dialog id="dev-dialog" style="max-width:560px;width:95%">
  <div class="modal-header">
    <h2>Dev Servers</h2>
    <button class="modal-close" onclick="document.getElementById('dev-dialog').close()">&times;</button>
  </div>
  <div class="modal-body" style="max-height:60vh;overflow-y:auto;padding:0">
    <div id="dev-dialog-content"></div>
  </div>
</dialog>

<!-- Git Log Dialog -->
<dialog id="git-log-dialog" style="max-width:700px;width:95%">
  <div class="modal-header">
    <h2 id="git-log-title">Git History</h2>
    <button class="modal-close" onclick="document.getElementById('git-log-dialog').close()">&times;</button>
  </div>
  <div class="modal-body" style="max-height:60vh;overflow-y:auto;padding:0">
    <div id="git-log-content" style="padding:0"></div>
  </div>
</dialog>

<!-- Error Log Dialog -->
<dialog id="error-log-dialog" style="max-width:700px;width:95%">
  <div class="modal-header">
    <h2>Error Log</h2>
    <div style="margin-left:auto;margin-right:12px"><button class="btn" onclick="clearErrorLog()" style="font-size:.72rem">Clear</button></div>
    <button class="modal-close" onclick="document.getElementById('error-log-dialog').close()">&times;</button>
  </div>
  <div class="modal-body" style="max-height:60vh;overflow-y:auto;padding:0">
    <div id="error-log-content"></div>
  </div>
</dialog>

<!-- Discover Projects Dialog -->
<dialog id="discover-dialog" style="max-width:580px;width:95%">
  <div class="modal-header">
    <h2>Discover Projects</h2>
    <button class="modal-close" onclick="document.getElementById('discover-dialog').close()">&times;</button>
  </div>
  <div class="modal-body" id="discover-body">
    <div class="discover-loading">Scanning Claude projects<span></span></div>
  </div>
  <div class="modal-footer" id="discover-footer" style="display:none">
    <button class="btn" onclick="document.getElementById('discover-dialog').close()">Cancel</button>
    <button class="btn primary" id="discover-add-btn" onclick="addDiscoveredProjects()">Add Selected (0)</button>
  </div>
</dialog>

<!-- Notification Settings Dialog -->
<dialog id="notif-settings-dialog" style="max-width:460px;width:95%">
  <div class="modal-header">
    <h2>Notification Settings</h2>
    <button class="modal-close" onclick="document.getElementById('notif-settings-dialog').close()">&times;</button>
  </div>
  <div class="modal-body" style="max-height:60vh;overflow-y:auto;padding:14px">
    <div style="margin-bottom:12px;font-size:.82rem;color:var(--text-2)">Toggle notifications per project:</div>
    <div id="notif-filter-list"></div>
  </div>
</dialog>

<!-- Settings Panel -->
<div class="settings-overlay" id="settings-overlay" onclick="closeSettingsPanel()"></div>
<div class="settings-panel" id="settings-panel">
  <div class="settings-header">
    <h2>Projects</h2>
    <button class="modal-close" onclick="closeSettingsPanel()">&times;</button>
  </div>
  <div class="settings-body">
    <div class="settings-actions">
      <button class="btn" onclick="exportSettings()" title="Download projects.json">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export
      </button>
      <button class="btn" onclick="document.getElementById('import-file').click()" title="Import projects.json">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Import
      </button>
      <input type="file" id="import-file" accept=".json" style="display:none" onchange="importSettings(this)">
      <button class="btn" onclick="openDiscoverModal()" title="Auto-discover Claude projects">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Discover
      </button>
    </div>
    <div class="settings-project-list" id="settings-project-list"></div>
  </div>
  <div class="settings-footer">
    <button class="btn primary" onclick="openAddProjectModal()" style="width:100%">+ Add Project</button>
  </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script type="module">
// ─── State ───
const state = { projects: new Map(), costs: null, usage: null, connected: false };
let projectList = [];
const prevSessionStates = new Map();

// ─── Notifications ───
if ('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}
function notifySessionChange(projectId, oldState, newState) {
  if (!notifyEnabled || Notification.permission !== 'granted') return;
  if (typeof isNotifEnabledForProject === 'function' && !isNotifEnabledForProject(projectId)) return;
  const project = projectList.find(p => p.id === projectId);
  const name = project?.name || projectId;
  const wasActive = oldState === 'busy' || oldState === 'waiting';
  if (wasActive && newState === 'idle') {
    new Notification(`${name} — Session Complete`, { body: 'Claude session finished.', icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2334d399"><circle cx="12" cy="12" r="10"/></svg>', tag: `session-${projectId}`, silent: false });
  } else if (wasActive && (newState === 'no_data' || newState === 'no_sessions')) {
    new Notification(`${name} — Session Ended`, { body: 'Claude session disconnected.', icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f87171"><circle cx="12" cy="12" r="10"/></svg>', tag: `session-${projectId}`, silent: false });
  }
}

// ─── Helpers ───
const _escMap={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
function esc(s){return s?String(s).replace(/[&<>"']/g,c=>_escMap[c]):'';};
function timeAgo(iso){const ms=Date.now()-new Date(iso).getTime();if(ms<60000)return`${Math.floor(ms/1000)}s`;if(ms<3600000)return`${Math.floor(ms/60000)}m`;if(ms<86400000)return`${Math.floor(ms/3600000)}h`;return`${Math.floor(ms/86400000)}d`;}

// ─── Toast ───
function showToast(message, type='info', duration=3000) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => { toast.classList.add('exiting'); setTimeout(() => toast.remove(), 300); }, duration);
}

// ─── Clock ───
function updateClock() {
  const now = new Date();
  document.getElementById('header-clock').textContent = now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
let _clockTimer = setInterval(updateClock, 1000); updateClock();

// ─── Page Visibility: pause timers when tab hidden ───
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    clearInterval(_clockTimer); _clockTimer = null;
    if (usageTimer) { clearInterval(usageTimer); usageTimer = null; }
  } else {
    if (!_clockTimer) _clockTimer = setInterval(updateClock, 1000);
    updateClock();
    if (!usageTimer) usageTimer = setInterval(fetchUsage, 60000);
  }
});

// ─── SSE ───
let _sseBackoff = 1000, _sseReconnTimer = null;
function connectSSE() {
  if (_sseReconnTimer) { clearTimeout(_sseReconnTimer); _sseReconnTimer = null; }
  const es = new EventSource('/api/events');
  es.addEventListener('init', e => {
    _sseBackoff = 1000; // reset on success
    const d = JSON.parse(e.data);
    if (d.sessions) Object.entries(d.sessions).forEach(([k,v]) => { if(v) { upd(k,'session',v); prevSessionStates.set(k, v.state); } });
    if (d.git) Object.entries(d.git).forEach(([k,v]) => { if(v) upd(k,'git',v); });
    if (d.prs) Object.entries(d.prs).forEach(([k,v]) => { if(v) upd(k,'prs',v); });
    if (d.costs) { state.usage = d.costs; renderCosts(); renderUsage(); }
    if (d.devServers) { devServerState = d.devServers; updateDevBadge(); }
    projectList.forEach(p => renderCard(p.id));
    updateSummaryStats();
    fetchUsage();
    setConn(true);
  });
  es.addEventListener('session:status', e => {
    const d=JSON.parse(e.data);
    const oldState = prevSessionStates.get(d.projectId);
    const newState = d.state;
    if (oldState && oldState !== newState) notifySessionChange(d.projectId, oldState, newState);
    prevSessionStates.set(d.projectId, newState);
    upd(d.projectId,'session',d); renderCard(d.projectId); updateSummaryStats(); debouncedUpdateTermHeaders();
  });
  es.addEventListener('git:update', e => { const d=JSON.parse(e.data); upd(d.projectId,'git',d); renderCard(d.projectId); updateSummaryStats(); debouncedUpdateTermHeaders(); });
  es.addEventListener('pr:update', e => { const d=JSON.parse(e.data); upd(d.projectId,'prs',d); renderCard(d.projectId); updateSummaryStats(); });
  es.addEventListener('cost:update', e => { state.usage=JSON.parse(e.data); renderCosts(); renderUsage(); updateSummaryStats(); });
  es.addEventListener('dev:status', e => {
    const d = JSON.parse(e.data);
    const newRunning = d.running || [];
    // Clear knownPorts for stopped servers
    const runIds = new Set(newRunning.map(ds => ds.projectId));
    for (const key of _knownPorts) { if (!runIds.has(key.split(':')[0])) _knownPorts.delete(key); }
    devServerState = newRunning;
    // Clear start timeouts for servers that now have ports
    for (const ds of newRunning) {
      if (ds.port && _devStartTimeouts.has(ds.projectId)) {
        clearTimeout(_devStartTimeouts.get(ds.projectId));
        _devStartTimeouts.delete(ds.projectId);
      }
    }
    updateDevBadge();
    // re-render affected cards
    devServerState.forEach(ds => renderCard(ds.projectId));
    projectList.forEach(p => { if (!devServerState.some(ds => ds.projectId === p.id)) renderCard(p.id); });
  });
  es.onerror = () => { setConn(false); es.close(); _sseBackoff = Math.min(_sseBackoff * 2, 30000); _sseReconnTimer = setTimeout(connectSSE, _sseBackoff); };
}
function upd(id,k,v) { if(!state.projects.has(id)) state.projects.set(id,{}); state.projects.get(id)[k]=v; }
function setConn(v) { state.connected=v; document.getElementById('conn-dot').className='conn-dot'+(v?'':' off'); }

// ─── Summary Stats ───
function fmtTok(n) {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
  return n.toLocaleString();
}
function updateSummaryStats() {
  let active=0, totalPrs=0, totalUncommitted=0;
  for (const [,p] of state.projects) {
    if (p.session?.state==='busy'||p.session?.state==='waiting') active++;
    totalPrs += (p.prs?.prs?.length||0);
    totalUncommitted += (p.git?.uncommittedCount||0);
  }
  document.getElementById('stat-active').textContent = active;
  document.getElementById('stat-prs').textContent = totalPrs;
  document.getElementById('stat-uncommitted').textContent = totalUncommitted;
  if (state.usage?.today) {
    document.getElementById('stat-today').textContent = fmtTok(state.usage.today.outputTokens || 0);
  }
}

// ─── View Switching ───
window.switchView = (name) => {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(`${name}-view`).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.nav-tab[onclick*="${name}"]`).classList.add('active');
  if (name === 'terminal') renderLayout();
  if (name === 'diff') loadDiff();
  try { localStorage.setItem('dl-view', name); } catch {}
};

// ─── Cards ───
function renderCard(id) {
  const el = document.getElementById(`card-${id}`);
  if (!el) return;
  const p = state.projects.get(id) || {};
  const s = p.session || {}, g = p.git || {}, prs = p.prs?.prs || [];
  const st = s.state || 'no_data';
  el.querySelector('.status').className = `status ${st}`;
  el.querySelector('.status').innerHTML = `<span class="dot"></span>${{busy:'Busy',waiting:'Waiting',idle:'Idle',no_data:'No Data',no_sessions:'No Sessions'}[st]||st}`;
  const q = (c) => el.querySelector(c);
  if(q('.branch-val')) q('.branch-val').textContent = g.branch || '-';
  if(q('.uncommitted-val')) { q('.uncommitted-val').textContent = g.uncommittedCount ?? '-'; q('.uncommitted-val').classList.toggle('has-changes', (g.uncommittedCount||0) > 0); }
  if(q('.model-val')) q('.model-val').textContent = s.model || '-';
  if(q('.last-val')) q('.last-val').textContent = s.lastActivity ? timeAgo(s.lastActivity) : '-';
  const cl = q('.commits');
  if(cl && g.recentCommits) cl.innerHTML = g.recentCommits.slice(0,3).map(c=>`<li><span style="color:var(--accent-bright)">${c.hash}</span> ${esc(c.message)}</li>`).join('');
  const pl = q('.pr-list');
  if(pl) pl.innerHTML = prs.length ? prs.slice(0,2).map(pr=>`<div class="pr-item"><span class="pr-num">#${pr.number}</span><span class="pr-title">${esc(pr.title)}</span><span class="pr-review ${pr.reviewDecision}">${pr.reviewDecision==='APPROVED'?'OK':pr.reviewDecision==='CHANGES_REQUESTED'?'Changes':'Pending'}</span></div>`).join('') : '';
  // Dev server button state
  const devBtn = document.getElementById(`dev-btn-${id}`);
  if (devBtn) {
    const proj = projectList.find(pp => pp.id === id);
    const hasCmd = !!proj?.devCmd;
    const isRunning = devServerState.some(d => d.projectId === id);
    if (hasCmd) {
      const dsInfo = devServerState.find(d => d.projectId === id);
      const hasPort = !!dsInfo?.port;
      const isStarting = isRunning && !hasPort;
      const dotClass = isStarting ? 'spin' : (isRunning ? 'on' : 'off');
      const btnClass = isStarting ? ' starting' : (isRunning ? ' running' : '');
      const label = isStarting ? 'Starting...' : (isRunning ? 'Stop' : 'Dev');
      const portKey = `${id}:${dsInfo?.port}`;
      const isNewPort = hasPort && !_knownPorts.has(portKey);
      if (isNewPort) _knownPorts.add(portKey);
      const portTag = hasPort ? `<span class="dev-port${isNewPort?' pop':''}" onclick="event.stopPropagation();window.open('http://localhost:${dsInfo.port}','_blank')">:${dsInfo.port}</span>` : '';
      devBtn.className = 'btn dev-btn' + btnClass;
      devBtn.innerHTML = `<span class="dev-dot ${dotClass}"></span>${label}${portTag}`;
      devBtn.setAttribute('onclick', `toggleDevServer('${id}')`);
      devBtn.title = proj.devCmd + (hasPort ? ` → localhost:${dsInfo.port}` : '');
    } else {
      devBtn.className = 'btn dev-btn';
      devBtn.innerHTML = `<span class="dev-dot none"></span>Dev`;
      devBtn.setAttribute('onclick', `promptDevCmd('${id}')`);
      devBtn.title = 'Set dev command';
    }
  }
  // GitHub button: show if project has github field or remoteUrl from git
  const ghBtn = document.getElementById(`github-btn-${id}`);
  if (ghBtn) {
    const proj = projectList.find(pp => pp.id === id);
    const ghUrl = proj?.github || g.remoteUrl || '';
    ghBtn.style.display = ghUrl ? '' : 'none';
  }
}

let _renderedCardIds = [];
function cardHTML(p) {
  const isPinned = pinnedProjects.has(p.id);
  return `<div class="card" id="card-${p.id}">
      <div class="card-accent" style="background:${p.color};--card-color:${p.color}"></div>
      <button class="card-pin ${isPinned?'pinned':''}" onclick="event.stopPropagation();togglePin('${p.id}')" title="${isPinned?'Unpin':'Pin to front'}">
        <svg viewBox="0 0 24 24" fill="${isPinned?'currentColor':'none'}" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 21 12 17.77 5.82 21 7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      </button>
      <div class="card-body">
        <div class="card-header">
          <div><span class="card-name">${esc(p.name)}</span></div>
          <span class="card-stack">${esc(p.stack||'')}</span>
        </div>
        <div style="margin-bottom:8px"><span class="status no_data"><span class="dot"></span>Loading</span></div>
        <div class="card-info">
          <div class="info-row"><span class="info-label">Branch</span><span class="info-value branch branch-val">-</span></div>
          <div class="info-row"><span class="info-label">Uncommitted</span><span class="info-value uncommitted-val" onclick="jumpToChanges('${p.id}')" title="View changes">-</span></div>
          <div class="info-row"><span class="info-label">Model</span><span class="info-value model-val">-</span></div>
          <div class="info-row"><span class="info-label">Last</span><span class="info-value last-val">-</span></div>
        </div>
        <ul class="commits"></ul>
        <div class="pr-list"></div>
        <div class="card-foot">
          <div class="card-btn-row">
            <span class="row-label">Term</span>
            <button class="btn primary" onclick="openTermWith('${p.id}','claude')">Claude</button>
            <button class="btn" onclick="openTermWith('${p.id}','claude --continue')">Resume</button>
            <button class="btn" onclick="openTermWith('${p.id}','')">Shell</button>
          </div>
          <div class="card-btn-row">
            <span class="row-label">Open</span>
            <button class="btn" onclick="openIDE('${p.id}','code')" title="VS Code">VS</button>
            <button class="btn" onclick="openIDE('${p.id}','cursor')" title="Cursor">Cursor</button>
            <button class="btn" onclick="openIDE('${p.id}','antigravity')" title="Antigravity">AG</button>
            <button class="btn card-github-btn" id="github-btn-${p.id}" onclick="openGitHub('${p.id}')" style="display:none">GitHub</button>
          </div>
          <div class="card-btn-row">
            <span class="row-label">Etc</span>
            <button class="btn dev-btn" id="dev-btn-${p.id}" onclick="${p.devCmd ? `toggleDevServer('${p.id}')` : `promptDevCmd('${p.id}')`}" title="${p.devCmd ? esc(p.devCmd) : 'Set dev command'}"><span class="dev-dot ${p.devCmd ? 'off' : 'none'}"></span>Dev</button>
            <button class="btn" onclick="showSessionHistory('${p.id}')">Sessions</button>
            <button class="btn" onclick="showGitLog('${p.id}')">Log</button>
          </div>
        </div>
      </div>
    </div>`;
}
function renderAllCards(projects) {
  const grid = document.getElementById('project-grid');
  const newIds = projects.map(p => p.id);
  // Incremental: only rebuild if project list changed (add/remove/reorder)
  if (_renderedCardIds.length === newIds.length && _renderedCardIds.every((id,i) => id === newIds[i])) {
    // Same projects — just update data via renderCard
    projects.forEach(p => renderCard(p.id));
  } else {
    // Project list changed — full rebuild
    grid.innerHTML = projects.map(p => cardHTML(p)).join('');
    _renderedCardIds = newIds;
  }
  setTimeout(updateScrollIndicators, 50);
}

function renderSkeletons(count) {
  document.getElementById('project-grid').innerHTML = Array(count).fill('<div class="skeleton skeleton-card"></div>').join('');
}

// ─── Charts ───
let dailyChart, modelChart;
let chartPeriod = parseInt(localStorage.getItem('dl-chart-period') || '30');
window.setChartPeriod = (days) => {
  chartPeriod = days;
  localStorage.setItem('dl-chart-period', days);
  document.querySelectorAll('.chart-period button').forEach(b => b.classList.toggle('active', parseInt(b.textContent) === days));
  const lbl = document.getElementById('chart-period-label');
  if (lbl) lbl.textContent = `(${days}d)`;
  renderCosts();
};
function renderCosts() {
  const u = state.usage;
  if (!u?.daily) return;
  const allDaily = u.daily;
  const daily = allDaily.slice(-chartPeriod);
  const labels = daily.map(d=>d.date?.slice(5)||'');
  const tokens = daily.map(d=>d.outputTokens||0);
  const chartColors = { line:'#818cf8', fill:'rgba(129,140,248,.08)', grid:'rgba(255,255,255,.03)', tick:'#565868' };
  if(dailyChart){dailyChart.data.labels=labels;dailyChart.data.datasets[0].data=tokens;dailyChart.update('none');}
  else{dailyChart=new Chart(document.getElementById('daily-chart'),{type:'line',data:{labels,datasets:[{data:tokens,borderColor:chartColors.line,backgroundColor:chartColors.fill,fill:true,tension:.3,borderWidth:2,pointRadius:1.5,pointHoverRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:chartColors.tick,font:{size:9}},grid:{color:chartColors.grid}},y:{ticks:{color:chartColors.tick,callback:v=>fmtTok(v),font:{size:9}},grid:{color:chartColors.grid}}}}});}
  const mm={};
  daily.forEach(d=>(d.modelBreakdowns||[]).forEach(m=>{const n=m.modelName||'?';mm[n]=(mm[n]||0)+(m.outputTokens||0);}));
  if(modelChart){modelChart.data.labels=Object.keys(mm);modelChart.data.datasets[0].data=Object.values(mm);modelChart.update('none');}
  else{modelChart=new Chart(document.getElementById('model-chart'),{type:'doughnut',data:{labels:Object.keys(mm),datasets:[{data:Object.values(mm),backgroundColor:['#818cf8','#34d399','#fbbf24','#f87171','#60a5fa'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{color:'#9395a5',font:{size:10},padding:8}}},tooltip:{callbacks:{label:(ctx)=>fmtTok(ctx.raw)+' tok'}}}});}
}

// ─── Usage Dashboard ───
let usageTimer = null;
async function fetchUsage() {
  try {
    const res = await fetch('/api/usage');
    state.usage = await res.json();
    renderUsage();
    renderCosts();
  } catch {}
}
usageTimer = setInterval(fetchUsage, 60000);

function timeUntil(isoStr) {
  const diff = new Date(isoStr) - new Date();
  if (diff <= 0) return 'now';
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  if (h > 24) { const d = Math.floor(h / 24); return `${d}d ${h % 24}h`; }
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}

function renderUsage() {
  const u = state.usage;
  if (!u) return;
  const t = u.today || {};
  const w = u.week || {};

  // Header badges
  document.getElementById('today-output').textContent = fmtTok(t.outputTokens || 0);
  document.getElementById('today-msgs').textContent = t.messages || 0;
  document.getElementById('stat-today').textContent = fmtTok(t.outputTokens || 0);

  // Today card
  document.getElementById('uc-today-date').textContent = t.date || '';
  document.getElementById('uc-today-output').textContent = fmtTok(t.outputTokens || 0) + ' tok';
  document.getElementById('uc-today-stats').innerHTML = [
    row('Messages', t.messages || 0),
    row('Sessions', t.sessions || 0),
    row('Tool Calls', t.toolCalls || 0),
  ].join('');
  // Today models
  const todayModels = t.models || {};
  const totalOut = t.outputTokens || 1;
  const modelsEl = document.getElementById('uc-today-models');
  const mEntries = Object.entries(todayModels).sort((a, b) => (b[1].outputTokens || 0) - (a[1].outputTokens || 0));
  modelsEl.innerHTML = mEntries.length ? mEntries.map(([name, m]) => {
    const pct = ((m.outputTokens || 0) / totalOut * 100).toFixed(1);
    return `<div class="uc-model-row"><span class="name">${name}</span><span class="val">${fmtTok(m.outputTokens||0)}<span class="pct">(${pct}%)</span></span></div>`;
  }).join('') : '';
  document.getElementById('uc-today-cost').textContent = `API Equiv. ~$${(t.apiEquivCost || 0).toFixed(2)}`;

  // Week card
  document.getElementById('uc-week-output').textContent = fmtTok(w.outputTokens || 0) + ' tok';
  if (w.resetAt) document.getElementById('uc-week-reset').textContent = `resets ${timeUntil(w.resetAt)}`;
  document.getElementById('uc-week-stats').innerHTML = [
    row('Messages', w.messages || 0),
  ].join('');
  const weekModels = w.models || {};
  const wmEl = document.getElementById('uc-week-models');
  const wmEntries = Object.entries(weekModels).sort((a, b) => (b[1].outputTokens || 0) - (a[1].outputTokens || 0));
  wmEl.innerHTML = wmEntries.length ? wmEntries.map(([name, m]) =>
    `<div class="uc-model-row"><span class="name">${name}</span><span class="val">${fmtTok(m.outputTokens||0)}</span></div>`
  ).join('') : '';
  document.getElementById('uc-week-cost').textContent = `API Equiv. ~$${(w.apiEquivCost || 0).toFixed(2)}`;

  // Overview card
  document.getElementById('uc-overview-stats').innerHTML = [
    row('Total Sessions', t.sessions || 0),
    row('Cache Read', fmtTok(t.cacheReadTokens || 0) + ' tok'),
    row('Cache Write', fmtTok(t.cacheCreationTokens || 0) + ' tok'),
    row('Input Tokens', fmtTok(t.inputTokens || 0)),
  ].join('');

  // Plan info — calculate from daily data
  const daily = u.daily || [];
  const allTimeCost = daily.reduce((s, d) => s + (d.totalCost || 0), 0);
  const planEl = document.getElementById('uc-plan-info');
  if (planEl) planEl.textContent = `30-day API equiv: ~$${allTimeCost.toFixed(2)}`;
}

function row(label, val) {
  return `<div class="uc-stat-row"><span class="label">${label}</span><span class="val">${val}</span></div>`;
}

// ─── Settings Panel ───
window.openSettingsPanel = () => {
  renderSettingsProjectList();
  document.getElementById('settings-overlay').classList.add('open');
  document.getElementById('settings-panel').classList.add('open');
};
window.closeSettingsPanel = () => {
  document.getElementById('settings-overlay').classList.remove('open');
  document.getElementById('settings-panel').classList.remove('open');
};
function renderSettingsProjectList() {
  document.getElementById('settings-project-list').innerHTML = projectList.map(p => `
    <div class="spi">
      <div class="spi-color" style="background:${p.color}"></div>
      <div class="spi-info"><div class="spi-name">${esc(p.name)}</div><div class="spi-path">${esc(p.path)}</div></div>
      <div class="spi-actions">
        <button class="btn btn-icon" onclick="editProject('${p.id}')" title="Edit">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn btn-icon" onclick="confirmDeleteProject('${p.id}')" title="Delete" style="color:var(--red)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
        </button>
      </div>
    </div>
  `).join('');
}

window.openAddProjectModal = () => {
  document.getElementById('pm-edit-id').value = '';
  document.getElementById('pm-title').textContent = 'Add Project';
  document.getElementById('pm-name').value = '';
  document.getElementById('pm-path').value = '';
  document.getElementById('pm-stack').value = 'react-next';
  document.getElementById('pm-devcmd').value = '';
  document.getElementById('pm-github').value = '';
  document.getElementById('pm-color').value = '#6366f1';
  document.getElementById('pm-scripts-list').style.display = 'none';
  closeFolderPicker();
  document.getElementById('project-modal').showModal();
};
window.loadPkgScripts = async () => {
  const pathInput = document.getElementById('pm-path').value.trim();
  const list = document.getElementById('pm-scripts-list');
  if (!pathInput) { showToast('Enter project path first', 'error'); return; }
  list.style.display = '';
  list.innerHTML = '<div style="padding:8px 12px;color:var(--text-3);font-size:.78rem">Loading...</div>';
  try {
    const res = await fetch(`/api/scripts-by-path?path=${encodeURIComponent(pathInput)}`);
    const data = await res.json();
    const scripts = data.scripts || {};
    const entries = Object.entries(scripts);
    if (!entries.length) { list.innerHTML = '<div style="padding:8px 12px;color:var(--text-3);font-size:.78rem">No scripts in package.json</div>'; return; }
    list.innerHTML = entries.map(([name, cmd]) =>
      `<div class="pm-script-item" onclick="pickScript(this)" data-cmd="npm run ${name}" style="padding:5px 12px;cursor:pointer;font-size:.78rem;display:flex;justify-content:space-between;gap:8px;transition:background var(--dur)">
        <span style="font-weight:500;color:var(--accent-bright);font-family:var(--mono)">${esc(name)}</span>
        <span style="color:var(--text-3);font-size:.72rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(cmd)}</span>
      </div>`
    ).join('');
  } catch { list.innerHTML = '<div style="padding:8px 12px;color:var(--red);font-size:.78rem">Error loading scripts</div>'; }
};
window.pickScript = (el) => {
  document.getElementById('pm-devcmd').value = el.dataset.cmd;
  document.getElementById('pm-scripts-list').style.display = 'none';
};
window.editProject = (id) => {
  const p = projectList.find(x => x.id === id);
  if (!p) return;
  document.getElementById('pm-edit-id').value = p.id;
  document.getElementById('pm-title').textContent = 'Edit Project';
  document.getElementById('pm-name').value = p.name;
  document.getElementById('pm-path').value = p.path;
  document.getElementById('pm-stack').value = p.stack || 'other';
  document.getElementById('pm-devcmd').value = p.devCmd || '';
  document.getElementById('pm-github').value = p.github || '';
  document.getElementById('pm-color').value = p.color || '#6366f1';
  document.getElementById('project-modal').showModal();
};
window.saveProject = async () => {
  const editId = document.getElementById('pm-edit-id').value;
  const devCmd = document.getElementById('pm-devcmd').value.trim();
  const github = document.getElementById('pm-github').value.trim();
  const data = {
    name: document.getElementById('pm-name').value.trim(),
    path: document.getElementById('pm-path').value.trim(),
    stack: document.getElementById('pm-stack').value,
    color: document.getElementById('pm-color').value,
    devCmd: devCmd || undefined,
    github: github || undefined
  };
  if (!data.name || !data.path) { showToast('Name and path required', 'error'); return; }
  if (editId) {
    await fetch(`/api/projects/${editId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
    showToast('Project updated', 'success');
  } else {
    await fetch('/api/projects', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
    showToast('Project added', 'success');
  }
  document.getElementById('project-modal').close();
  closeFolderPicker();
  await refreshProjectList();
};

// ── Folder Picker ──
let fpCurrentDir = null;
window.toggleFolderPicker = () => {
  const el = document.getElementById('folder-picker');
  if (el.classList.contains('open')) { closeFolderPicker(); return; }
  el.classList.add('open');
  const cur = document.getElementById('pm-path').value.trim().replace(/\\/g, '/');
  browseTo(cur || null);
};
function closeFolderPicker() { document.getElementById('folder-picker').classList.remove('open'); }
async function browseTo(dir) {
  fpCurrentDir = dir;
  const qs = dir ? `?dir=${encodeURIComponent(dir)}` : '';
  try {
    const res = await fetch(`/api/browse${qs}`);
    const data = await res.json();
    if (data.error) { showToast(data.error, 'error'); return; }
    renderBreadcrumb(data.current || null, data.parent);
    const list = document.getElementById('fp-list');
    if (!data.entries.length) {
      list.innerHTML = '<li class="fp-empty">No subfolders</li>';
      return;
    }
    list.innerHTML = data.entries.map(e =>
      `<li class="fp-item" onclick="browseTo('${e.path.replace(/'/g, "\\'")}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>${e.name}</li>`
    ).join('');
  } catch (err) { showToast('Browse failed', 'error'); }
}
window.browseTo = browseTo;
function renderBreadcrumb(current, parent) {
  const bc = document.getElementById('fp-breadcrumb');
  if (!current) { bc.innerHTML = '<span style="color:var(--text-3)">Drives</span>'; return; }
  const parts = current.replace(/\/$/, '').split('/');
  let html = '';
  let acc = '';
  parts.forEach((p, i) => {
    acc += (i === 0 ? p : '/' + p);
    const path = acc + (i === 0 ? '/' : '');
    if (i > 0) html += '<span class="fp-sep">/</span>';
    html += `<span onclick="browseTo('${path.replace(/'/g, "\\'")}')">${p || '/'}</span>`;
  });
  bc.innerHTML = html;
}
window.selectCurrentFolder = () => {
  if (fpCurrentDir) document.getElementById('pm-path').value = fpCurrentDir;
  closeFolderPicker();
};

window.confirmDeleteProject = async (id) => {
  const p = projectList.find(x => x.id === id);
  if (!confirm(`Delete "${p?.name}"? (Dashboard only, not from disk)`)) return;
  await fetch(`/api/projects/${id}`, { method:'DELETE' });
  showToast(`${p?.name} removed`, 'info');
  await refreshProjectList();
};

async function refreshProjectList() {
  const res = await fetch('/api/projects');
  projectList = await res.json();
  renderAllCards(projectList);
  projectList.forEach(p => { if(state.projects.has(p.id)) renderCard(p.id); });
  renderSettingsProjectList();
  populateProjectSelects();
  updateSummaryStats();
}

function populateProjectSelects() {
  const opts = projectList.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
  document.getElementById('diff-project').innerHTML = opts;
  const ntSel = document.getElementById('nt-project');
  if(ntSel) ntSel.innerHTML = opts;
}

// ─── WebSocket Terminal ───
let ws, termMap = new Map(), activeTermId = null;
let layoutRoot = null;
let draggedTermId = null;

const writeBuffers = new Map();
function bufferWrite(t, data, id) {
  if(!id) { t.xterm.write(data); return; }
  let buf = writeBuffers.get(id);
  if(!buf) { buf = { data: '', timer: null }; writeBuffers.set(id, buf); }
  buf.data += data;
  if(!buf.timer) {
    buf.timer = requestAnimationFrame(() => { t.xterm.write(buf.data); buf.data = ''; buf.timer = null; });
  }
}

function saveLayout() {
  try {
    localStorage.setItem('dl-tree', JSON.stringify(layoutRoot));
    const labels = {}; for(const [id, t] of termMap) labels[id] = t.label;
    localStorage.setItem('dl-labels', JSON.stringify(labels));
    if(activeTermId) localStorage.setItem('dl-active', activeTermId);
    const view = document.querySelector('.view.active')?.id?.replace('-view','');
    if(view) localStorage.setItem('dl-view', view);
  } catch {}
}
function restoreSavedLayout() {
  try {
    const saved = JSON.parse(localStorage.getItem('dl-tree'));
    if(!saved) return false;
    function validate(node) {
      if(!node) return false;
      if(node.type === 'leaf') return termMap.has(node.termId);
      if(node.type === 'split') return node.children && validate(node.children[0]) && validate(node.children[1]);
      return false;
    }
    if(!validate(saved)) return false;
    layoutRoot = saved;
    try { const labels = JSON.parse(localStorage.getItem('dl-labels'));
      if(labels) for(const [id, label] of Object.entries(labels)) { const t = termMap.get(id); if(t) t.label = label; }
    } catch {}
    const activeId = localStorage.getItem('dl-active');
    if(activeId && termMap.has(activeId)) activeTermId = activeId;
    return true;
  } catch { return false; }
}

function remapLayoutIds(idMap) {
  try {
    const tree = JSON.parse(localStorage.getItem('dl-tree'));
    if (tree) {
      (function remap(node) {
        if (!node) return;
        if (node.type === 'leaf' && idMap[node.termId]) node.termId = idMap[node.termId];
        if (node.type === 'split') { remap(node.children[0]); remap(node.children[1]); }
      })(tree);
      localStorage.setItem('dl-tree', JSON.stringify(tree));
    }
    const labels = JSON.parse(localStorage.getItem('dl-labels'));
    if (labels) {
      const newLabels = {};
      for (const [oldId, label] of Object.entries(labels)) newLabels[idMap[oldId] || oldId] = label;
      localStorage.setItem('dl-labels', JSON.stringify(newLabels));
    }
    const active = localStorage.getItem('dl-active');
    if (active && idMap[active]) localStorage.setItem('dl-active', idMap[active]);
  } catch {}
}

let _wsBackoff = 1000, _wsReconnTimer = null;
function connectWS() {
  if (_wsReconnTimer) { clearTimeout(_wsReconnTimer); _wsReconnTimer = null; }
  ws = new WebSocket(`ws://${location.host}`);
  ws.onopen = () => { console.log('[WS] connected'); _wsBackoff = 1000; showDisconnectIndicator(false); };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    switch(msg.type) {
      case 'terminals': {
        if (msg.idMap) remapLayoutIds(msg.idMap);
        let added = false;
        msg.active.forEach(t => {
          if(!termMap.has(t.termId)) {
            addTerminal(t.termId, t.projectId, false);
            added = true;
            if(t.buffer) { const tm = termMap.get(t.termId); if(tm) tm.pendingBuffer = t.buffer; }
          }
        });
        if(added) {
          if(!restoreSavedLayout()) { for(const [id] of termMap) { if(!findLeaf(layoutRoot, id)) addToLayoutTree(id); } }
          renderLayout(); updateTermHeaders();
          if (msg.idMap) showToast(`Restored ${msg.active.length} terminal(s)`, 'success');
        }
        break;
      }
      case 'created':
        if(!termMap.has(msg.termId)) addTerminal(msg.termId, msg.projectId, true);
        break;
      case 'output': { const t = termMap.get(msg.termId); if(t) bufferWrite(t, msg.data, msg.termId); break; }
      case 'exit': { const t = termMap.get(msg.termId); if(t) t.xterm.write('\r\n\x1b[90m[Process exited]\x1b[0m\r\n'); break; }
    }
  };
  ws.onerror = (err) => { console.error('[WS] error', err); };
  ws.onclose = () => { showDisconnectIndicator(true); _wsBackoff = Math.min(_wsBackoff * 2, 30000); _wsReconnTimer = setTimeout(connectWS, _wsBackoff); };
}

function addTerminal(termId, projectId, addToView) {
  const project = projectList.find(p => p.id === projectId);
  const color = project?.color || '#666';
  const name = project?.name || projectId;
  const xterm = new Terminal({
    theme: { background:'#08090d', foreground:'#e8e9f0', cursor:'#818cf8',
             selectionBackground:'rgba(129,140,248,.3)',
             black:'#08090d',red:'#f87171',green:'#34d399',yellow:'#fbbf24',
             blue:'#60a5fa',magenta:'#c084fc',cyan:'#22d3ee',white:'#e8e9f0' },
    fontFamily: "'Cascadia Code','JetBrains Mono',monospace",
    fontSize: (typeof termFontSize !== 'undefined' ? termFontSize : 13), cursorBlink: true, allowProposedApi: true,
    scrollback: 5000, fastScrollModifier: 'alt', fastScrollSensitivity: 5
  });
  const fitAddon = new FitAddon.FitAddon();
  xterm.loadAddon(fitAddon);
  xterm.loadAddon(new WebLinksAddon.WebLinksAddon());
  const searchAddon = new SearchAddon.SearchAddon();
  xterm.loadAddon(searchAddon);
  xterm.attachCustomKeyEventHandler(ev => {
    if (ev.type !== 'keydown') return true;
    // Ctrl+C with selection → copy, Ctrl+Shift+C → always copy
    if ((ev.ctrlKey && ev.shiftKey && ev.code === 'KeyC') || (ev.ctrlKey && !ev.shiftKey && ev.key === 'c' && xterm.hasSelection())) {
      const text = xterm.getSelection();
      if (text) {
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.cssText = 'position:fixed;left:-9999px';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        xterm.clearSelection();
      }
      return false;
    }
    // Ctrl+V / Ctrl+Shift+V → paste
    if (ev.ctrlKey && (ev.key === 'v' || ev.key === 'V')) {
      navigator.clipboard.readText().then(t => { if(t && ws?.readyState===1) ws.send(JSON.stringify({type:'input',termId,data:t})); }).catch(() => {});
      return false;
    }
    return true;
  });
  const element = document.createElement('div');
  element.className = 'xterm-wrap';
  xterm.onData(data => { if(ws?.readyState === 1) ws.send(JSON.stringify({ type:'input', termId, data })); });
  termMap.set(termId, { xterm, fitAddon, searchAddon, projectId, element, label: name, color, opened: false, pendingBuffer: null });
  if(addToView) {
    if(window._splitTarget) {
      const st = window._splitTarget; window._splitTarget = null;
      splitAt(st.termId, termId, st.pos);
    } else { addToLayoutTree(termId); }
    activeTermId = termId; updateTermHeaders(); renderLayout();
  }
}

// ─── Layout Tree ───
function addToLayoutTree(termId) {
  if(!layoutRoot) { layoutRoot = { type: 'leaf', termId }; }
  else if(activeTermId && findLeaf(layoutRoot, activeTermId)) { splitAt(activeTermId, termId, 'right'); }
  else { layoutRoot = { type: 'split', dir: 'h', ratio: 0.5, children: [layoutRoot, { type: 'leaf', termId }] }; }
  activeTermId = termId;
}
function findLeaf(node, termId) {
  if(!node) return null;
  if(node.type === 'leaf') return node.termId === termId ? node : null;
  return findLeaf(node.children[0], termId) || findLeaf(node.children[1], termId);
}
function splitAt(targetTermId, newTermId, position) {
  const dir = (position==='left'||position==='right')?'h':'v';
  const newFirst = (position==='left'||position==='top');
  function replace(node) {
    if(node.type==='leaf'&&node.termId===targetTermId) return{type:'split',dir,ratio:0.5,children:newFirst?[{type:'leaf',termId:newTermId},{type:'leaf',termId:targetTermId}]:[{type:'leaf',termId:targetTermId},{type:'leaf',termId:newTermId}]};
    if(node.type==='split') return{...node,children:[replace(node.children[0]),replace(node.children[1])]};
    return node;
  }
  layoutRoot = replace(layoutRoot);
}
function removeFromLayoutTree(termId) {
  if(!layoutRoot) return;
  if(layoutRoot.type==='leaf'){if(layoutRoot.termId===termId)layoutRoot=null;return;}
  function collapse(node) {
    if(node.type!=='split') return node;
    for(let i=0;i<2;i++){if(node.children[i].type==='leaf'&&node.children[i].termId===termId) return node.children[1-i];}
    return{...node,children:[collapse(node.children[0]),collapse(node.children[1])]};
  }
  layoutRoot = collapse(layoutRoot);
}

// ─── Layout Rendering ───
function renderLayout() {
  const container = document.getElementById('term-panels');
  for(const [, t] of termMap) { if(t.element.parentNode) t.element.parentNode.removeChild(t.element); }
  container.innerHTML = '';
  if(!layoutRoot) { container.innerHTML = '<div class="term-empty"><button class="btn" onclick="openNewTermModal()">+ New Terminal</button></div>'; return; }
  renderNode(layoutRoot, container);
  _headCache.clear(); // DOM was rebuilt — force header re-render
  updateTermHeaders();
  requestAnimationFrame(() => {
    for(const [termId, t] of termMap) {
      if(!t.opened && t.element.parentNode) {
        t.xterm.open(t.element);
        try { t.xterm.loadAddon(new WebglAddon.WebglAddon()); } catch {}
        t.opened = true;
        if(t.pendingBuffer) { t.xterm.write(t.pendingBuffer); t.pendingBuffer = null; }
      }
    }
    // Single deferred fit after layout stabilizes
    setTimeout(fitAllTerminals, 120);
  });
  saveLayout();
}

// Event delegation: one set of listeners on #term-panels instead of per-node
const _termPanels = document.getElementById('term-panels');
_termPanels.addEventListener('mousedown', e => {
  const leaf = e.target.closest('.split-leaf');
  if (leaf) { activeTermId = leaf.dataset.termId; updateTermHeaders(); }
});
_termPanels.addEventListener('contextmenu', e => {
  const leaf = e.target.closest('.split-leaf');
  if (leaf) { e.preventDefault(); e.stopPropagation(); showTermCtxMenu(e, leaf.dataset.termId); }
}, true);
_termPanels.addEventListener('dragstart', e => {
  const head = e.target.closest('.term-head');
  if (!head) return;
  const tid = head.dataset.termId;
  draggedTermId = tid; head.style.cursor='grabbing';
  e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', tid);
  requestAnimationFrame(()=>{document.querySelectorAll('.split-leaf').forEach(l=>{if(l.dataset.termId!==tid)l.classList.add('drag-over');});});
});
_termPanels.addEventListener('dragend', e => {
  const head = e.target.closest('.term-head');
  if (head) head.style.cursor='grab';
  draggedTermId=null;
  document.querySelectorAll('.split-leaf').forEach(l=>l.classList.remove('drag-over'));
  document.querySelectorAll('.drop-zone').forEach(z=>z.classList.remove('active'));
});
_termPanels.addEventListener('dragover', e => {
  const zone = e.target.closest('.drop-zone');
  if (zone) { e.preventDefault(); e.dataTransfer.dropEffect='move'; zone.classList.add('active'); }
});
_termPanels.addEventListener('dragleave', e => {
  const zone = e.target.closest('.drop-zone');
  if (zone) zone.classList.remove('active');
});
_termPanels.addEventListener('drop', e => {
  const zone = e.target.closest('.drop-zone');
  if (!zone) return;
  e.preventDefault(); zone.classList.remove('active');
  const leaf = zone.closest('.split-leaf');
  if (leaf) leaf.classList.remove('drag-over');
  const targetId = leaf?.dataset.termId;
  const pos = ['top','bottom','left','right'].find(p => zone.classList.contains(p));
  if (draggedTermId && targetId && draggedTermId !== targetId && pos) {
    removeFromLayoutTree(draggedTermId); splitAt(targetId, draggedTermId, pos);
    activeTermId = draggedTermId; renderLayout(); updateTermHeaders();
  }
});

function renderNode(node, container) {
  if(node.type === 'leaf') {
    const t = termMap.get(node.termId); if(!t) return;
    const leaf = document.createElement('div');
    leaf.className = 'split-leaf'; leaf.dataset.termId = node.termId;
    leaf.style.display='flex'; leaf.style.flexDirection='column';
    const head = document.createElement('div'); head.className = 'term-head';
    head.draggable = true; head.dataset.termId = node.termId; head.style.cursor='grab';
    leaf.appendChild(head);
    leaf.appendChild(t.element);
    const overlay = document.createElement('div'); overlay.className = 'drop-overlay';
    ['top','bottom','left','right'].forEach(pos => {
      const zone = document.createElement('div'); zone.className = `drop-zone ${pos}`;
      overlay.appendChild(zone);
    });
    leaf.appendChild(overlay); container.appendChild(leaf); return;
  }
  const splitEl = document.createElement('div');
  splitEl.className = `split-container ${node.dir==='h'?'horizontal':'vertical'}`;
  const prop = node.dir==='h'?'width':'height';
  const first = document.createElement('div'); first.className = 'split-child';
  first.style[prop] = `calc(${node.ratio*100}% - 2px)`; first.style[node.dir==='h'?'height':'width']='100%';
  renderNode(node.children[0], first); splitEl.appendChild(first);
  const divider = document.createElement('div'); divider.className = `split-divider ${node.dir==='h'?'h':'v'}`;
  divider.addEventListener('mousedown', e => startDividerDrag(e, node, splitEl)); splitEl.appendChild(divider);
  const second = document.createElement('div'); second.className = 'split-child';
  second.style[prop] = `calc(${(1-node.ratio)*100}% - 2px)`; second.style[node.dir==='h'?'height':'width']='100%';
  renderNode(node.children[1], second); splitEl.appendChild(second);
  container.appendChild(splitEl);
}

function startDividerDrag(e, node, splitEl) {
  e.preventDefault();
  const isH = node.dir==='h';
  const rect = splitEl.getBoundingClientRect();
  const totalSize = isH?rect.width:rect.height;
  const firstChild = splitEl.children[0], secondChild = splitEl.children[2];
  const prop = isH?'width':'height';
  const cover = document.createElement('div');
  cover.style.cssText = 'position:fixed;inset:0;z-index:9999;cursor:'+(isH?'col-resize':'row-resize');
  document.body.appendChild(cover); document.body.style.cursor = isH?'col-resize':'row-resize'; document.body.style.userSelect='none';
  const onMove = (e) => {
    const pos = isH?(e.clientX-rect.left):(e.clientY-rect.top);
    const ratio = Math.max(0.08,Math.min(0.92,pos/totalSize));
    node.ratio = ratio;
    firstChild.style[prop] = `calc(${ratio*100}% - 2px)`;
    secondChild.style[prop] = `calc(${(1-ratio)*100}% - 2px)`;
    debouncedFit();
  };
  const onUp = () => {
    document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp);
    document.body.style.cursor=''; document.body.style.userSelect=''; cover.remove();
    fitAllTerminals(); saveLayout();
  };
  document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
}

// ─── Per-terminal headers ───
const _headCache = new Map();
let _termHeaderTimer = null;
function debouncedUpdateTermHeaders() {
  if (_termHeaderTimer) return;
  _termHeaderTimer = requestAnimationFrame(() => { _termHeaderTimer = null; updateTermHeaders(); });
}
function updateTermHeaders() {
  document.querySelectorAll('.split-leaf').forEach(leaf => {
    const tid = leaf.dataset.termId;
    const t = termMap.get(tid); if(!t) return;
    leaf.classList.toggle('active', tid === activeTermId);
    let head = leaf.querySelector('.term-head');
    if(!head){ head = document.createElement('div'); head.className='term-head'; leaf.insertBefore(head, leaf.firstChild); }
    const g = state.projects.get(t.projectId)?.git || {};
    const s = state.projects.get(t.projectId)?.session || {};
    const model = s.model ? s.model.replace('claude-','').replace(/-\d{8}$/,'') : '';
    const wt = (g.worktrees||[]).filter(w=>!w.bare);
    // Cache key: skip rebuild if nothing changed
    const cacheKey = `${t.label}|${t.color}|${g.branch||''}|${g.uncommittedCount||0}|${model}|${wt.length}|${tid===activeTermId}`;
    if (_headCache.get(tid) === cacheKey) return;
    _headCache.set(tid, cacheKey);
    const p = projectList.find(pp => pp.id === t.projectId);
    const pPath = (p?.path || '').replace(/\\/g, '/');
    const currentWt = wt.find(w => w.path === pPath || pPath.endsWith(w.path));
    let wtTag = '';
    if (wt.length > 1) {
      const wtName = currentWt ? currentWt.path.split('/').pop() : wt[0].path.split('/').pop();
      const popoverItems = wt.map(w => {
        const isCur = w === currentWt;
        return `<div class="wt-popover-item${isCur?' wt-current':''}"><span class="wt-branch">${esc(w.branch||'?')}${isCur?' \u2190':''}</span><span class="wt-path">${esc(w.path)}</span></div>`;
      }).join('');
      wtTag = `<span class="th-tag th-worktree">${esc(wtName)} <span style="opacity:.5">+${wt.length-1}</span><div class="wt-popover">${popoverItems}</div></span>`;
    }
    head.innerHTML = `<span class="th-dot" style="background:${t.color}"></span>`
      + `<span class="th-name">${esc(t.label)}</span>`
      + (g.branch?`<span class="th-tag th-branch">${g.branch}</span>`:'')
      + wtTag
      + (g.uncommittedCount?`<span class="th-tag th-changes" data-pid="${t.projectId}">\u00B1${g.uncommittedCount}</span>`:'')
      + (model?`<span class="th-tag th-model">${model}</span>`:'')
      + `<span class="th-spacer"></span>`
      + `<button class="th-close" data-action="close" title="Close">\u00d7</button>`;
    head.onclick = e => {
      if(e.target.dataset.action==='close'){ e.stopPropagation(); closeTerminal(tid); return; }
      if(e.target.classList.contains('th-changes')){ e.stopPropagation(); showDiffDialog(e.target.dataset.pid); return; }
    };
  });
}
function startRenameHeader(termId, headEl) {
  const t = termMap.get(termId); if(!t) return;
  const nameSpan = headEl.querySelector('.th-name');
  const input = document.createElement('input');
  input.type='text'; input.value=t.label;
  input.style.cssText='font-size:.68rem;padding:1px 4px;background:var(--bg-0);border:1px solid var(--accent);color:var(--text-1);border-radius:3px;width:100px;';
  const finish = () => { const val=input.value.trim(); if(val) t.label=val; updateTermHeaders(); saveLayout(); };
  input.addEventListener('keydown', e => { if(e.key==='Enter')finish(); if(e.key==='Escape')updateTermHeaders(); e.stopPropagation(); });
  input.addEventListener('blur', finish);
  nameSpan.replaceWith(input); input.focus(); input.select();
}
// ─── Context Menu ───
function showTermCtxMenu(e, termId) {
  const menu = document.getElementById('term-ctx-menu');
  const t = termMap.get(termId); if(!t) return;
  const g = state.projects.get(t.projectId)?.git || {};
  const hasChanges = g.uncommittedCount > 0;
  menu.innerHTML = `
    <div class="ctx-menu-item" data-act="rename"><span class="ctx-icon">A</span>Rename</div>
    <div class="ctx-menu-item" data-act="new"><span class="ctx-icon">+</span>New Terminal<span style="margin-left:auto" class="kbd">Ctrl+T</span></div>
    <div class="ctx-menu-item" data-act="search"><span class="ctx-icon">\u{1F50D}</span>Search<span style="margin-left:auto" class="kbd">Ctrl+F</span></div>
    <div class="ctx-sep ctx-menu-sep"></div>
    <div class="ctx-menu-item" data-act="split-h"><span class="ctx-icon">\u2194</span>Split Right</div>
    <div class="ctx-menu-item" data-act="split-v"><span class="ctx-icon">\u2195</span>Split Down</div>
    <div class="ctx-sep ctx-menu-sep"></div>
    ${hasChanges?`<div class="ctx-menu-item" data-act="diff"><span class="ctx-icon">\u00B1</span>View Changes (${g.uncommittedCount})</div>`:''}
    <div class="ctx-menu-item" data-act="ide"><span class="ctx-icon">&lt;/&gt;</span>Open in IDE</div>
    <div class="ctx-sep ctx-menu-sep"></div>
    <div class="ctx-menu-item danger" data-act="close"><span class="ctx-icon">\u00d7</span>Close Terminal<span style="margin-left:auto" class="kbd">Ctrl+W</span></div>
  `;
  // position
  menu.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
  menu.style.top = Math.min(e.clientY, window.innerHeight - 250) + 'px';
  menu.classList.add('show');
  // actions
  menu.onclick = ev => {
    const item = ev.target.closest('[data-act]'); if(!item) return;
    menu.classList.remove('show');
    switch(item.dataset.act) {
      case 'rename': { const leaf = document.querySelector(`.split-leaf[data-term-id="${termId}"]`); const head = leaf?.querySelector('.term-head'); if(head) startRenameHeader(termId, head); break; }
      case 'new': openNewTermModal(); break;
      case 'search': activeTermId = termId; toggleTermSearch(); break;
      case 'split-h': { const newId = '__pending_split_h_' + termId; openNewTermModalWithSplit(termId, 'right'); break; }
      case 'split-v': { openNewTermModalWithSplit(termId, 'bottom'); break; }
      case 'diff': showDiffDialog(t.projectId); break;
      case 'ide': openInIDE(t.projectId); break;
      case 'close': closeTerminal(termId); break;
    }
  };
  const dismiss = () => { menu.classList.remove('show'); document.removeEventListener('click', dismiss); document.removeEventListener('keydown', onKey); window.removeEventListener('scroll', dismiss, true); };
  const onKey = ev => { if(ev.key==='Escape') dismiss(); };
  setTimeout(() => { document.addEventListener('click', dismiss); document.addEventListener('keydown', onKey); window.addEventListener('scroll', dismiss, true); }, 0);
}
function openNewTermModalWithSplit(targetTermId, pos) {
  const sel = document.getElementById('nt-project');
  sel.innerHTML = projectList.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  document.getElementById('new-term-modal').showModal();
  // override createTerminal to split at target
  window._splitTarget = { termId: targetTermId, pos };
}
function openInIDE(projectId) {
  fetch(`/api/projects/${projectId}/open-ide`, { method:'POST', headers:{'Content-Type':'application/json'}, body:'{}' }).catch(()=>{});
}

async function showDiffDialog(projectId) {
  const dlg = document.getElementById('diff-dialog');
  const nav = document.getElementById('diff-file-nav');
  const panels = document.getElementById('diff-dialog-panels');
  const project = projectList.find(p => p.id === projectId);
  document.getElementById('diff-dialog-title').textContent = `Changes \u2014 ${project?.name || projectId}`;
  panels.innerHTML = '<div style="padding:30px;text-align:center;color:var(--text-3)">Loading\u2026</div>';
  nav.innerHTML = '';
  dlg.showModal();
  try {
    const res = await fetch(`/api/projects/${projectId}/diff`);
    const data = await res.json();
    const stagedFiles = data.staged?.files || [];
    const unstagedFiles = data.unstaged?.files || [];
    const stagedDiff = data.staged?.diff || '';
    const unstagedDiff = data.unstaged?.diff || '';

    if (!stagedFiles.length && !unstagedFiles.length) {
      panels.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-3)">No changes</div>';
      return;
    }

    renderDiffSummary('diff-dialog-summary', stagedFiles, unstagedFiles);

    // File nav chips
    const allFiles = [
      ...stagedFiles.map(f => ({ ...f, section: 'staged' })),
      ...unstagedFiles.map(f => ({ ...f, section: 'unstaged' }))
    ];
    const statusColor = s => { const c = fileStatusLetter(s); return c==='A'?'var(--green)':c==='D'?'var(--red)':c==='R'?'var(--blue)':'var(--yellow)'; };
    nav.innerHTML = allFiles.map(f => {
      const pid = `dlg-dp-${f.section}-${f.file.replace(/[^a-zA-Z0-9]/g,'_')}`;
      const name = f.file.includes('/') ? f.file.substring(f.file.lastIndexOf('/') + 1) : f.file;
      return `<span class="diff-file-chip" data-panel="${pid}"><span class="fc-dot" style="background:${statusColor(f.status)}"></span>${esc(name)}</span>`;
    }).join('');

    nav.onclick = e => {
      const chip = e.target.closest('.diff-file-chip');
      if (!chip) return;
      const el = document.getElementById(chip.dataset.panel);
      if (el) { el.classList.remove('collapsed'); el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
    };

    // Render panels with 'dlg-dp' prefix to avoid ID collision with main view
    renderDiffPanels('diff-dialog-panels', stagedFiles, unstagedFiles, stagedDiff, unstagedDiff, 'dlg-dp');
  } catch {
    panels.innerHTML = '<div style="padding:30px;text-align:center;color:var(--red)">Error loading diff</div>';
  }
}
function closeTerminal(id) {
  const t = termMap.get(id);
  if(t) { if(ws?.readyState===1) ws.send(JSON.stringify({type:'kill',termId:id})); t.xterm.dispose(); t.element.remove(); termMap.delete(id); }
  const wb = writeBuffers.get(id); if(wb) { if(wb.timer) cancelAnimationFrame(wb.timer); writeBuffers.delete(id); }
  _headCache.delete(id);
  removeFromLayoutTree(id);
  if(activeTermId===id){const first=termMap.keys().next().value;activeTermId=first||null;}
  renderLayout(); updateTermHeaders();
}
window.closeTerminal = closeTerminal;
let fitDebounce = null;
function fitAllTerminals() {
  for(const [termId,t] of termMap) {
    if(t.opened&&t.element.parentNode) {
      try{t.fitAddon.fit();}catch{}
      if(ws?.readyState===1) ws.send(JSON.stringify({type:'resize',termId,cols:t.xterm.cols,rows:t.xterm.rows}));
    }
  }
}
function debouncedFit() { clearTimeout(fitDebounce); fitDebounce = setTimeout(fitAllTerminals, 80); }
window.addEventListener('resize', debouncedFit);
// Observe terminal panel resizes
const termPanelsObs = new ResizeObserver(debouncedFit);
termPanelsObs.observe(document.getElementById('term-panels'));

window.openNewTermModal = () => {
  const sel = document.getElementById('nt-project');
  sel.innerHTML = projectList.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  document.getElementById('new-term-modal').showModal();
  loadBranchesForTerm();
};
window.createTerminal = () => {
  const projectId = document.getElementById('nt-project').value;
  let cmd = document.getElementById('nt-cmd').value;
  document.getElementById('new-term-modal').close();
  const msg = { type:'create', projectId, command: cmd || undefined, cols:120, rows:30 };
  if (_selectedBranch) {
    if (_selectedBranch.type === 'worktree' && _selectedBranch.cwd) {
      msg.cwd = _selectedBranch.cwd;
    } else if (_selectedBranch.type === 'local') {
      const checkout = `git checkout ${_selectedBranch.value}`;
      msg.command = cmd ? `${checkout} && ${cmd}` : checkout;
    } else if (_selectedBranch.type === 'remote') {
      const localName = _selectedBranch.value.replace(/^[^/]+\//, '');
      const checkout = `git checkout -b ${localName} ${_selectedBranch.value} 2>/dev/null || git checkout ${localName}`;
      msg.command = cmd ? `${checkout} && ${cmd}` : checkout;
    }
  }
  _selectedBranch = null;
  ws.send(JSON.stringify(msg));
  switchView('terminal');
};
window.openTermWith = (projectId, cmd) => {
  ws.send(JSON.stringify({type:'create',projectId,command:cmd||undefined,cols:120,rows:30}));
  switchView('terminal');
};

// ─── IDE ───
window.openIDE = async (projectId, ide) => {
  await fetch(`/api/projects/${projectId}/open-ide`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ide})});
};
window.openGitHub = (projectId) => {
  const proj = projectList.find(p => p.id === projectId);
  const g = state.projects.get(projectId)?.git || {};
  const url = proj?.github || g.remoteUrl || '';
  if (url) window.open(url, '_blank');
};

// ─── Diff Utilities ───
function parseDiffToFiles(diffText) {
  if (!diffText || !diffText.trim()) return [];
  const chunks = diffText.split(/(?=^diff --git )/m);
  return chunks.filter(c => c.startsWith('diff ')).map(chunk => {
    const lines = chunk.split('\n');
    const m = lines[0].match(/b\/(.+)$/);
    return { path: m ? m[1] : '?', lines };
  });
}

function renderDiffTable(lines) {
  let oldN = 0, newN = 0;
  const rows = [];
  for (const line of lines) {
    if (line.startsWith('diff ') || line.startsWith('index ')) continue;
    if (line.startsWith('---') || line.startsWith('+++')) continue;
    const hunkMatch = line.match(/^@@ -(\d+)(?:,\d+)? \+(\d+)/);
    if (hunkMatch) {
      oldN = parseInt(hunkMatch[1], 10);
      newN = parseInt(hunkMatch[2], 10);
      rows.push(`<tr class="dl-hunk"><td class="dl-gutter" colspan="2"></td><td class="dl-code">${esc(line)}</td></tr>`);
      continue;
    }
    if (line.startsWith('+')) {
      rows.push(`<tr class="dl-add"><td class="dl-gutter"></td><td class="dl-gutter dl-gutter-new">${newN}</td><td class="dl-code">${esc(line)}</td></tr>`);
      newN++;
    } else if (line.startsWith('-')) {
      rows.push(`<tr class="dl-del"><td class="dl-gutter">${oldN}</td><td class="dl-gutter dl-gutter-new"></td><td class="dl-code">${esc(line)}</td></tr>`);
      oldN++;
    } else if (line !== '') {
      rows.push(`<tr class="dl-ctx"><td class="dl-gutter">${oldN}</td><td class="dl-gutter dl-gutter-new">${newN}</td><td class="dl-code">${esc(line)}</td></tr>`);
      oldN++; newN++;
    }
  }
  return `<table>${rows.join('')}</table>`;
}

function fileStatusLetter(status) {
  if (!status) return 'M';
  const s = status.charAt(0).toUpperCase();
  if (s === 'A') return 'A';
  if (s === 'D') return 'D';
  if (s === 'R') return 'R';
  return 'M';
}

function buildDiffPanel(filePath, fileInfo, sectionType, panelId) {
  const st = fileStatusLetter(fileInfo?.status);
  const dir = filePath.includes('/') ? filePath.substring(0, filePath.lastIndexOf('/') + 1) : '';
  const name = filePath.includes('/') ? filePath.substring(filePath.lastIndexOf('/') + 1) : filePath;
  const add = fileInfo?.additions || 0;
  const del = fileInfo?.deletions || 0;
  const badge = sectionType === 'staged'
    ? '<span class="dp-badge staged">Staged</span>'
    : '<span class="dp-badge unstaged">Unstaged</span>';
  const efn = esc(filePath).replace(/'/g, "\\'");
  const isStaged = sectionType === 'staged';
  let actionsHtml = '<span class="dp-actions">';
  if (!isStaged) {
    actionsHtml += `<button class="dp-action" onclick="event.stopPropagation();diffDiscardFile('${efn}')" title="Discard changes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 105.64-8.36L1 10"/></svg></button>`;
    actionsHtml += `<button class="dp-action" onclick="event.stopPropagation();diffStageFile('${efn}')" title="Stage file"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg></button>`;
  } else {
    actionsHtml += `<button class="dp-action" onclick="event.stopPropagation();diffUnstageFile('${efn}')" title="Unstage file"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg></button>`;
  }
  actionsHtml += '</span>';
  return `<div class="diff-panel" id="${panelId}" data-file="${esc(filePath)}" data-section="${sectionType}">
    <div class="diff-panel-head" onclick="this.parentElement.classList.toggle('collapsed')">
      <span class="dp-chevron">▼</span>
      <span class="dp-status st-${st}">${st}</span>
      <span class="dp-path"><span class="dp-dir">${esc(dir)}</span>${esc(name)}</span>
      <span class="dp-stat">${add ? `<span class="ps-add">+${add}</span>` : ''}${del ? `<span class="ps-del">-${del}</span>` : ''}</span>
      ${badge}
      ${actionsHtml}
    </div>
    <div class="diff-panel-body"></div>
  </div>`;
}

function renderDiffSummary(targetId, stagedFiles, unstagedFiles) {
  const el = document.getElementById(targetId);
  if (!el) return;
  const total = stagedFiles.length + unstagedFiles.length;
  const totalAdd = [...stagedFiles, ...unstagedFiles].reduce((s, f) => s + (f.additions || 0), 0);
  const totalDel = [...stagedFiles, ...unstagedFiles].reduce((s, f) => s + (f.deletions || 0), 0);
  if (!total) { el.innerHTML = ''; return; }
  el.innerHTML = `<span class="ds-files">${total} file${total > 1 ? 's' : ''}</span>`
    + (totalAdd ? `<span class="ds-add">+${totalAdd}</span>` : '')
    + (totalDel ? `<span class="ds-del">\u2212${totalDel}</span>` : '');
}

function renderDiffSidebar(stagedFiles, unstagedFiles, allParsed) {
  const sb = document.getElementById('diff-sidebar-list');
  if (!sb) return;
  const buildGroup = (label, files, section) => {
    if (!files.length) return '';
    const isStaged = section === 'staged';
    const actionIcon = isStaged
      ? `<button class="ds-action" onclick="event.stopPropagation();diffUnstageAll()" title="Unstage All"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg></button>`
      : `<button class="ds-action" onclick="event.stopPropagation();diffStageAll()" title="Stage All"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg></button>`;
    const discardIcon = !isStaged
      ? `<button class="ds-action" onclick="event.stopPropagation();diffDiscardAll()" title="Discard All"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>`
      : '';
    let html = `<div class="ds-group" data-section="${section}"><div class="ds-group-head"><span class="ds-chevron">▼</span>${label}<span class="ds-count">${files.length}</span><span class="ds-actions">${discardIcon}${actionIcon}</span></div><div class="ds-group-items">`;
    for (const f of files) {
      const st = fileStatusLetter(f.status);
      const name = f.file.includes('/') ? f.file.substring(f.file.lastIndexOf('/') + 1) : f.file;
      const pid = `dp-${section}-${f.file.replace(/[^a-zA-Z0-9]/g,'_')}`;
      const efn = esc(f.file).replace(/'/g, "\\'");
      const stageBtn = isStaged
        ? `<button class="fi-action fa-unstage" onclick="event.stopPropagation();diffUnstageFile('${efn}')" title="Unstage"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg></button>`
        : `<button class="fi-action fa-stage" onclick="event.stopPropagation();diffStageFile('${efn}')" title="Stage"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg></button>`;
      const discardBtn = !isStaged
        ? `<button class="fi-action fa-discard" onclick="event.stopPropagation();diffDiscardFile('${efn}')" title="Discard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 105.64-8.36L1 10"/></svg></button>`
        : '';
      html += `<div class="diff-file-item" data-panel="${pid}" data-file="${esc(f.file)}" onclick="scrollToDiffPanel('${pid}')">
        <span class="fi-status st-${st}">${st}</span>
        <span class="fi-name" title="${esc(f.file)}">${esc(name)}</span>
        <span class="fi-stat">${f.additions ? `<span class="fs-add">+${f.additions}</span>` : ''}${f.deletions ? `<span class="fs-del">-${f.deletions}</span>` : ''}</span>
        <span class="fi-actions">${discardBtn}${stageBtn}</span>
      </div>`;
    }
    html += '</div></div>';
    return html;
  };
  sb.innerHTML = buildGroup('Staged', stagedFiles, 'staged')
    + buildGroup('Unstaged', unstagedFiles, 'unstaged');

  sb.querySelectorAll('.ds-group-head').forEach(h => {
    h.addEventListener('click', (e) => {
      if (e.target.closest('.ds-action')) return;
      h.parentElement.classList.toggle('collapsed');
    });
  });

  updateCommitBar(stagedFiles.length);
}

function renderDiffPanels(targetId, stagedFiles, unstagedFiles, stagedDiff, unstagedDiff, prefix = 'dp') {
  const container = document.getElementById(targetId);
  if (!container) return;
  const stagedParsed = parseDiffToFiles(stagedDiff);
  const unstagedParsed = parseDiffToFiles(unstagedDiff);
  let html = '';

  if (stagedFiles.length) {
    html += `<div class="diff-section-label"><span class="dsl-dot" style="background:var(--accent)"></span>Staged</div>`;
    for (const f of stagedFiles) {
      const pid = `${prefix}-staged-${f.file.replace(/[^a-zA-Z0-9]/g,'_')}`;
      html += buildDiffPanel(f.file, f, 'staged', pid);
    }
  }
  if (unstagedFiles.length) {
    html += `<div class="diff-section-label"><span class="dsl-dot" style="background:var(--yellow)"></span>Unstaged</div>`;
    for (const f of unstagedFiles) {
      const pid = `${prefix}-unstaged-${f.file.replace(/[^a-zA-Z0-9]/g,'_')}`;
      html += buildDiffPanel(f.file, f, 'unstaged', pid);
    }
  }
  container.innerHTML = html;

  // Now render tables into panel bodies
  const renderBodies = (parsed, section) => {
    for (const p of parsed) {
      const f = (section === 'staged' ? stagedFiles : unstagedFiles).find(x => x.file === p.path || p.path.endsWith(x.file));
      const pid = `${prefix}-${section}-${(f?.file || p.path).replace(/[^a-zA-Z0-9]/g,'_')}`;
      const panel = document.getElementById(pid);
      if (panel) {
        panel.querySelector('.diff-panel-body').innerHTML = renderDiffTable(p.lines);
      }
    }
  };
  renderBodies(stagedParsed, 'staged');
  renderBodies(unstagedParsed, 'unstaged');
}

window.scrollToDiffPanel = (pid) => {
  const el = document.getElementById(pid);
  if (!el) return;
  el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  // highlight in sidebar
  document.querySelectorAll('.diff-file-item.active').forEach(x => x.classList.remove('active'));
  document.querySelector(`.diff-file-item[data-panel="${pid}"]`)?.classList.add('active');
  // ensure panel is expanded
  el.classList.remove('collapsed');
};

window.loadDiff = async () => {
  const sel = document.getElementById('diff-project');
  const projectId = sel.value; if (!projectId) return;
  const mainEl = document.getElementById('diff-main');
  mainEl.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-3)">Loading...</div>';
  updateDiffBranchInfo();

  try {
    const res = await fetch(`/api/projects/${projectId}/diff`);
    const data = await res.json();
    const stagedFiles = data.staged?.files || [];
    const unstagedFiles = data.unstaged?.files || [];
    const stagedDiff = data.staged?.diff || '';
    const unstagedDiff = data.unstaged?.diff || '';

    if (!stagedFiles.length && !unstagedFiles.length) {
      mainEl.innerHTML = '';
      mainEl.appendChild(createDiffEmpty());
      document.getElementById('diff-sidebar-list').innerHTML = '';
      renderDiffSummary('diff-summary', [], []);
      updateCommitBar(0);
      return;
    }

    renderDiffSummary('diff-summary', stagedFiles, unstagedFiles);
    renderDiffSidebar(stagedFiles, unstagedFiles);
    mainEl.innerHTML = '';
    const panelsDiv = document.createElement('div');
    panelsDiv.id = 'diff-panels-inner';
    panelsDiv.className = 'diff-main-inner';
    mainEl.appendChild(panelsDiv);
    renderDiffPanels('diff-panels-inner', stagedFiles, unstagedFiles, stagedDiff, unstagedDiff);
  } catch {
    mainEl.innerHTML = '<div style="padding:40px;text-align:center;color:var(--red)">Error loading diff</div>';
  }
};

function createDiffEmpty() {
  const d = document.createElement('div');
  d.className = 'diff-empty';
  d.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>
    <span class="de-title">No changes</span>
    <span class="de-sub">Working tree is clean</span>`;
  return d;
}

// ─── Diff Actions: Stage / Unstage / Discard ───
function _diffProjectId() {
  return document.getElementById('diff-project')?.value;
}

async function _diffGitAction(action, files) {
  const projectId = _diffProjectId();
  if (!projectId) return;
  try {
    const res = await fetch(`/api/projects/${projectId}/git/${action}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ files })
    });
    const data = await res.json();
    if (data.error) { showToast(data.error, 'error'); return; }
    loadDiff();
  } catch (err) { showToast(`${action} failed: ${err.message}`, 'error'); }
}

window.diffStageFile = (file) => _diffGitAction('stage', [file]);
window.diffUnstageFile = (file) => _diffGitAction('unstage', [file]);
window.diffDiscardFile = (file) => {
  if (!confirm(`Discard changes to "${file}"? This cannot be undone.`)) return;
  _diffGitAction('discard', [file]);
};
window.diffStageAll = () => _diffGitAction('stage', ['--all']);
window.diffUnstageAll = () => _diffGitAction('unstage', ['--all']);
window.diffDiscardAll = () => {
  if (!confirm('Discard ALL unstaged changes? This cannot be undone.')) return;
  const items = document.querySelectorAll('.ds-group[data-section="unstaged"] .diff-file-item');
  const files = [...items].map(el => el.dataset.file).filter(Boolean);
  if (files.length) _diffGitAction('discard', files);
};

// ─── Expand / Collapse All ───
window.diffExpandAll = () => {
  document.querySelectorAll('#diff-main .diff-panel.collapsed').forEach(p => p.classList.remove('collapsed'));
};
window.diffCollapseAll = () => {
  document.querySelectorAll('#diff-main .diff-panel:not(.collapsed)').forEach(p => p.classList.add('collapsed'));
};

// ─── Sidebar File Search ───
window.filterDiffFiles = () => {
  const q = (document.getElementById('diff-file-search')?.value || '').toLowerCase().trim();
  document.querySelectorAll('#diff-sidebar-list .diff-file-item').forEach(el => {
    const file = (el.dataset.file || '').toLowerCase();
    el.style.display = !q || file.includes(q) ? '' : 'none';
  });
  // Also filter panels in main area
  document.querySelectorAll('#diff-main .diff-panel').forEach(el => {
    const file = (el.dataset.file || '').toLowerCase();
    el.style.display = !q || file.includes(q) ? '' : 'none';
  });
};

// ─── Commit Box (in sidebar) ───
let _diffStagedCount = 0;
function updateCommitBar(stagedCount) {
  _diffStagedCount = stagedCount;
  const info = document.getElementById('dcb-staged-info');
  const btn = document.getElementById('dcb-commit-btn');
  if (!info) return;
  if (stagedCount > 0) {
    info.textContent = `${stagedCount} staged`;
    btn.disabled = false;
  } else {
    info.textContent = 'No staged files';
    btn.disabled = true;
  }
}

window.doManualCommit = async () => {
  const msg = document.getElementById('diff-commit-msg')?.value?.trim();
  if (!msg) { showToast('Enter a commit message', 'info'); document.getElementById('diff-commit-msg')?.focus(); return; }
  const projectId = _diffProjectId();
  if (!projectId) return;
  const btn = document.getElementById('dcb-commit-btn');
  btn.disabled = true;
  const origHTML = btn.innerHTML;
  btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:acSpin 1s linear infinite;width:13px;height:13px"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>Committing...';
  try {
    const res = await fetch(`/api/projects/${projectId}/git/commit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg })
    });
    const data = await res.json();
    if (data.error) {
      showToast('Commit failed: ' + data.error, 'error');
    } else {
      showToast('Committed: ' + msg, 'success');
      document.getElementById('diff-commit-msg').value = '';
    }
    loadDiff();
  } catch (err) {
    showToast('Commit error: ' + err.message, 'error');
  }
  btn.disabled = false;
  btn.innerHTML = origHTML;
};

// ─── AI Commit Message Generator ───
window.generateCommitMsg = async () => {
  const projectId = _diffProjectId();
  if (!projectId) return;
  const btn = document.getElementById('dcb-ai-btn');
  const textarea = document.getElementById('diff-commit-msg');
  if (!btn || !textarea) return;

  btn.disabled = true;
  btn.classList.add('loading');
  textarea.classList.add('ai-loading');
  textarea.value = '';
  textarea.placeholder = '✦ AI analyzing staged changes...';

  try {
    const res = await fetch(`/api/projects/${projectId}/generate-commit-msg`, { method: 'POST' });
    const data = await res.json();
    if (data.error) {
      showToast(data.error, 'error');
    } else if (data.message) {
      textarea.value = data.message;
      textarea.focus();
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
      showToast('Commit message generated', 'success');
    }
  } catch (err) {
    showToast('AI error: ' + err.message, 'error');
  }
  btn.disabled = false;
  btn.classList.remove('loading');
  textarea.classList.remove('ai-loading');
  textarea.placeholder = 'Commit message (Ctrl+Enter to commit)';
};

// ─── Auto Commit (Haiku AI) ───
let _acPlan = null;   // { projectId, commits:[{message,files,reasoning}], pending:[] }
let _acExecuting = false;
let _acDragFile = null; // { file, fromCommit (index|-1 for pending) }
let _acBranchInfo = null; // { branch, worktrees }

// --- Branch / Worktree display in Changes tab toolbar ---
async function updateDiffBranchInfo() {
  const el = document.getElementById('diff-branch-info');
  if (!el) return;
  const sel = document.getElementById('diff-project');
  const projectId = sel?.value;
  if (!projectId) { el.innerHTML = ''; _acBranchInfo = null; return; }
  try {
    const res = await fetch(`/api/projects/${projectId}/git`);
    const data = await res.json();
    _acBranchInfo = { branch: data.branch || 'unknown', worktrees: data.worktrees || [] };
    const branchSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v12"/><path d="M18 9a3 3 0 100-6 3 3 0 000 6z"/><path d="M6 21a3 3 0 100-6 3 3 0 000 6z"/><path d="M18 9c0 6-12 6-12 12"/></svg>`;
    let html = `<span class="dbi-branch" onclick="toggleBranchDropdown(event)">${branchSvg}${esc(data.branch || 'unknown')}<span class="dbi-chevron">▼</span></span>`;
    if (data.worktrees?.length > 1) {
      html += `<span class="dbi-wt" onclick="toggleWorktreeDropdown(event)">${data.worktrees.length} worktrees</span>`;
    }
    html += '<div class="branch-dropdown" id="branch-dropdown"></div>';
    el.innerHTML = html;
  } catch { el.innerHTML = ''; _acBranchInfo = null; }
}

// ─── Branch Switcher ───
window.toggleBranchDropdown = async (e) => {
  e.stopPropagation();
  const dd = document.getElementById('branch-dropdown');
  if (!dd) return;
  if (dd.classList.contains('open')) { dd.classList.remove('open'); return; }
  const projectId = _diffProjectId();
  if (!projectId) return;

  dd.innerHTML = '<div style="padding:12px;text-align:center;color:var(--text-3);font-size:.76rem">Loading...</div>';
  dd.classList.add('open');

  try {
    const res = await fetch(`/api/projects/${projectId}/branches`);
    const data = await res.json();
    const current = data.current || _acBranchInfo?.branch || '';
    const locals = data.local || [];
    const remotes = (data.remote || []).filter(r => {
      const short = r.replace(/^origin\//, '');
      return !locals.includes(short);
    });

    let html = '<div class="bd-search"><input type="text" placeholder="Search branches..." oninput="filterBranchDropdown(this.value)" autofocus></div>';

    if (locals.length) {
      html += '<div class="bd-section"><div class="bd-label">Local</div>';
      for (const b of locals) {
        const isCurrent = b === current;
        const canDelete = !isCurrent && !['main','master'].includes(b);
        html += `<div class="bd-item ${isCurrent ? 'current' : ''}" data-branch="${esc(b)}" onclick="switchBranch('${esc(b).replace(/'/g, "\\'")}')"><span class="bd-check">${isCurrent ? '●' : ''}</span><span class="bd-name">${esc(b)}</span>${canDelete ? `<span class="bd-delete" onclick="event.stopPropagation();deleteBranch('${projectId}','${esc(b).replace(/'/g, "\\'")}')" title="Delete branch">&times;</span>` : ''}</div>`;
      }
      html += '</div>';
    }
    if (remotes.length) {
      html += '<div class="bd-section"><div class="bd-label">Remote</div>';
      for (const b of remotes) {
        const short = b.replace(/^origin\//, '');
        html += `<div class="bd-item" data-branch="${esc(short)}" onclick="switchBranch('${esc(short).replace(/'/g, "\\'")}')"><span class="bd-check"></span><span class="bd-name">${esc(b)}</span></div>`;
      }
      html += '</div>';
    }

    // Worktrees section
    const wts = data.worktrees || _acBranchInfo?.worktrees || [];
    if (wts.length > 1) {
      html += '<div class="bd-section" style="border-top:1px solid var(--border);margin-top:4px;padding-top:4px"><div class="bd-label">Worktrees</div>';
      for (const wt of wts) {
        const wtName = wt.path ? wt.path.split(/[/\\]/).pop() : wt.branch || '?';
        const isCurrent = wt.branch === current;
        html += `<div class="bd-item ${isCurrent ? 'current' : ''}" data-branch="${esc(wt.branch || '')}" onclick="switchBranch('${esc(wt.branch || '').replace(/'/g, "\\'")}')"><span class="bd-check">${isCurrent ? '●' : ''}</span><span class="bd-name">${esc(wtName)} <span style="color:var(--text-3);font-size:.68rem">(${esc(wt.branch || '')})</span></span></div>`;
      }
      html += '</div>';
    }

    html += `<div class="branch-create-row"><input type="text" id="new-branch-input" placeholder="New branch name..." onkeydown="if(event.key==='Enter'){event.stopPropagation();createBranch('${projectId}')}"><button onclick="event.stopPropagation();createBranch('${projectId}')">Create</button></div>`;

    dd.innerHTML = html;
    dd.querySelector('.bd-search input')?.focus();
  } catch (err) {
    dd.innerHTML = `<div style="padding:12px;text-align:center;color:var(--red);font-size:.76rem">Error: ${err.message}</div>`;
  }

  // Close on outside click
  const close = (ev) => { if (!dd.contains(ev.target)) { dd.classList.remove('open'); document.removeEventListener('click', close); } };
  setTimeout(() => document.addEventListener('click', close), 0);
};

window.filterBranchDropdown = (q) => {
  const dd = document.getElementById('branch-dropdown');
  if (!dd) return;
  const query = q.toLowerCase().trim();
  dd.querySelectorAll('.bd-item').forEach(item => {
    const name = (item.dataset.branch || '').toLowerCase();
    item.style.display = !query || name.includes(query) ? '' : 'none';
  });
};

window.switchBranch = async (branch) => {
  const projectId = _diffProjectId();
  if (!projectId) return;
  const dd = document.getElementById('branch-dropdown');
  if (dd) dd.classList.remove('open');

  if (branch === _acBranchInfo?.branch) return; // already on this branch

  showToast(`Switching to ${branch}...`, 'info');
  try {
    const res = await fetch(`/api/projects/${projectId}/git/checkout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ branch })
    });
    const data = await res.json();
    if (data.error) {
      showToast('Switch failed: ' + data.error, 'error');
    } else {
      showToast(`Switched to ${branch}`, 'success');
      loadDiff();
    }
  } catch (err) {
    showToast('Switch error: ' + err.message, 'error');
  }
};

window.toggleWorktreeDropdown = (e) => {
  // Reuse branch dropdown but scroll to worktrees section
  toggleBranchDropdown(e);
};

window.startAutoCommit = async () => {
  const sel = document.getElementById('diff-project');
  const projectId = sel.value;
  if (!projectId) return;

  const btn = document.getElementById('ac-btn');
  btn.classList.add('loading');
  btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>Analyzing...`;

  try {
    const res = await fetch(`/api/projects/${projectId}/auto-commit/plan`, { method: 'POST' });
    const data = await res.json();

    if (data.error) { showToast(data.error, 'error'); resetAcBtn(); return; }
    if (!data.commits?.length) { showToast('No changes to commit', 'info'); resetAcBtn(); return; }

    _acPlan = { projectId, commits: data.commits, pending: [] };
    renderAutoCommitPlan();
  } catch (err) {
    showToast('Failed to get AI plan: ' + err.message, 'error');
  }
  resetAcBtn();
};

function resetAcBtn() {
  const btn = document.getElementById('ac-btn');
  btn.classList.remove('loading');
  btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M5.5 8.5l13 7M18.5 8.5l-13 7"/></svg>AI Commit`;
}

// --- File tag with drag + move arrow ---
function acFileTag(file, commitIdx) {
  const name = file.includes('/') ? file.substring(file.lastIndexOf('/') + 1) : file;
  const isPending = commitIdx === -1;
  const arrowTitle = isPending ? 'Move up to commit' : 'Move to pending';
  const tag = document.createElement('span');
  tag.className = 'ac-file-tag';
  tag.title = file;
  tag.draggable = true;
  tag.dataset.file = file;
  tag.dataset.from = String(commitIdx);
  tag.innerHTML = `<span class="aft-dot" style="background:var(--yellow)"></span>${esc(name)}<span class="aft-down" title="${arrowTitle}">\u25BC</span>`;

  // Drag start
  tag.addEventListener('dragstart', e => {
    _acDragFile = { file, fromCommit: commitIdx };
    tag.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', file);
  });
  tag.addEventListener('dragend', () => { tag.classList.remove('dragging'); _acDragFile = null; });

  // Arrow click: move to pending (if in commit) or move to last commit (if in pending)
  tag.querySelector('.aft-down').addEventListener('click', e => {
    e.stopPropagation();
    if (isPending) {
      // Move to last commit
      const lastIdx = _acPlan.commits.length - 1;
      if (lastIdx >= 0) acMoveFile(file, -1, lastIdx);
    } else {
      acMoveFile(file, commitIdx, -1);
    }
  });

  return tag;
}

// --- Move file between commits / pending ---
function acMoveFile(file, fromIdx, toIdx) {
  if (!_acPlan || fromIdx === toIdx) return;
  // Remove from source
  if (fromIdx === -1) {
    _acPlan.pending = _acPlan.pending.filter(f => f !== file);
  } else {
    const c = _acPlan.commits[fromIdx];
    if (c) c.files = c.files.filter(f => f !== file);
  }
  // Add to target
  if (toIdx === -1) {
    if (!_acPlan.pending.includes(file)) _acPlan.pending.push(file);
  } else {
    const c = _acPlan.commits[toIdx];
    if (c && !c.files.includes(file)) c.files.push(file);
  }
  rerenderAcBody();
}

// --- Add new commit ---
function acAddCommit() {
  if (!_acPlan) return;
  _acPlan.commits.push({ message: 'chore: new commit', files: [], reasoning: '' });
  rerenderAcBody();
}

// --- Delete commit (moves files to pending) ---
function acDeleteCommit(idx) {
  if (!_acPlan || !_acPlan.commits[idx]) return;
  const files = _acPlan.commits[idx].files;
  files.forEach(f => { if (!_acPlan.pending.includes(f)) _acPlan.pending.push(f); });
  _acPlan.commits.splice(idx, 1);
  rerenderAcBody();
}

// --- Setup drop zone ---
function acDropZone(el, targetIdx) {
  el.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; el.classList.add(targetIdx === -1 ? 'drag-over' : 'drag-over'); });
  el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
  el.addEventListener('drop', e => {
    e.preventDefault();
    el.classList.remove('drag-over');
    if (_acDragFile) {
      acMoveFile(_acDragFile.file, _acDragFile.fromCommit, targetIdx);
      _acDragFile = null;
    }
  });
}

// --- Rerender the body (commits + pending) ---
function rerenderAcBody() {
  if (!_acPlan) return;
  const body = document.getElementById('ac-body');
  if (!body) return;
  body.innerHTML = '';

  const plan = _acPlan;

  // Commit cards
  plan.commits.forEach((c, i) => {
    const card = document.createElement('div');
    card.className = 'ac-commit-card';
    card.id = `ac-card-${i}`;

    const head = document.createElement('div');
    head.className = 'ac-card-head';
    head.innerHTML = `<div class="ac-card-num">${i + 1}</div>
      <div class="ac-card-msg"><input type="text" value="${c.message.replace(/"/g, '&quot;')}" data-idx="${i}"></div>
      <button class="ac-card-delete" title="Delete commit (files go to pending)">&times;</button>`;
    head.querySelector('input').addEventListener('change', e => { c.message = e.target.value; });
    head.querySelector('.ac-card-delete').addEventListener('click', () => acDeleteCommit(i));
    card.appendChild(head);

    if (c.reasoning) {
      const reason = document.createElement('div');
      reason.className = 'ac-card-reason';
      reason.textContent = c.reasoning;
      card.appendChild(reason);
    }

    const filesDiv = document.createElement('div');
    filesDiv.className = 'ac-card-files';
    c.files.forEach(f => filesDiv.appendChild(acFileTag(f, i)));
    card.appendChild(filesDiv);

    // Drop zone on the card
    acDropZone(card, i);
    body.appendChild(card);
  });

  // Add commit button
  const addBtn = document.createElement('div');
  addBtn.className = 'ac-add-commit';
  addBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 5v14M5 12h14"/></svg> Add Commit`;
  addBtn.addEventListener('click', acAddCommit);
  body.appendChild(addBtn);

  // Pending section
  const pending = document.createElement('div');
  pending.className = 'ac-pending';
  pending.innerHTML = `<div class="ac-pending-head"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="10" stroke-dasharray="4 2"/></svg>Pending<span class="aph-count">${plan.pending.length}</span></div>`;
  const pFiles = document.createElement('div');
  pFiles.className = 'ac-pending-files';
  if (plan.pending.length === 0) {
    pFiles.innerHTML = '<span class="ac-pending-empty">Drag files here to exclude from commits</span>';
  } else {
    plan.pending.forEach(f => pFiles.appendChild(acFileTag(f, -1)));
  }
  pending.appendChild(pFiles);
  acDropZone(pending, -1);
  body.appendChild(pending);

  // Update stats in header
  const totalFiles = plan.commits.reduce((s, c) => s + c.files.length, 0);
  const statsCommits = document.querySelector('.acs-commits');
  const statsFiles = document.querySelector('.acs-files');
  if (statsCommits) statsCommits.textContent = `${plan.commits.length} commit${plan.commits.length !== 1 ? 's' : ''}`;
  if (statsFiles) statsFiles.textContent = `${totalFiles} file${totalFiles !== 1 ? 's' : ''}`;

  // Update footer button count
  const commitBtn = document.getElementById('ac-commit-btn');
  if (commitBtn && !_acExecuting) {
    const activeCommits = plan.commits.filter(c => c.files.length > 0).length;
    commitBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Commit All (${activeCommits})`;
  }
}

function renderAutoCommitPlan() {
  const layout = document.querySelector('#diff-view .diff-layout');
  layout.querySelector('.ac-overlay')?.remove();

  const plan = _acPlan;
  if (!plan) return;

  const totalFiles = plan.commits.reduce((s, c) => s + c.files.length, 0);
  const overlay = document.createElement('div');
  overlay.className = 'ac-overlay';

  // Header with branch info
  let branchHtml = '';
  if (_acBranchInfo) {
    branchHtml = `<span class="ac-branch"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M6 3v12"/><path d="M18 9a3 3 0 100-6 3 3 0 000 6z"/><path d="M6 21a3 3 0 100-6 3 3 0 000 6z"/><path d="M18 9c0 6-12 6-12 12"/></svg>${esc(_acBranchInfo.branch)}</span>`;
  }

  overlay.innerHTML = `
    <div class="ac-header">
      <h3>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M5.5 8.5l13 7M18.5 8.5l-13 7"/></svg>
        Auto Commit Plan
      </h3>
      ${branchHtml}
      <div class="ac-stats">
        <span class="acs-commits">${plan.commits.length} commit${plan.commits.length > 1 ? 's' : ''}</span>
        <span class="acs-files">${totalFiles} file${totalFiles > 1 ? 's' : ''}</span>
      </div>
      <button class="ac-cancel" onclick="cancelAutoCommit()">Cancel</button>
    </div>
    <div class="ac-body" id="ac-body"></div>
    <div class="ac-footer" id="ac-footer">
      <div class="ac-progress" id="ac-progress" style="display:none">
        <div class="ac-progress-bar"><div class="ac-progress-fill" id="ac-progress-fill"></div></div>
        <span class="ac-progress-text" id="ac-progress-text">0/${plan.commits.length}</span>
      </div>
      <button class="ac-commit-btn" id="ac-commit-btn" onclick="executeAutoCommit()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        Commit All (${plan.commits.length})
      </button>
    </div>
  `;

  layout.appendChild(overlay);
  rerenderAcBody();
}

window.cancelAutoCommit = () => {
  _acPlan = null;
  _acExecuting = false;
  _acDragFile = null;
  const layout = document.querySelector('#diff-view .diff-layout');
  layout.querySelector('.ac-overlay')?.remove();
};

window.executeAutoCommit = async () => {
  if (!_acPlan || _acExecuting) return;

  // Pre-commit branch validation
  if (_acBranchInfo) {
    const currentBranch = _acBranchInfo.branch;
    if (currentBranch === 'main' || currentBranch === 'master') {
      if (!confirm(`You are about to commit to "${currentBranch}". Are you sure?`)) return;
    }
  }

  // Filter out empty commits
  const activeCommits = _acPlan.commits.filter(c => c.files.length > 0);
  if (activeCommits.length === 0) { showToast('No files in any commit', 'info'); return; }

  _acExecuting = true;
  const { projectId } = _acPlan;
  const commitBtn = document.getElementById('ac-commit-btn');
  const progressEl = document.getElementById('ac-progress');
  const progressFill = document.getElementById('ac-progress-fill');
  const progressText = document.getElementById('ac-progress-text');

  commitBtn.disabled = true;
  commitBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:acSpin 1s linear infinite"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>Committing...`;
  progressEl.style.display = 'flex';
  progressText.textContent = `0/${activeCommits.length}`;

  let completed = 0;
  let failed = false;

  for (let i = 0; i < _acPlan.commits.length; i++) {
    const c = _acPlan.commits[i];
    if (c.files.length === 0) continue; // skip empty
    const card = document.getElementById(`ac-card-${i}`);
    if (!card) continue;
    card.classList.add('executing');
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    try {
      const res = await fetch(`/api/projects/${projectId}/auto-commit/execute`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: c.message, files: c.files })
      });
      const data = await res.json();
      card.classList.remove('executing');

      if (data.error) {
        card.classList.add('failed');
        card.querySelector('.ac-card-num').textContent = '!';
        showToast(`Commit ${i + 1} failed: ${data.error}`, 'error');
        failed = true;
        break;
      }

      card.classList.add('done');
      card.querySelector('.ac-card-num').innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="14" height="14"><polyline points="20 6 9 17 4 12"/></svg>`;
      completed++;
      const pct = Math.round((completed / activeCommits.length) * 100);
      progressFill.style.width = pct + '%';
      progressText.textContent = `${completed}/${activeCommits.length}`;
    } catch (err) {
      card.classList.remove('executing');
      card.classList.add('failed');
      showToast(`Network error: ${err.message}`, 'error');
      failed = true;
      break;
    }
  }

  _acExecuting = false;

  const footer = document.getElementById('ac-footer');
  if (!failed && completed === activeCommits.length) {
    footer.innerHTML = `
      <div class="ac-done-msg">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>
        ${completed} commit${completed > 1 ? 's' : ''} done!
      </div>
      <div style="flex:1"></div>
      <button class="ac-cancel" onclick="cancelAutoCommit();loadDiff();">Close</button>
      <button class="ac-push-btn" onclick="doPush('${projectId}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        Push
      </button>
    `;
    showToast(`${completed} commits created successfully`, 'success');
  } else {
    commitBtn.disabled = false;
    commitBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>Retry remaining`;
  }
};

window.doPush = async (projectId) => {
  const pushBtn = document.querySelector('.ac-push-btn');
  if (!pushBtn) return;
  pushBtn.disabled = true;
  pushBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:acSpin 1s linear infinite"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>Pushing...`;

  try {
    const res = await fetch(`/api/projects/${projectId}/push`, { method: 'POST' });
    const data = await res.json();
    if (data.error) {
      showToast('Push failed: ' + data.error, 'error');
      pushBtn.disabled = false;
      pushBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 19V5M5 12l7-7 7 7"/></svg>Push`;
    } else {
      showToast('Pushed successfully!', 'success');
      pushBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>Pushed!`;
      pushBtn.style.background = 'rgba(16,185,129,.2)';
      pushBtn.style.border = '1px solid rgba(16,185,129,.3)';
    }
  } catch (err) {
    showToast('Push error: ' + err.message, 'error');
    pushBtn.disabled = false;
    pushBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 19V5M5 12l7-7 7 7"/></svg>Push`;
  }
};

// ─── Branch/Worktree Picker for New Terminal ───
let _branchData = null;
let _selectedBranch = null; // { type:'worktree'|'local'|'remote', value:string, cwd?:string }
window.loadBranchesForTerm = async () => {
  const projectId = document.getElementById('nt-project').value;
  const section = document.getElementById('nt-branch-section');
  const list = document.getElementById('nt-branch-list');
  _selectedBranch = null;
  if (!projectId) { section.style.display = 'none'; return; }
  section.style.display = '';
  list.innerHTML = '<div style="padding:10px;color:var(--text-3);font-size:.78rem">Loading...</div>';
  try {
    const res = await fetch(`/api/projects/${projectId}/branches`);
    _branchData = await res.json();
    let html = '';
    // Worktrees
    if (_branchData.worktrees?.length > 1) {
      html += `<div class="nt-branch-group"><div class="nt-branch-group-head">Worktrees</div>`;
      for (const wt of _branchData.worktrees) {
        const name = wt.path.split('/').pop();
        const isCurrent = wt.branch === _branchData.current;
        html += `<div class="nt-branch-item" data-type="worktree" data-value="${esc(wt.branch)}" data-cwd="${esc(wt.path)}" onclick="selectBranch(this)">
          <span>${esc(wt.branch)}</span>
          <span class="nb-wt-path">${esc(name)}</span>
          ${isCurrent ? '<span class="nb-current">current</span>' : ''}
        </div>`;
      }
      html += '</div>';
    }
    // Local
    if (_branchData.local?.length) {
      html += `<div class="nt-branch-group"><div class="nt-branch-group-head">Local</div>`;
      for (const b of _branchData.local) {
        const isCurrent = b === _branchData.current;
        html += `<div class="nt-branch-item" data-type="local" data-value="${esc(b)}" onclick="selectBranch(this)">
          <span>${esc(b)}</span>
          ${isCurrent ? '<span class="nb-current">current</span>' : ''}
        </div>`;
      }
      html += '</div>';
    }
    // Remote
    if (_branchData.remote?.length) {
      html += `<div class="nt-branch-group"><div class="nt-branch-group-head">Remote</div>`;
      for (const b of _branchData.remote) {
        html += `<div class="nt-branch-item" data-type="remote" data-value="${esc(b)}" onclick="selectBranch(this)">
          <span style="color:var(--text-2)">${esc(b)}</span>
        </div>`;
      }
      html += '</div>';
    }
    list.innerHTML = html || '<div style="padding:10px;color:var(--text-3);font-size:.78rem">No branches found</div>';
  } catch { list.innerHTML = '<div style="padding:10px;color:var(--text-3);font-size:.78rem">Error loading branches</div>'; }
};
window.selectBranch = (el) => {
  document.querySelectorAll('#nt-branch-list .nt-branch-item.selected').forEach(x => x.classList.remove('selected'));
  if (_selectedBranch && _selectedBranch.value === el.dataset.value && _selectedBranch.type === el.dataset.type) {
    _selectedBranch = null; return; // deselect
  }
  el.classList.add('selected');
  _selectedBranch = { type: el.dataset.type, value: el.dataset.value, cwd: el.dataset.cwd || '' };
};

// ─── Dev Server Management (Client) ───
let devServerState = []; // [{projectId, command, startedAt, port}]
const _knownPorts = new Set();
const _devStartTimeouts = new Map();

window.promptDevCmd = async (projectId) => {
  const p = projectList.find(x => x.id === projectId);
  if (!p) return;
  const dlg = document.getElementById('dev-dialog');
  const content = document.getElementById('dev-dialog-content');
  document.querySelector('#dev-dialog .modal-header h2').textContent = `Dev Command \u2014 ${p.name}`;
  content.innerHTML = '<div style="padding:12px;color:var(--text-3);font-size:.78rem">Loading scripts...</div>';
  dlg.showModal();
  try {
    const res = await fetch(`/api/scripts-by-path?path=${encodeURIComponent(p.path)}`);
    const data = await res.json();
    const entries = Object.entries(data.scripts || {});
    let html = '';
    if (entries.length) {
      html += '<div style="padding:8px 14px;font-size:.72rem;color:var(--text-3)">package.json scripts \u2014 click to set</div>';
      html += entries.map(([name, cmd]) =>
        `<div class="dev-item" style="cursor:pointer" onclick="setDevCmd('${projectId}','npm run ${name}')">
          <span class="di-name" style="font-family:var(--mono);color:var(--accent-bright)">${esc(name)}</span>
          <span class="di-cmd">${esc(cmd)}</span>
        </div>`
      ).join('');
    } else {
      html += '<div style="padding:12px 14px;color:var(--text-3);font-size:.78rem">No scripts in package.json</div>';
    }
    html += `<div style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:6px;align-items:center">
      <input type="text" id="dev-cmd-input" placeholder="Or type custom command..." style="flex:1;padding:5px 10px;font-size:.78rem;background:var(--bg-0);border:1px solid var(--border);border-radius:var(--radius-xs);color:var(--text-1);font-family:var(--mono)">
      <button class="btn primary" onclick="setDevCmd('${projectId}', document.getElementById('dev-cmd-input').value)" style="font-size:.72rem">Save</button>
    </div>`;
    content.innerHTML = html;
  } catch {
    content.innerHTML = '<div style="padding:12px;color:var(--red);font-size:.78rem">Error loading scripts</div>';
  }
};
window.setDevCmd = async (projectId, cmd) => {
  if (!cmd?.trim()) { showToast('Enter a command', 'error'); return; }
  const p = projectList.find(x => x.id === projectId);
  if (!p) return;
  p.devCmd = cmd.trim();
  await fetch(`/api/projects/${projectId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ ...p, devCmd: p.devCmd }) });
  document.getElementById('dev-dialog').close();
  showToast(`Dev command set: ${cmd.trim()}`, 'success');
  await refreshProjectList();
};

window.toggleDevServer = async (projectId) => {
  const isRunning = devServerState.some(d => d.projectId === projectId);
  const endpoint = isRunning ? 'stop' : 'start';
  try {
    const res = await fetch(`/api/projects/${projectId}/dev-server/${endpoint}`, { method: 'POST' });
    if (!res.ok) { const err = await res.json().catch(()=>({})); showToast(err.error || 'Dev server action failed', 'error'); return; }
    // Refresh dev server list from server
    const listRes = await fetch('/api/dev-servers');
    const data = await listRes.json();
    devServerState = data.running || [];
    updateDevBadge();
    renderCard(projectId);
    // Dev server start timeout (30s) — if no port detected, show warning
    if (endpoint === 'start') {
      const pName = projectList.find(p=>p.id===projectId)?.name || projectId;
      showToast(`Starting ${pName}...`, 'info', 2000);
      const tid = setTimeout(() => {
        const still = devServerState.find(d => d.projectId === projectId && !d.port);
        if (still) showToast(`${pName}: port not detected (may still be starting)`, 'error', 5000);
        _devStartTimeouts.delete(projectId);
      }, 30000);
      _devStartTimeouts.set(projectId, tid);
    }
    if (endpoint === 'stop' && _devStartTimeouts.has(projectId)) {
      clearTimeout(_devStartTimeouts.get(projectId));
      _devStartTimeouts.delete(projectId);
    }
    // If dev dialog is open, refresh it
    const dlg = document.getElementById('dev-dialog');
    if (dlg.open) showDevServerDialog();
  } catch { showToast('Dev server action failed', 'error'); }
};

window.showDevServerDialog = async () => {
  const dlg = document.getElementById('dev-dialog');
  const content = document.getElementById('dev-dialog-content');
  document.querySelector('#dev-dialog .modal-header h2').textContent = 'Dev Servers';
  try {
    const res = await fetch('/api/dev-servers');
    const data = await res.json();
    if (!data.running?.length) {
      content.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-3)">No dev servers running</div>';
    } else {
      content.innerHTML = data.running.map(d => {
        const ago = Math.round((Date.now() - d.startedAt) / 60000);
        const portTag = d.port ? `<span style="font-family:var(--mono);font-size:.74rem;color:var(--green);cursor:pointer" onclick="window.open('http://localhost:${d.port}','_blank')" title="Open in browser">:${d.port}</span>` : '';
        return `<div class="dev-item">
          <span class="dev-dot on"></span>
          <span class="di-name">${esc(d.name)}</span>
          ${portTag}
          <span class="di-cmd">${esc(d.command)}</span>
          <span class="di-time">${ago}m</span>
          <button class="btn" onclick="toggleDevServer('${d.projectId}')" style="font-size:.72rem;padding:2px 8px;color:var(--red)">Stop</button>
        </div>`;
      }).join('');
    }
  } catch { content.innerHTML = '<div style="padding:20px;color:var(--red)">Error</div>'; }
  dlg.showModal();
};

function updateDevBadge() {
  const el = document.getElementById('dev-count');
  if (el) el.textContent = devServerState.length;
  const badge = document.getElementById('dev-server-badge');
  if (badge) badge.style.display = devServerState.length ? '' : '';
}

// ─── Actions ───
window.openStartModal = (id) => { document.getElementById('modal-project-id').value=id; document.getElementById('start-modal').showModal(); };
window.doStartSession = async () => {
  const id=document.getElementById('modal-project-id').value;
  const model=document.getElementById('modal-model').value;
  const prompt=document.getElementById('modal-prompt').value;
  document.getElementById('start-modal').close();
  await fetch(`/api/sessions/${id}/start`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:model||undefined,prompt:prompt||undefined})});
};

// ─── Keyboard Shortcuts ───
document.addEventListener('keydown', e => {
  const mod = e.ctrlKey || e.metaKey;
  // F5 or Ctrl+R → reload page
  if (e.key === 'F5' || (mod && e.key === 'r')) { e.preventDefault(); location.reload(); return; }
  // Ctrl+1/2/3 → tab switch
  if (mod && e.key === '1') { e.preventDefault(); switchView('dashboard'); return; }
  if (mod && e.key === '2') { e.preventDefault(); switchView('terminal'); return; }
  if (mod && e.key === '3') { e.preventDefault(); switchView('diff'); return; }
  if (mod && e.key === '4') { e.preventDefault(); switchView('readme'); return; }
  // Ctrl+Tab / Ctrl+Shift+Tab → cycle terminals
  if (mod && e.key === 'Tab') {
    if (document.getElementById('terminal-view').classList.contains('active') && termMap.size > 1) {
      e.preventDefault();
      const ids = [...termMap.keys()];
      const cur = ids.indexOf(activeTermId);
      const next = e.shiftKey ? (cur <= 0 ? ids.length - 1 : cur - 1) : (cur >= ids.length - 1 ? 0 : cur + 1);
      activeTermId = ids[next]; updateTermHeaders(); const _t1 = termMap.get(ids[next]); if(_t1?.xterm) _t1.xterm.focus();
      return;
    }
  }
  // Ctrl+[ / Ctrl+] → prev/next terminal
  if (mod && (e.key === '[' || e.key === ']')) {
    if (document.getElementById('terminal-view').classList.contains('active') && termMap.size > 1) {
      e.preventDefault();
      const ids = [...termMap.keys()];
      const cur = ids.indexOf(activeTermId);
      const next = e.key === '[' ? (cur <= 0 ? ids.length - 1 : cur - 1) : (cur >= ids.length - 1 ? 0 : cur + 1);
      activeTermId = ids[next]; updateTermHeaders(); const _t2 = termMap.get(ids[next]); if(_t2?.xterm) _t2.xterm.focus();
      return;
    }
  }
  // Ctrl+T → new terminal
  if (mod && e.key === 't' && !e.shiftKey) {
    if (document.getElementById('terminal-view').classList.contains('active')) { e.preventDefault(); openNewTermModal(); return; }
  }
  // Ctrl+W → close active terminal
  if (mod && e.key === 'w' && !e.shiftKey) {
    if (document.getElementById('terminal-view').classList.contains('active') && activeTermId) { e.preventDefault(); closeTerminal(activeTermId); return; }
  }
  // Ctrl+F → terminal search
  if (mod && e.key === 'f') {
    if (document.getElementById('terminal-view').classList.contains('active') && activeTermId) { e.preventDefault(); toggleTermSearch(); return; }
  }
  // Ctrl+Enter → commit (when in diff view)
  if (mod && e.key === 'Enter') {
    if (document.getElementById('diff-view').classList.contains('active')) {
      e.preventDefault();
      const msg = document.getElementById('diff-commit-msg')?.value?.trim();
      if (msg) { doManualCommit(); } else { document.getElementById('diff-commit-msg')?.focus(); }
      return;
    }
  }
  // R → refresh diff (no modifier, not in input)
  if (e.key === 'r' && !mod && !e.altKey && !['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) {
    if (document.getElementById('diff-view').classList.contains('active')) { e.preventDefault(); loadDiff(); return; }
  }
  // E → expand all, C → collapse all (diff view, no modifier)
  if (!mod && !e.altKey && !['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) {
    if (document.getElementById('diff-view').classList.contains('active')) {
      if (e.key === 'e') { e.preventDefault(); diffExpandAll(); return; }
      if (e.key === 'c') { e.preventDefault(); diffCollapseAll(); return; }
    }
  }
  // ? → shortcut help (no modifier, not in input)
  if (e.key === '?' && !mod && !e.altKey && !['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) {
    e.preventDefault(); showShortcutHelp(); return;
  }
  // Escape → close overlays
  if (e.key === 'Escape') {
    const so = document.getElementById('shortcut-overlay');
    if (so && !so.classList.contains('hidden')) { hideShortcutHelp(); return; }
    const sb = document.getElementById('term-search-bar');
    if (sb?.classList.contains('open')) { closeTermSearch(); return; }
  }
});

// ─── Terminal Search ───
function toggleTermSearch() {
  const sb = document.getElementById('term-search-bar');
  if (sb.classList.contains('open')) { closeTermSearch(); return; }
  sb.classList.add('open');
  const input = sb.querySelector('input');
  input.value = '';
  input.focus();
}
function closeTermSearch() {
  const sb = document.getElementById('term-search-bar');
  sb.classList.remove('open');
  if (activeTermId) { const t = termMap.get(activeTermId); if (t?.searchAddon) t.searchAddon.clearDecorations(); }
}
function doTermSearch(dir) {
  const input = document.querySelector('#term-search-bar input');
  const q = input.value;
  if (!q || !activeTermId) return;
  const t = termMap.get(activeTermId);
  if (!t?.searchAddon) return;
  if (dir === 'next') t.searchAddon.findNext(q, { regex: false, caseSensitive: false, incremental: true });
  else t.searchAddon.findPrevious(q, { regex: false, caseSensitive: false, incremental: true });
}

// ─── Notification Toggle ───
let notifyEnabled = localStorage.getItem('dl-notify') !== 'false';
function toggleNotifications() {
  notifyEnabled = !notifyEnabled;
  localStorage.setItem('dl-notify', notifyEnabled);
  const btn = document.getElementById('notify-toggle');
  if (btn) { btn.textContent = notifyEnabled ? 'On' : 'Off'; btn.className = 'btn' + (notifyEnabled ? '' : ' off-btn'); }
  showToast(notifyEnabled ? 'Notifications enabled' : 'Notifications disabled', 'info');
}

// Expose to inline onclick handlers (module scope)
window.toggleTermSearch = toggleTermSearch;
window.closeTermSearch = closeTermSearch;
window.doTermSearch = doTermSearch;
window.toggleNotifications = toggleNotifications;

// ─── Theme Toggle ───
let currentTheme = localStorage.getItem('dl-theme') || 'dark';
function applyTheme(theme) {
  currentTheme = theme;
  document.body.classList.toggle('light-theme', theme === 'light');
  document.getElementById('theme-icon-dark').style.display = theme === 'dark' ? '' : 'none';
  document.getElementById('theme-icon-light').style.display = theme === 'light' ? '' : 'none';
  localStorage.setItem('dl-theme', theme);
}
window.toggleTheme = () => {
  applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
  showToast(`${currentTheme === 'light' ? 'Light' : 'Dark'} theme`, 'info');
};

// ─── Keyboard Shortcut Help ───
function showShortcutHelp() { document.getElementById('shortcut-overlay').classList.remove('hidden'); }
function hideShortcutHelp() { document.getElementById('shortcut-overlay').classList.add('hidden'); }
window.showShortcutHelp = showShortcutHelp;
window.hideShortcutHelp = hideShortcutHelp;

// ─── Project Pin ───
let pinnedProjects = new Set(JSON.parse(localStorage.getItem('dl-pinned') || '[]'));

function savePins() { localStorage.setItem('dl-pinned', JSON.stringify([...pinnedProjects])); }

window.togglePin = (id) => {
  if (pinnedProjects.has(id)) pinnedProjects.delete(id);
  else pinnedProjects.add(id);
  savePins();
  sortAndRenderProjects();
};

function sortAndRenderProjects() {
  const sorted = [...projectList].sort((a, b) => {
    const ap = pinnedProjects.has(a.id) ? 0 : 1;
    const bp = pinnedProjects.has(b.id) ? 0 : 1;
    return ap - bp;
  });
  _renderedCardIds = []; // force full rebuild
  renderAllCards(sorted);
  projectList.forEach(p => { const s = state.projects.get(p.id); if (s) renderCard(p.id); });
}

// ─── Pull / Fetch / Stash ───
function getDiffProjectId() {
  return document.getElementById('diff-project')?.value;
}

window.doPull = async () => {
  const pid = getDiffProjectId();
  if (!pid) return showToast('Select a project first', 'error');
  const btn = document.getElementById('dt-pull-btn');
  btn.classList.add('loading'); btn.textContent = 'Pulling...';
  try {
    const res = await fetch(`/api/projects/${pid}/pull`, { method: 'POST' });
    const data = await res.json();
    if (data.error) showToast('Pull failed: ' + data.error, 'error');
    else { showToast('Pull complete', 'success'); loadDiff(); }
  } catch (err) { showToast('Pull error: ' + err.message, 'error'); }
  btn.classList.remove('loading');
  btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>Pull`;
};

window.doFetch = async () => {
  const pid = getDiffProjectId();
  if (!pid) return showToast('Select a project first', 'error');
  const btn = document.getElementById('dt-fetch-btn');
  btn.classList.add('loading'); btn.textContent = 'Fetching...';
  try {
    const res = await fetch(`/api/projects/${pid}/fetch`, { method: 'POST' });
    const data = await res.json();
    if (data.error) showToast('Fetch failed: ' + data.error, 'error');
    else showToast('Fetch complete', 'success');
  } catch (err) { showToast('Fetch error: ' + err.message, 'error'); }
  btn.classList.remove('loading');
  btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Fetch`;
};

window.doStash = async () => {
  const pid = getDiffProjectId();
  if (!pid) return showToast('Select a project first', 'error');
  try {
    const res = await fetch(`/api/projects/${pid}/git/stash`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ includeUntracked: true }) });
    const data = await res.json();
    if (data.error) showToast('Stash failed: ' + data.error, 'error');
    else { showToast('Changes stashed', 'success'); loadDiff(); }
  } catch (err) { showToast('Stash error: ' + err.message, 'error'); }
};

window.doStashPop = async () => {
  const pid = getDiffProjectId();
  if (!pid) return showToast('Select a project first', 'error');
  try {
    const res = await fetch(`/api/projects/${pid}/git/stash-pop`, { method: 'POST' });
    const data = await res.json();
    if (data.error) showToast('Stash pop failed: ' + data.error, 'error');
    else { showToast('Stash popped', 'success'); loadDiff(); }
  } catch (err) { showToast('Stash pop error: ' + err.message, 'error'); }
};

// ─── Branch Create/Delete ───
window.createBranch = async (projectId) => {
  const input = document.getElementById('new-branch-input');
  if (!input) return;
  const name = input.value.trim();
  if (!name) return showToast('Enter a branch name', 'error');
  if (!/^[a-zA-Z0-9._\-/]+$/.test(name)) return showToast('Invalid branch name', 'error');
  try {
    const res = await fetch(`/api/projects/${projectId}/git/create-branch`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ branch: name }) });
    const data = await res.json();
    if (data.error) showToast('Create failed: ' + data.error, 'error');
    else { showToast(`Branch '${name}' created`, 'success'); input.value = ''; loadDiff(); updateDiffBranchInfo(); }
  } catch (err) { showToast('Create error: ' + err.message, 'error'); }
};

window.deleteBranch = async (projectId, branch) => {
  if (!confirm(`Delete branch '${branch}'?`)) return;
  try {
    const res = await fetch(`/api/projects/${projectId}/git/delete-branch`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ branch }) });
    const data = await res.json();
    if (data.error) showToast('Delete failed: ' + data.error, 'error');
    else { showToast(`Branch '${branch}' deleted`, 'success'); updateDiffBranchInfo(); }
  } catch (err) { showToast('Delete error: ' + err.message, 'error'); }
};

// ─── README ───
function simpleMarkdown(md) {
  let html = '';
  const lines = md.split('\n');
  let inCode = false, codeBlock = '', inList = false, listType = '';
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.startsWith('```')) {
      if (inCode) { html += `<pre><code>${codeBlock}</code></pre>`; codeBlock = ''; }
      inCode = !inCode; continue;
    }
    if (inCode) { codeBlock += esc(line) + '\n'; continue; }
    if (inList && !/^(\s*[-*]|\s*\d+\.)/.test(line) && line.trim()) {
      html += `</${listType}>`; inList = false;
    }
    if (/^### (.+)/.test(line)) { html += `<h3>${inline(line.slice(4))}</h3>`; continue; }
    if (/^## (.+)/.test(line)) { html += `<h2>${inline(line.slice(3))}</h2>`; continue; }
    if (/^# (.+)/.test(line)) { html += `<h1>${inline(line.slice(2))}</h1>`; continue; }
    if (/^---\s*$/.test(line)) { html += '<hr>'; continue; }
    if (/^>\s?(.*)/.test(line)) { html += `<blockquote><p>${inline(line.slice(2))}</p></blockquote>`; continue; }
    if (/^\|(.+)\|/.test(line)) {
      let tableHtml = '<table>';
      while (i < lines.length && /^\|(.+)\|/.test(lines[i])) {
        const cells = lines[i].split('|').filter(Boolean).map(c => c.trim());
        if (cells.every(c => /^[-:]+$/.test(c))) { i++; continue; }
        const tag = tableHtml === '<table>' ? 'th' : 'td';
        tableHtml += '<tr>' + cells.map(c => `<${tag}>${inline(c)}</${tag}>`).join('') + '</tr>';
        i++;
      }
      i--; html += tableHtml + '</table>'; continue;
    }
    if (/^\s*[-*] (.+)/.test(line)) {
      if (!inList || listType !== 'ul') { if (inList) html += `</${listType}>`; html += '<ul>'; inList = true; listType = 'ul'; }
      html += `<li>${inline(line.replace(/^\s*[-*] /, ''))}</li>`; continue;
    }
    if (/^\s*\d+\. (.+)/.test(line)) {
      if (!inList || listType !== 'ol') { if (inList) html += `</${listType}>`; html += '<ol>'; inList = true; listType = 'ol'; }
      html += `<li>${inline(line.replace(/^\s*\d+\. /, ''))}</li>`; continue;
    }
    if (!line.trim()) { html += ''; continue; }
    html += `<p>${inline(line)}</p>`;
  }
  if (inCode) html += `<pre><code>${codeBlock}</code></pre>`;
  if (inList) html += `</${listType}>`;
  return html;
  function inline(s) {
    return s
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/`(.+?)`/g, '<code>$1</code>')
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
  }
}

const README_CONTENT = `# Cockpit

여러 프로젝트의 Claude Code 세션, Git 상태, GitHub PR, 사용량을 한 화면에서 모니터링하고 관리하는 로컬 대시보드.

\`http://localhost:3847\`

---

## Features

### Overview (Dashboard)
- **Project Cards** — 프로젝트별 Claude 세션 상태 (active/idle/none), 현재 브랜치, 모델, uncommitted 파일 수, 최근 커밋, PR 상태를 실시간 표시
- **Project Search** — 이름, 스택, 상태로 필터링
- **Cost & Usage** — 오늘/이번 주/전체 토큰 사용량, 모델별 비용 추정, Chart.js 차트
- **Dev Server** — 프로젝트별 개발 서버 시작/중지, stdout에서 포트 자동 감지, 클릭하면 브라우저에서 열기
- **IDE 연동** — VS Code, Cursor, Windsurf, Antigravity 원클릭 실행
- **GitHub** — 프로젝트별 열린 PR 목록 (리뷰 상태, draft 여부), 원클릭으로 GitHub 열기

### Terminal
- **Multi-terminal** — 여러 프로젝트의 터미널을 탭으로 관리, 분할(가로/세로)
- **Tab Bar** — 빠른 전환, 가운데 클릭으로 닫기, 드래그로 순서 변경
- **Branch/Worktree Picker** — 터미널 생성 시 브랜치나 Git worktree 경로 선택
- **Search** — Ctrl+F로 터미널 출력 내 검색
- **세션 복원** — 서버 재시작 시 터미널 세션 자동 복원

### Changes (Git Diff)
- **2-Column Diff View** — 파일 사이드바 + 파일별 접기/펼치기 가능한 diff 패널
- **Staged/Unstaged** — 컬러 인디케이터로 구분 (인디고=staged, 옐로우=unstaged)
- **Line Numbers** — old/new 라인넘버 거터
- **Stage/Unstage/Discard** — 파일 단위 Git 스테이징 관리
- **수동 커밋** — 메시지 입력 후 직접 커밋 + Push
- **브랜치 표시** — 툴바에 현재 브랜치명과 워크트리 수 표시

### AI Auto Commit
Claude Haiku가 \`git status\` + \`git diff\`를 분석해서 관련 파일을 논리적 커밋으로 자동 그룹핑.

**워크플로우:**
1. "AI Commit" 버튼 → Haiku가 변경사항 분석 (3~5초)
2. 커밋 플랜 표시: 커밋별 메시지 + 파일 목록 + 이유
3. 사용자가 플랜 수정:
   - 커밋 메시지 인라인 편집
   - 파일을 커밋 간 **드래그 앤 드롭**으로 이동
   - 파일을 **대기(Pending)** 영역으로 내려서 커밋에서 제외
   - 대기 파일을 다시 커밋으로 올리기 (화살표 클릭)
   - **새 커밋 추가** / **커밋 삭제** (삭제 시 파일은 대기로 이동)
4. "Commit All" → 순차적으로 커밋 실행 (프로그레스 바)
5. 완료 후 "Push" 버튼으로 원격에 푸시

**안전장치:**
- \`main\`/\`master\` 브랜치에서 커밋 시 확인 다이얼로그
- 파일 없는 빈 커밋은 자동 스킵
- 커밋 실패 시 해당 카드에 에러 표시, 나머지 중단

> AI는 Claude CLI (\`claude -p --model haiku\`)를 통해 호출되므로 별도 API 키 불필요 — 기존 OAuth 인증 그대로 사용

---

## New Features

### Git Operations
- **Pull/Fetch** — Changes 탭 툴바에서 Git Pull/Fetch 원클릭
- **Stash/Pop** — 작업 중 변경사항 임시 저장 및 복원
- **Branch Create** — 드롭다운에서 새 브랜치 직접 생성
- **Branch Delete** — 사용 안하는 로컬 브랜치 삭제 (main/master 보호)

### UX
- **Project Pin** — 카드 별표로 즐겨찾기, 핀된 프로젝트 앞으로 정렬
- **Theme Toggle** — 다크/라이트 테마 전환 (헤더 버튼)
- **Shortcut Help** — ? 키로 단축키 오버레이

---

## Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| Ctrl+1 | Overview 탭 |
| Ctrl+2 | Terminal 탭 |
| Ctrl+3 | Changes 탭 |
| Ctrl+4 | README 탭 |
| Ctrl+T | 새 터미널 |
| Ctrl+W | 터미널 닫기 |
| Ctrl+F | 터미널 내 검색 |
| Ctrl+Tab | 다음 터미널 |
| Ctrl+Shift+Tab | 이전 터미널 |
| Ctrl+[ / ] | 이전/다음 터미널 |
| ? | 단축키 도움말 |
| Escape | 오버레이 / 검색 닫기 |

---

## Architecture

\`\`\`
Browser (SPA)          Node.js Server (port 3847)
┌─────────────┐  HTTP  ┌──────────────────────────┐
│ index.html  │◄──────►│ server.js                │
│ (inline     │  SSE   │  ├─ lib/config.js         │
│  CSS + JS)  │◄───────│  ├─ lib/claude-data.js    │
│             │  WS    │  ├─ lib/git-service.js    │
│ xterm.js    │◄──────►│  ├─ lib/github-service.js │
│ Chart.js    │        │  ├─ lib/cost-service.js   │
└─────────────┘        │  ├─ lib/session-control.js│
                       │  └─ lib/poller.js         │
                       └──────────┬────────────────┘
                                  │
                    ┌─────────────┼──────────────┐
                    │             │              │
               ~/.claude/    git CLI      claude CLI
               (세션/비용)  (status/diff)  (AI commit)
\`\`\`

- **Frontend** — 단일 HTML 파일 (CSS + JS 인라인, 빌드 도구 없음)
- **Backend** — 순수 Node.js HTTP 서버 (프레임워크 없음)
- **실시간** — SSE로 폴링 데이터 push, WebSocket으로 터미널 스트리밍
- **터미널** — \`node-pty\`로 PTY 프로세스 생성, \`ws\`로 양방향 연결
- **AI** — \`claude -p --model haiku\` CLI 호출 (OAuth 인증)

### Tech Stack
- \`xterm.js\` (WebGL) — 터미널 렌더링
- \`Chart.js\` — 사용량 차트
- \`node-pty\` — 서버사이드 PTY
- \`ws\` — WebSocket

---

## API Endpoints

### 프로젝트
| Method | Path | 설명 |
|--------|------|------|
| GET | /api/projects | 프로젝트 목록 |
| POST | /api/projects | 프로젝트 추가 |
| PUT | /api/projects/:id | 프로젝트 수정 |
| DELETE | /api/projects/:id | 프로젝트 삭제 |

### 모니터링
| Method | Path | 설명 |
|--------|------|------|
| GET | /api/events | SSE 실시간 스트림 |
| GET | /api/projects/:id/git | Git 상태 |
| GET | /api/projects/:id/prs | PR 목록 |
| GET | /api/projects/:id/branches | 브랜치/워크트리 |
| GET | /api/usage | 사용량 요약 |
| GET | /api/cost/daily | 일별 비용 |
| GET | /api/activity | 최근 활동 |

### Git 작업
| Method | Path | 설명 |
|--------|------|------|
| GET | /api/projects/:id/diff | Staged + Unstaged diff |
| POST | /api/projects/:id/git/stage | 파일 스테이징 |
| POST | /api/projects/:id/git/unstage | 스테이징 해제 |
| POST | /api/projects/:id/git/discard | 변경사항 버리기 |
| POST | /api/projects/:id/git/commit | 수동 커밋 |
| POST | /api/projects/:id/git/checkout | 브랜치 전환 |
| POST | /api/projects/:id/git/create-branch | 새 브랜치 |
| POST | /api/projects/:id/git/delete-branch | 브랜치 삭제 |
| POST | /api/projects/:id/git/stash | 변경사항 스태시 |
| POST | /api/projects/:id/git/stash-pop | 스태시 복원 |
| GET | /api/projects/:id/stash-list | 스태시 목록 |
| POST | /api/projects/:id/push | git push |
| POST | /api/projects/:id/pull | git pull |
| POST | /api/projects/:id/fetch | git fetch --all |

### AI Auto Commit
| Method | Path | 설명 |
|--------|------|------|
| POST | /api/projects/:id/auto-commit/plan | Haiku 커밋 플랜 생성 |
| POST | /api/projects/:id/auto-commit/execute | 단일 커밋 실행 |

### Dev Server
| Method | Path | 설명 |
|--------|------|------|
| GET | /api/dev-servers | 실행 중인 서버 |
| POST | /api/projects/:id/dev-server/start | 서버 시작 |
| POST | /api/projects/:id/dev-server/stop | 서버 중지 |

---

## Project Card Buttons

| Row | Buttons | Purpose |
|-----|---------|---------|
| Term | Claude, Resume, Shell | 터미널에서 Claude 세션 시작/재개/쉘 열기 |
| Open | VS, Cursor, AG, GitHub | IDE 실행 또는 GitHub repo 열기 |
| Etc | Dev, Sessions | 개발 서버 토글, 세션 이력 조회 |

---

## Polling Intervals

| 데이터 | 주기 | 설명 |
|--------|------|------|
| 세션 상태 | 5초 | Claude 프로세스 감지 |
| Git 상태 | 30초 | branch, uncommitted 등 |
| PR 상태 | 2분 | GitHub PR 목록 |
| 비용 데이터 | 1분 | 토큰 사용량/비용 |
| 활동 로그 | 10초 | 최근 세션 활동 |

---

## Setup

\`\`\`bash
cd dashboard
npm install
node server.js
\`\`\`

**요구사항:** Node.js 20+, Git, Claude Code CLI (OAuth 인증 완료)

**Windows 자동 시작:** \`powershell -File .\\setup-autostart.ps1\` (관리자 권한)
`;

function renderReadme() {
  document.getElementById('readme-content').innerHTML = simpleMarkdown(README_CONTENT);
}

// ─── Project Search & Scroll Indicators ───
window.filterProjects = () => {
  const query = document.getElementById('project-search').value.toLowerCase().trim();
  const countEl = document.getElementById('project-search-count');
  let visible = 0;
  projectList.forEach(p => {
    const card = document.getElementById(`card-${p.id}`);
    if (!card) return;
    const pState = state.projects.get(p.id);
    const status = pState?.session?.state || 'no_data';
    const match = !query
      || (p.name||'').toLowerCase().includes(query)
      || (p.stack||'').toLowerCase().includes(query)
      || status.toLowerCase().includes(query);
    card.style.display = match ? '' : 'none';
    if (match) visible++;
  });
  countEl.textContent = query ? `${visible}/${projectList.length}` : '';
  updateScrollIndicators();
};

function updateScrollIndicators() {
  const grid = document.getElementById('project-grid');
  const left = document.getElementById('scroll-ind-left');
  const right = document.getElementById('scroll-ind-right');
  if (!grid || !left || !right) return;
  left.classList.toggle('hidden', grid.scrollLeft <= 5);
  right.classList.toggle('hidden', grid.scrollLeft + grid.clientWidth >= grid.scrollWidth - 5);
}

// ─── Uncommitted → Changes ───
window.jumpToChanges = (projectId) => {
  const g = state.projects.get(projectId)?.git;
  if (!g?.uncommittedCount) return;
  switchView('diff');
  const sel = document.getElementById('diff-project');
  if (sel) { sel.value = projectId; loadDiff(); }
};

// ─── WS Disconnect Indicator ───
function showDisconnectIndicator(show) {
  document.querySelectorAll('.term-disconnect').forEach(el => el.remove());
  if (show) {
    document.querySelectorAll('.split-leaf').forEach(leaf => {
      const ind = document.createElement('div');
      ind.className = 'term-disconnect';
      ind.textContent = 'Disconnected';
      leaf.appendChild(ind);
    });
  }
}

// ─── Terminal Font Settings ───
let termFontSize = parseInt(localStorage.getItem('dl-term-font-size') || '13');
window.changeTermFontSize = (delta) => {
  termFontSize = Math.max(8, Math.min(24, termFontSize + delta));
  localStorage.setItem('dl-term-font-size', termFontSize);
  const el = document.getElementById('term-font-size');
  if (el) el.textContent = termFontSize;
  for (const [, t] of termMap) {
    t.xterm.options.fontSize = termFontSize;
    t.fitAddon.fit();
  }
};

// ─── Git History Viewer ───
window.showGitLog = async (projectId) => {
  const dlg = document.getElementById('git-log-dialog');
  const content = document.getElementById('git-log-content');
  const project = projectList.find(p => p.id === projectId);
  document.getElementById('git-log-title').textContent = `Git History \u2014 ${project?.name || projectId}`;
  content.innerHTML = '<div style="padding:14px;color:var(--text-3)">Loading\u2026</div>';
  dlg.showModal();
  try {
    const res = await fetch(`/api/projects/${projectId}/git/log?limit=50`);
    const data = await res.json();
    if (!data.commits?.length) { content.innerHTML = '<div style="padding:14px;color:var(--text-3)">No commits found</div>'; return; }
    content.innerHTML = data.commits.map(c =>
      `<div class="git-log-item">
        <span class="git-log-hash">${esc(c.short)}</span>
        <span class="git-log-msg" title="${esc(c.message)}">${esc(c.message)}</span>
        <span class="git-log-author">${esc(c.author)}</span>
        <span class="git-log-time">${esc(c.ago)}</span>
      </div>`
    ).join('');
  } catch { content.innerHTML = '<div style="padding:14px;color:var(--red)">Error loading git log</div>'; }
};

// ─── Session History (enhanced) ───
window.showSessionHistory = async (projectId) => {
  const dlg = document.getElementById('session-dialog');
  const content = document.getElementById('session-dialog-content');
  const project = projectList.find(p => p.id === projectId);
  document.getElementById('session-dialog-title').textContent = `Sessions \u2014 ${project?.name || projectId}`;
  content.innerHTML = '<div style="color:var(--text-3)">Loading\u2026</div>';
  dlg.showModal();
  try {
    const res = await fetch(`/api/projects/${projectId}/sessions`);
    const sessions = await res.json();
    if (!sessions?.length) { content.innerHTML = '<div style="color:var(--text-3)">No sessions found</div>'; return; }
    content.innerHTML = sessions.slice(0, 30).map(s => {
      const model = (s.model || '?').replace('claude-', '').replace(/-\d{8}$/, '');
      const ago = s.lastModified ? timeAgo(s.lastModified) : '?';
      const size = s.sizeKB ? `${s.sizeKB} KB` : '';
      return `<div class="session-item" style="cursor:pointer" onclick="resumeSessionFromHistory('${esc(projectId)}','${esc(s.sessionId)}')" title="Click to resume">
        <span class="si-status" style="background:var(--text-3)"></span>
        <span class="si-model">${model}</span>
        <span class="si-time">${ago} ago</span>
        <span class="si-tokens">${size}</span>
        <span class="si-id">${(s.sessionId || '').slice(-8)}</span>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--text-3)" stroke-width="2" style="flex-shrink:0;margin-left:4px"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      </div>`;
    }).join('');
  } catch { content.innerHTML = '<div style="color:var(--red)">Error loading sessions</div>'; }
};

window.resumeSessionFromHistory = async (projectId, sessionId) => {
  document.getElementById('session-dialog').close();
  try {
    await fetch(`/api/sessions/${projectId}/resume`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ sessionId }) });
    showToast('Resuming session...', 'info');
  } catch (err) { showToast('Resume failed: ' + err.message, 'error'); }
};

// ─── Settings Export/Import ───
window.exportSettings = async () => {
  try {
    const res = await fetch('/api/settings/export');
    const data = await res.json();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'cockpit-projects.json'; a.click();
    URL.revokeObjectURL(url);
    showToast('Settings exported', 'success');
  } catch (err) { showToast('Export failed: ' + err.message, 'error'); }
};

window.importSettings = async (input) => {
  const file = input.files?.[0];
  if (!file) return;
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    const res = await fetch('/api/settings/import', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
    const result = await res.json();
    if (result.error) showToast('Import failed: ' + result.error, 'error');
    else { showToast(`Imported ${result.imported} projects`, 'success'); location.reload(); }
  } catch (err) { showToast('Import failed: ' + err.message, 'error'); }
  input.value = '';
};

// ─── Discover Projects ───
let _discoverData = [];
let _discoverSelected = new Set();

window.openDiscoverModal = async () => {
  const dialog = document.getElementById('discover-dialog');
  const body = document.getElementById('discover-body');
  const footer = document.getElementById('discover-footer');
  _discoverData = [];
  _discoverSelected.clear();
  body.innerHTML = '<div class="discover-loading">Scanning Claude projects</div>';
  footer.style.display = 'none';
  dialog.showModal();

  try {
    const res = await fetch('/api/discover-projects');
    _discoverData = await res.json();
    renderDiscoverList();
  } catch (err) {
    body.innerHTML = `<div class="discover-empty">Failed to scan: ${err.message}</div>`;
  }
};

function renderDiscoverList() {
  const body = document.getElementById('discover-body');
  const footer = document.getElementById('discover-footer');

  if (_discoverData.length === 0) {
    body.innerHTML = '<div class="discover-empty">No new projects found.<br><span style="font-size:.78rem;color:var(--text-3)">All Claude Code projects are already added.</span></div>';
    footer.style.display = 'none';
    return;
  }

  footer.style.display = '';
  const allSelected = _discoverSelected.size === _discoverData.length;
  let html = `<div class="discover-header">
    <span class="discover-count">${_discoverData.length} project${_discoverData.length > 1 ? 's' : ''} found</span>
    <button class="discover-select-all" onclick="toggleDiscoverSelectAll()">${allSelected ? 'Deselect All' : 'Select All'}</button>
  </div><div class="discover-list">`;

  for (let i = 0; i < _discoverData.length; i++) {
    const p = _discoverData[i];
    const sel = _discoverSelected.has(i) ? ' selected' : '';
    const gitBadge = p.hasGit
      ? '<span class="discover-badge git">git</span>'
      : '<span class="discover-badge no-git">no git</span>';
    const sessions = p.sessionCount ? `${p.sessionCount} session${p.sessionCount > 1 ? 's' : ''}` : '';
    const activity = p.lastActivity ? timeAgo(new Date(p.lastActivity)) : '';
    const meta = [sessions, activity].filter(Boolean).join(' · ');

    html += `<div class="discover-item${sel}" onclick="toggleDiscoverItem(${i})">
      <div class="discover-check"></div>
      <div class="discover-info">
        <div class="discover-name">${esc(p.name)} ${gitBadge}</div>
        <div class="discover-path">${esc(p.path)}</div>
        ${meta ? `<div class="discover-meta">${meta}</div>` : ''}
      </div>
    </div>`;
  }

  html += '</div>';
  body.innerHTML = html;
  updateDiscoverBtn();
}

window.toggleDiscoverItem = (idx) => {
  if (_discoverSelected.has(idx)) _discoverSelected.delete(idx);
  else _discoverSelected.add(idx);
  renderDiscoverList();
};

window.toggleDiscoverSelectAll = () => {
  if (_discoverSelected.size === _discoverData.length) {
    _discoverSelected.clear();
  } else {
    for (let i = 0; i < _discoverData.length; i++) _discoverSelected.add(i);
  }
  renderDiscoverList();
};

function updateDiscoverBtn() {
  const btn = document.getElementById('discover-add-btn');
  if (btn) btn.textContent = `Add Selected (${_discoverSelected.size})`;
}

window.addDiscoveredProjects = async () => {
  if (_discoverSelected.size === 0) { showToast('Select at least one project', 'warn'); return; }
  const projects = [..._discoverSelected].map(i => _discoverData[i]).map(p => ({ name: p.name, path: p.path }));
  try {
    const res = await fetch('/api/discover-projects/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ projects })
    });
    const result = await res.json();
    if (result.error) { showToast('Failed: ' + result.error, 'error'); return; }
    showToast(`Added ${result.added} project${result.added > 1 ? 's' : ''}`, 'success');
    document.getElementById('discover-dialog').close();
    location.reload();
  } catch (err) { showToast('Failed: ' + err.message, 'error'); }
};

// ─── Error Log Viewer ───
const _errorLog = [];
const _origConsoleError = console.error;
console.error = (...args) => {
  _origConsoleError.apply(console, args);
  _errorLog.push({ time: new Date().toISOString(), message: args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ') });
  if (_errorLog.length > 200) _errorLog.shift();
  const btn = document.getElementById('error-log-btn');
  if (btn) btn.style.display = '';
};
window.addEventListener('error', (e) => {
  _errorLog.push({ time: new Date().toISOString(), message: `${e.message} at ${e.filename}:${e.lineno}` });
  if (_errorLog.length > 200) _errorLog.shift();
  const btn = document.getElementById('error-log-btn');
  if (btn) btn.style.display = '';
});
window.addEventListener('unhandledrejection', (e) => {
  _errorLog.push({ time: new Date().toISOString(), message: `Unhandled rejection: ${e.reason}` });
  if (_errorLog.length > 200) _errorLog.shift();
  const btn = document.getElementById('error-log-btn');
  if (btn) btn.style.display = '';
});

window.openErrorLog = () => {
  const dlg = document.getElementById('error-log-dialog');
  const content = document.getElementById('error-log-content');
  if (!_errorLog.length) {
    content.innerHTML = '<div class="error-log-empty">No errors logged</div>';
  } else {
    content.innerHTML = [..._errorLog].reverse().map(e => {
      const t = new Date(e.time).toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
      return `<div class="error-log-item"><span class="el-time">${t}</span><span class="el-msg">${esc(e.message)}</span></div>`;
    }).join('');
  }
  dlg.showModal();
};

window.clearErrorLog = () => {
  _errorLog.length = 0;
  document.getElementById('error-log-content').innerHTML = '<div class="error-log-empty">No errors logged</div>';
  const btn = document.getElementById('error-log-btn');
  if (btn) btn.style.display = 'none';
  showToast('Error log cleared', 'info');
};

// ─── Notification Filtering (per-project) ───
let _notifFilter = JSON.parse(localStorage.getItem('dl-notif-filter') || '{}');

function isNotifEnabledForProject(projectId) {
  return _notifFilter[projectId] !== false;
}

function saveNotifFilter() {
  localStorage.setItem('dl-notif-filter', JSON.stringify(_notifFilter));
}

window.toggleProjectNotif = (projectId) => {
  _notifFilter[projectId] = !isNotifEnabledForProject(projectId);
  saveNotifFilter();
  renderNotifFilterList();
};

window.openNotifSettings = () => {
  renderNotifFilterList();
  document.getElementById('notif-settings-dialog').showModal();
};

function renderNotifFilterList() {
  const el = document.getElementById('notif-filter-list');
  if (!el) return;
  el.innerHTML = projectList.map(p => {
    const enabled = isNotifEnabledForProject(p.id);
    return `<div class="notif-filter-row">
      <span class="nf-dot" style="background:${p.color}"></span>
      <span class="nf-name">${esc(p.name)}</span>
      <button class="notif-toggle ${enabled ? 'on' : ''}" onclick="toggleProjectNotif('${esc(p.id)}')" title="${enabled ? 'Disable' : 'Enable'} notifications"></button>
    </div>`;
  }).join('');
}

// ─── Init ───
async function init() {
  // Apply saved theme
  applyTheme(currentTheme);
  renderSkeletons(6);
  const res = await fetch('/api/projects');
  projectList = await res.json();
  // Sort pinned to front
  if (pinnedProjects.size > 0) {
    projectList.sort((a, b) => {
      const ap = pinnedProjects.has(a.id) ? 0 : 1;
      const bp = pinnedProjects.has(b.id) ? 0 : 1;
      return ap - bp;
    });
  }
  renderAllCards(projectList);
  projectList.forEach(p => { state.projects.set(p.id,{session:p.session,git:p.git,prs:p.prs}); renderCard(p.id); });
  populateProjectSelects();
  updateSummaryStats();
  try { await fetch('/api/stats').then(r=>r.json()); } catch{}
  connectSSE();
  connectWS();
  renderReadme();
  // Scroll indicators
  const pgrid = document.getElementById('project-grid');
  if (pgrid) { pgrid.addEventListener('scroll', updateScrollIndicators); }
  window.addEventListener('resize', updateScrollIndicators);
  updateScrollIndicators();
  // Restore notify toggle state
  const nb = document.getElementById('notify-toggle');
  if (nb) { nb.textContent = notifyEnabled ? 'On' : 'Off'; nb.className = 'btn' + (notifyEnabled ? '' : ' off-btn'); }
  // Restore chart period
  if (chartPeriod !== 30) setChartPeriod(chartPeriod);
  // Restore terminal font size display
  const fse = document.getElementById('term-font-size');
  if (fse) fse.textContent = termFontSize;
  const savedView = localStorage.getItem('dl-view');
  if(savedView && savedView !== 'dashboard') switchView(savedView);
}
init();
</script>

<!-- Keyboard Shortcut Overlay -->
<div class="shortcut-overlay hidden" id="shortcut-overlay" onclick="if(event.target===this)hideShortcutHelp()">
  <div class="shortcut-card">
    <h2>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M7 16h10"/></svg>
      Keyboard Shortcuts
    </h2>
    <table>
      <tr class="sc-section"><td colspan="2">Navigation</td></tr>
      <tr><td>Ctrl + 1</td><td>Overview</td></tr>
      <tr><td>Ctrl + 2</td><td>Terminal</td></tr>
      <tr><td>Ctrl + 3</td><td>Changes</td></tr>
      <tr><td>Ctrl + 4</td><td>README</td></tr>
      <tr class="sc-section"><td colspan="2">Terminal</td></tr>
      <tr><td>Ctrl + T</td><td>New terminal</td></tr>
      <tr><td>Ctrl + W</td><td>Close terminal</td></tr>
      <tr><td>Ctrl + F</td><td>Search in terminal</td></tr>
      <tr><td>Ctrl + Tab</td><td>Next terminal</td></tr>
      <tr><td>Ctrl + Shift + Tab</td><td>Previous terminal</td></tr>
      <tr class="sc-section"><td colspan="2">Changes</td></tr>
      <tr><td>E</td><td>Expand all diffs</td></tr>
      <tr><td>C</td><td>Collapse all diffs</td></tr>
      <tr class="sc-section"><td colspan="2">General</td></tr>
      <tr><td>?</td><td>Show this help</td></tr>
      <tr><td>Escape</td><td>Close overlay / search</td></tr>
    </table>
  </div>
</div>

</body>
</html>
