name: Claude PR Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-review:
    # PR 코멘트에 @claude 멘션이 있을 때만 실행
    if: |
      (github.event.issue.pull_request || github.event.pull_request) &&
      contains(github.event.comment.body, '@claude')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          # Max 플랜 OAuth 토큰 (API 키 불필요)
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # 토큰 자동 갱신용 (선택사항이지만 권장)
          secrets_admin_pat: ${{ secrets.SECRETS_ADMIN_PAT }}

          # PR 컨텍스트 전달
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # 커스텀 프롬프트 (orchestrate Phase 5 실행)
          custom_instructions: |
            You are assisting with PR review feedback.

            The user mentioned you in a PR comment. Read the PR comments and:
            1. Identify requested changes
            2. Navigate to the worktree directory (check .orchestrate/*.json for the path)
            3. Apply the requested changes
            4. Run: pnpm lint --fix && pnpm build && pnpm test
            5. If all pass, commit and push the changes
            6. Reply to the PR comment confirming what was fixed

            If the PR is merged, automatically run Phase 6 cleanup:
            - Run the cleanup script
            - Delete worktree and branch
            - Update Jira status to Done (if applicable)

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number || context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: '❌ Claude Code 실행 중 오류가 발생했습니다. 로그를 확인해주세요.'
            });
